<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#050818" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <title>Plex Donate Dashboard</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(
            120% 120% at 50% -10%,
            rgba(99, 102, 241, 0.35) 0%,
            rgba(15, 23, 42, 0.92) 45%,
            #050818 100%
          ),
          radial-gradient(80% 80% at 80% 20%, rgba(14, 165, 233, 0.18), transparent);
        color: #e2e8f0;
        display: flex;
        justify-content: center;
        padding: 32px 16px 64px;
        position: relative;
      }
      body::after {
        content: '';
        position: fixed;
        inset: 0;
        background: radial-gradient(
          60% 60% at 20% 20%,
          rgba(76, 29, 149, 0.18),
          transparent 70%
        );
        pointer-events: none;
        z-index: 0;
      }
      a {
        color: inherit;
      }
      h1,
      h2,
      h3 {
        margin: 0;
      }
      h1 {
        font-size: clamp(2.2rem, 4vw, 3rem);
        line-height: 1.1;
        background: linear-gradient(135deg, #c7d2fe 0%, #a855f7 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      h2 {
        font-size: clamp(1.4rem, 2vw, 1.8rem);
        line-height: 1.3;
      }
      p {
        margin: 0;
        line-height: 1.6;
      }
      .hidden {
        display: none !important;
      }
      .panel {
        width: min(780px, 100%);
        background: rgba(15, 23, 42, 0.82);
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 20px;
        padding: 28px;
        text-align: center;
        box-shadow: 0 25px 60px -25px rgba(30, 64, 175, 0.6);
        position: relative;
        z-index: 1;
      }
      .panel.error {
        background: rgba(76, 29, 149, 0.18);
        border-color: rgba(248, 113, 113, 0.4);
        color: #fecdd3;
      }
      #app {
        width: min(960px, 100%);
        position: relative;
        z-index: 1;
      }
      .canvas {
        display: grid;
        gap: 28px;
      }
      .surface {
        background: rgba(15, 23, 42, 0.76);
        border: 1px solid rgba(148, 163, 184, 0.22);
        border-radius: 24px;
        padding: clamp(24px, 4vw, 36px);
        box-shadow: 0 30px 60px -28px rgba(37, 99, 235, 0.55);
        backdrop-filter: blur(18px);
      }
      .hero {
        position: relative;
        overflow: hidden;
        display: grid;
        gap: 16px;
        text-align: center;
      }
      .hero::after {
        content: '';
        position: absolute;
        inset: -40% 40% auto -30%;
        height: 120%;
        transform: rotate(18deg);
        background: radial-gradient(
          60% 60% at 50% 50%,
          rgba(59, 130, 246, 0.3),
          transparent 70%
        );
        z-index: 0;
      }
      .hero > * {
        position: relative;
        z-index: 1;
      }
      .eyebrow {
        letter-spacing: 0.2em;
        text-transform: uppercase;
        font-size: 0.75rem;
        color: rgba(165, 180, 252, 0.9);
      }
      .muted {
        color: rgba(203, 213, 225, 0.8);
      }
      .small {
        font-size: 0.85rem;
      }
      .status-text {
        font-size: 0.9rem;
        margin-top: 12px;
        color: rgba(165, 180, 252, 0.9);
      }
      .status-text.error {
        color: #fca5a5;
      }
      .status-text.success {
        color: #bbf7d0;
      }
      .status-text.info {
        color: #c7d2fe;
      }
      .link-inline {
        color: #c7d2fe;
        text-decoration: underline;
        font-weight: 600;
        cursor: pointer;
      }
      .link-inline:hover {
        text-decoration: none;
      }
      .login-footnote {
        margin: -6px 0 0;
      }
      .helper-text {
        color: rgba(203, 213, 225, 0.8);
        font-size: 0.9rem;
      }
      form {
        display: grid;
        gap: 16px;
        margin-top: 20px;
        text-align: left;
      }
      label {
        display: grid;
        gap: 8px;
        font-weight: 600;
        color: #cbd5f5;
      }
      input {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid rgba(129, 140, 248, 0.4);
        background: rgba(15, 23, 42, 0.7);
        color: inherit;
        font-size: 1rem;
      }
      input:focus {
        outline: 2px solid rgba(129, 140, 248, 0.8);
        outline-offset: 2px;
      }
      button {
        appearance: none;
        border: none;
        border-radius: 999px;
        padding: 12px 22px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      button:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }
      .button-primary {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: #ffffff;
        box-shadow: 0 12px 30px -12px rgba(79, 70, 229, 0.65);
      }
      .button-secondary {
        background: rgba(148, 163, 184, 0.2);
        color: #e2e8f0;
        border: 1px solid rgba(148, 163, 184, 0.4);
      }
      .header-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        align-items: center;
      }
      .grid {
        display: grid;
        gap: 24px;
      }
      @media (min-width: 900px) {
        .grid-columns-2 {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      .profile-summary {
        display: flex;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
        align-items: center;
      }
      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 999px;
        font-size: 0.82rem;
        font-weight: 600;
        background: rgba(59, 130, 246, 0.24);
        color: #bfdbfe;
        text-transform: capitalize;
      }
      .status-pill[data-status='active'] {
        background: rgba(34, 197, 94, 0.22);
        color: #bbf7d0;
      }
      .status-pill[data-status='cancelled'],
      .status-pill[data-status='suspended'],
      .status-pill[data-status='expired'] {
        background: rgba(248, 113, 113, 0.24);
        color: #fecdd3;
      }
      .detail-list {
        display: grid;
        gap: 12px;
        margin-top: 20px;
      }
      .detail {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        font-size: 0.95rem;
      }
      .detail .label {
        color: rgba(148, 163, 184, 0.9);
        font-weight: 600;
      }
      .invite-ready {
        margin-top: 24px;
        border-radius: 18px;
        border: 1px solid rgba(129, 140, 248, 0.4);
        padding: 18px;
        background: rgba(79, 70, 229, 0.15);
        text-align: left;
        display: grid;
        gap: 12px;
      }
      .invite-link {
        word-break: break-all;
        color: #c7d2fe;
        text-decoration: underline;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 999px;
        font-weight: 600;
        font-size: 0.8rem;
      }
      .badge.success {
        background: rgba(34, 197, 94, 0.28);
        color: #bbf7d0;
      }
      .login-card {
        display: grid;
        gap: 16px;
        text-align: left;
      }
      .cta-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }
      .subscription-cta {
        margin-top: 18px;
        display: grid;
        gap: 8px;
        justify-items: start;
      }
      .subscription-cta .button-primary {
        text-decoration: none;
        text-align: center;
      }
      .onboarding {
        display: grid;
        gap: 20px;
        text-align: left;
      }
      .steps {
        display: grid;
        gap: 16px;
      }
      .step {
        border: 1px solid rgba(148, 163, 184, 0.28);
        border-radius: 20px;
        padding: 18px 20px;
        background: rgba(15, 23, 42, 0.66);
        transition: border-color 0.2s ease, box-shadow 0.2s ease,
          background 0.2s ease, transform 0.2s ease;
      }
      .step-header {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .step-header > div {
        display: grid;
        gap: 6px;
      }
      .step-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 999px;
        background: rgba(99, 102, 241, 0.25);
        color: #c7d2fe;
        font-weight: 700;
        font-size: 1.1rem;
        flex-shrink: 0;
      }
      .step-title {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
      }
      .step-footnote {
        margin-top: 12px;
      }
      .step[data-state='complete'] {
        border-color: rgba(34, 197, 94, 0.45);
        background: rgba(21, 128, 61, 0.18);
      }
      .step[data-state='complete'] .step-number {
        background: rgba(34, 197, 94, 0.35);
        color: #bbf7d0;
      }
      .step[data-state='current'] {
        border-color: rgba(129, 140, 248, 0.8);
        background: rgba(79, 70, 229, 0.2);
        box-shadow: 0 18px 40px -28px rgba(99, 102, 241, 0.9);
        transform: translateY(-2px);
      }
      .step[data-state='current'] .step-number {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: #ffffff;
      }
      .step[data-state='upcoming'] {
        opacity: 0.92;
      }
      .step[data-state='upcoming'] .step-number {
        background: rgba(100, 116, 139, 0.25);
        color: rgba(203, 213, 225, 0.8);
      }
      .password-guidance {
        margin-top: -4px;
      }
      .section-title {
        font-size: 1.2rem;
        font-weight: 600;
      }
      ul {
        margin: 0;
        padding-left: 20px;
        display: grid;
        gap: 8px;
      }
    </style>
  </head>
  <body>
    <div id="loading" class="panel">Loading your dashboard…</div>
    <div id="error-panel" class="panel error hidden"></div>
    <div id="app" class="hidden">
      <main class="canvas">
        <section class="surface hero">
          <span class="eyebrow">Plex Donate</span>
          <h1>You're just steps away from endless Plex adventures</h1>
          <p class="muted">
            Signed up through one of our share links? Use the account you
            created there to manage invites, keep your details current, and
            jump back into your libraries anytime. Not subscribed yet? Follow
            the guided checklist below to unlock access to endless content.
          </p>
        </section>

        <section id="login-panel" class="surface login-card">
          <div>
            <span class="section-title">Customer sign-in</span>
            <p class="muted small">
              Use the same credentials you saved on the invite page. If you're
              just getting started, head back to your share link to complete
              step one.
            </p>
          </div>
          <form id="login-form">
            <label>
              <span>Email on file</span>
              <input
                id="login-email"
                type="email"
                placeholder="you@example.com"
                autocomplete="email"
                required
              />
            </label>
            <label>
              <span>Password</span>
              <input
                id="login-password"
                type="password"
                placeholder="••••••••"
                autocomplete="current-password"
                required
              />
            </label>
            <div class="cta-actions">
              <button id="login-button" type="submit" class="button-primary">
                Sign in
              </button>
              <p id="login-status" class="status-text"></p>
            </div>
          </form>
          <p class="muted small login-footnote">
            <a
              id="forgot-password-link"
              class="link-inline"
              href="#"
              aria-controls="forgot-password-help"
              aria-expanded="false"
              >Forgot your password?</a
            >
          </p>
          <p id="forgot-password-help" class="muted small hidden helper-text">
            Donor accounts can request a fresh invite email from your share link
            to set a new password. Need a hand? Reach out to the server admin
            and they'll help you get back to streaming in no time.
          </p>
        </section>

        <section id="dashboard-panel" class="grid hidden">
          <article class="surface">
            <div class="profile-summary">
              <div>
                <h2 class="section-title">Your membership</h2>
                <p id="member-name" class="muted"></p>
                <p id="member-email" class="muted"></p>
              </div>
              <div class="header-actions">
                <span
                  id="member-status"
                  class="status-pill"
                  data-status="pending"
                  >pending</span
                >
                <button
                  id="change-password-button"
                  class="button-secondary"
                  type="button"
                >
                  Change password
                </button>
                <button id="logout-button" class="button-secondary" type="button">
                  Sign out
                </button>
              </div>
            </div>
            <div class="detail-list">
              <div id="member-plan" class="detail hidden"></div>
              <div id="member-subscription-row" class="detail hidden">
                <span class="label">Subscription ID</span>
                <span id="member-subscription-id"></span>
              </div>
              <div id="member-last-payment-row" class="detail hidden">
                <span class="label">Last payment</span>
                <span id="member-last-payment"></span>
              </div>
            </div>
            <p
              id="member-status-message"
              class="status-text small"
              aria-live="polite"
            ></p>
            <div id="subscription-cta" class="subscription-cta hidden">
              <button id="subscription-button" class="button-primary" type="button">
                Start PayPal subscription
              </button>
              <p id="subscription-note" class="status-text small">
                Opens PayPal checkout in a new tab.
              </p>
            </div>
          </article>

          <article id="onboarding-panel" class="surface onboarding hidden">
            <h2 class="section-title">Unlock endless content in three steps</h2>
            <p class="muted">
              You're only moments away from streaming everything you love.
              Follow the guided path below to complete your setup.
            </p>
            <div class="steps">
              <div id="step-subscription" class="step" data-state="current">
                <div class="step-header">
                  <span class="step-number" data-step-number="1">1</span>
                  <div>
                    <h3 class="step-title">Start your support subscription</h3>
                    <p id="step-subscription-note" class="muted small">
                      Use the PayPal button above to kick off your membership.
                    </p>
                  </div>
                </div>
                <p class="step-footnote muted small">
                  Supporting the server keeps the library growing for everyone.
                </p>
              </div>
              <div id="step-plex" class="step" data-state="upcoming">
                <div class="step-header">
                  <span class="step-number" data-step-number="2">2</span>
                  <div>
                    <h3 class="step-title">Authenticate with Plex</h3>
                    <p id="step-plex-note" class="muted small">
                      We'll prompt you to link your Plex account once your
                      subscription is confirmed.
                    </p>
                  </div>
                </div>
              </div>
              <div id="step-invite" class="step" data-state="upcoming">
                <div class="step-header">
                  <span class="step-number" data-step-number="3">3</span>
                  <div>
                    <h3 class="step-title">Send yourself a Plex invite</h3>
                    <p id="step-invite-note" class="muted small">
                      Generate your personal Wizarr invite and unlock instant
                      access to endless content.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </article>

          <article class="surface">
            <h2 class="section-title">Update your profile</h2>
            <p class="muted">
              Keep your preferred streaming email and display name current so we
              can reach you when new invites are generated.
            </p>
            <form id="profile-form">
              <label>
                <span>Streaming email</span>
                <input
                  id="profile-email"
                  type="email"
                  placeholder="you@example.com"
                  autocomplete="email"
                  required
                />
              </label>
              <label>
                <span>Display name</span>
                <input
                  id="profile-name"
                  type="text"
                  placeholder="How should we greet you?"
                  autocomplete="name"
                />
              </label>
              <div class="cta-actions">
                <button id="profile-save" type="submit" class="button-primary">
                  Save changes
                </button>
                <p id="profile-status" class="status-text"></p>
              </div>
            </form>
          </article>

          <article id="password-panel" class="surface">
            <h2 class="section-title">Password &amp; security</h2>
            <p id="password-guidance" class="muted small password-guidance">
              Update your dashboard password to keep your account secure.
            </p>
            <form id="password-form">
              <label id="password-current-row">
                <span>Current password</span>
                <input
                  id="password-current"
                  type="password"
                  placeholder="••••••••"
                  autocomplete="current-password"
                />
              </label>
              <label>
                <span>New password</span>
                <input
                  id="password-new"
                  type="password"
                  placeholder="Choose something memorable"
                  autocomplete="new-password"
                  required
                />
              </label>
              <label>
                <span>Confirm new password</span>
                <input
                  id="password-confirm"
                  type="password"
                  placeholder="Repeat your new password"
                  autocomplete="new-password"
                />
              </label>
              <div class="cta-actions">
                <button id="password-save" type="submit" class="button-primary">
                  Update password
                </button>
                <p id="password-status" class="status-text"></p>
              </div>
            </form>
          </article>

          <article class="surface">
            <h2 class="section-title">Your invite link</h2>
            <p class="muted" id="invite-description">
              Generate your Wizarr invite once and keep the link handy for
              future devices.
            </p>
            <form id="invite-form">
              <label>
                <span>Email for this invite</span>
                <input
                  id="invite-email"
                  type="email"
                  placeholder="you@example.com"
                  autocomplete="email"
                  required
                />
              </label>
              <label>
                <span>Optional note</span>
                <input
                  id="invite-note"
                  type="text"
                  placeholder="Used for tracking invites"
                />
              </label>
              <div class="cta-actions">
                <button id="invite-submit" type="submit" class="button-primary">
                  Generate invite
                </button>
                <p id="invite-status" class="status-text"></p>
              </div>
            </form>
            <div id="invite-ready" class="invite-ready hidden">
              <span class="badge success">Invite ready</span>
              <a id="invite-link" class="invite-link" href="#" target="_blank" rel="noopener"></a>
              <p id="invite-email-display" class="muted small"></p>
              <p id="invite-created" class="muted small"></p>
            </div>
          </article>

          <article class="surface">
            <h2 class="section-title">Streaming libraries</h2>
            <p class="muted">
              Jump into your Plex library once your invite is active. Save the
              link below for quick access.
            </p>
            <ul>
              <li>
                <a href="https://app.plex.tv/" target="_blank" rel="noopener"
                  >Launch Plex</a
                >
              </li>
              <li class="muted small">
                Need a personal invite link? Contact the server admin for a
                share URL.
              </li>
            </ul>
          </article>
        </section>
      </main>
    </div>

    <script>
      const state = {
        data: null,
      };

      const loadingPanel = document.getElementById('loading');
      const errorPanel = document.getElementById('error-panel');
      const app = document.getElementById('app');
      const loginPanel = document.getElementById('login-panel');
      const dashboardPanel = document.getElementById('dashboard-panel');

      const loginForm = document.getElementById('login-form');
      const loginButton = document.getElementById('login-button');
      const loginStatus = document.getElementById('login-status');
      const loginPassword = document.getElementById('login-password');
      const loginEmail = document.getElementById('login-email');
      const forgotPasswordLink = document.getElementById('forgot-password-link');
      const forgotPasswordHelp = document.getElementById('forgot-password-help');
      const defaultForgotPasswordLinkText = forgotPasswordLink
        ? forgotPasswordLink.textContent
        : 'Forgot your password?';

      const logoutButton = document.getElementById('logout-button');
      const memberNameEl = document.getElementById('member-name');
      const memberEmailEl = document.getElementById('member-email');
      const memberStatusEl = document.getElementById('member-status');
      const memberPlanEl = document.getElementById('member-plan');
      const memberSubscriptionRow = document.getElementById('member-subscription-row');
      const memberSubscriptionId = document.getElementById('member-subscription-id');
      const memberLastPaymentRow = document.getElementById('member-last-payment-row');
      const memberLastPayment = document.getElementById('member-last-payment');
      const subscriptionCta = document.getElementById('subscription-cta');
      const subscriptionButton = document.getElementById('subscription-button');
      const subscriptionNote = document.getElementById('subscription-note');
      const memberStatusMessage = document.getElementById('member-status-message');
      const changePasswordButton = document.getElementById('change-password-button');
      const onboardingPanel = document.getElementById('onboarding-panel');
      const stepSubscription = document.getElementById('step-subscription');
      const stepPlex = document.getElementById('step-plex');
      const stepInvite = document.getElementById('step-invite');
      const stepSubscriptionNote = document.getElementById('step-subscription-note');
      const stepPlexNote = document.getElementById('step-plex-note');
      const stepInviteNote = document.getElementById('step-invite-note');
      const defaultSubscriptionButtonLabel = subscriptionButton
        ? subscriptionButton.textContent
        : 'Start PayPal subscription';
      if (subscriptionButton) {
        subscriptionButton.disabled = true;
        subscriptionButton.dataset.available = 'false';
      }

      const SESSION_TOKEN_QUERY_PARAM = 'session';
      let sessionToken = null;

      function normalizeSessionToken(token) {
        if (typeof token !== 'string') {
          return null;
        }
        const trimmed = token.trim();
        return trimmed ? trimmed : null;
      }

      function applySessionTokenToUrl(token) {
        try {
          const url = new URL(window.location.href);
          if (token) {
            url.searchParams.set(SESSION_TOKEN_QUERY_PARAM, token);
          } else {
            url.searchParams.delete(SESSION_TOKEN_QUERY_PARAM);
          }
          const nextUrl = `${url.pathname}${url.search}${url.hash}`;
          window.history.replaceState({}, '', nextUrl);
        } catch (err) {
          // Ignore URL manipulation errors.
        }
      }

      function setSessionToken(token) {
        const normalized = normalizeSessionToken(token);
        if (normalized === sessionToken) {
          return;
        }
        sessionToken = normalized;
        applySessionTokenToUrl(sessionToken);
      }

      (function initializeSessionTokenFromUrl() {
        try {
          const url = new URL(window.location.href);
          const existing = url.searchParams.get(SESSION_TOKEN_QUERY_PARAM);
          if (existing) {
            setSessionToken(existing);
          }
        } catch (err) {
          sessionToken = null;
        }
      })();

      function withSessionToken(path) {
        if (!sessionToken) {
          return path;
        }
        try {
          const url = new URL(path, window.location.origin);
          url.searchParams.set(SESSION_TOKEN_QUERY_PARAM, sessionToken);
          return url.toString();
        } catch (err) {
          return path;
        }
      }

      function updateSessionTokenFromResponse(data) {
        if (!data || typeof data !== 'object') {
          return;
        }
        if (Object.prototype.hasOwnProperty.call(data, 'sessionToken')) {
          setSessionToken(data.sessionToken);
        }
      }

      function buildSessionRequest(path, options = {}) {
        const requestUrl = withSessionToken(path);
        const requestOptions = { ...options };
        requestOptions.headers = options && options.headers
          ? { ...options.headers }
          : {};
        if (sessionToken) {
          requestOptions.headers['X-Session-Token'] = sessionToken;
        }
        return { requestUrl, requestOptions };
      }

      async function sessionFetch(path, options = {}) {
        const { requestUrl, requestOptions } = buildSessionRequest(path, options);
        return fetch(requestUrl, requestOptions);
      }

      const profileForm = document.getElementById('profile-form');
      const profileEmail = document.getElementById('profile-email');
      const profileName = document.getElementById('profile-name');
      const profileStatus = document.getElementById('profile-status');
      const profileSave = document.getElementById('profile-save');
      const passwordForm = document.getElementById('password-form');
      const passwordCurrentRow = document.getElementById('password-current-row');
      const passwordCurrent = document.getElementById('password-current');
      const passwordNew = document.getElementById('password-new');
      const passwordConfirm = document.getElementById('password-confirm');
      const passwordStatus = document.getElementById('password-status');
      const passwordSave = document.getElementById('password-save');
      const passwordGuidance = document.getElementById('password-guidance');
      const passwordPanel = document.getElementById('password-panel');

      const inviteForm = document.getElementById('invite-form');
      const inviteEmail = document.getElementById('invite-email');
      const inviteNote = document.getElementById('invite-note');
      const inviteStatus = document.getElementById('invite-status');
      const inviteSubmit = document.getElementById('invite-submit');
      const inviteReady = document.getElementById('invite-ready');
      const inviteLinkEl = document.getElementById('invite-link');
      const inviteEmailDisplay = document.getElementById('invite-email-display');
      const inviteCreated = document.getElementById('invite-created');
      const inviteDescription = document.getElementById('invite-description');

      function showLoading() {
        loadingPanel.classList.remove('hidden');
        errorPanel.classList.add('hidden');
        app.classList.add('hidden');
      }

      function showError(message) {
        loadingPanel.classList.add('hidden');
        errorPanel.textContent = message || 'Something went wrong.';
        errorPanel.classList.remove('hidden');
        app.classList.add('hidden');
      }

      function showApp() {
        loadingPanel.classList.add('hidden');
        errorPanel.classList.add('hidden');
        app.classList.remove('hidden');
      }

      function formatPrice(amount, currency) {
        if (!Number.isFinite(amount) || amount <= 0) {
          return '';
        }
        try {
          return new Intl.NumberFormat(undefined, {
            style: 'currency',
            currency: currency || 'USD',
            minimumFractionDigits: 2,
          }).format(amount);
        } catch (err) {
          return `${amount.toFixed(2)} ${currency || ''}`.trim();
        }
      }

      function formatDate(value) {
        if (!value) {
          return '';
        }
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return value;
        }
        return date.toLocaleString();
      }

      function setStatusText(el, message, statusClass) {
        if (!el) return;
        el.textContent = message || '';
        el.className = 'status-text';
        if (statusClass) {
          el.classList.add(statusClass);
        }
      }

      function updateMembershipStatusMessage(donor, { showSubscriptionCta }) {
        if (!memberStatusMessage) {
          return;
        }

        const normalizedStatus = (donor && donor.status
          ? donor.status
          : 'pending'
        ).toLowerCase();
        const lastPayment = donor && donor.lastPaymentAt ? formatDate(donor.lastPaymentAt) : '';

        let tone = 'info';
        let message = '';

        switch (normalizedStatus) {
          case 'active':
            tone = 'success';
            message = lastPayment
              ? `Your subscription is active. Last payment recorded ${lastPayment}.`
              : 'Your subscription is active and invites are unlocked.';
            break;
          case 'pending':
            tone = 'info';
            if (showSubscriptionCta) {
              message = 'Start your PayPal subscription to activate your membership.';
            } else if (donor && donor.subscriptionId) {
              message =
                'We are waiting for PayPal to confirm your first payment. Check PayPal for any required steps.';
            } else {
              message = 'Add a subscription using the button below to finish setting up your membership.';
            }
            break;
          case 'cancelled':
            tone = 'error';
            message =
              'Your PayPal subscription was canceled. Start a new subscription to regain access.';
            break;
          case 'suspended':
            tone = 'error';
            message =
              'Your PayPal subscription is suspended. Update your billing details in PayPal to resume access.';
            break;
          case 'expired':
            tone = 'error';
            message =
              'Your PayPal subscription expired. Start a new subscription to continue access.';
            break;
          case 'past_due':
            tone = 'error';
            message =
              'Your subscription payment is past due. Update your PayPal billing information to avoid interruptions.';
            break;
          default:
            tone = 'info';
            message =
              'Your subscription status is being updated. Contact the server admin if this looks wrong.';
            break;
        }

        setStatusText(memberStatusMessage, message, tone);
        memberStatusMessage.classList.add('small');
      }

      function renderInvite(invite, limitReached) {
        const limitHit = Boolean(limitReached);

        if (inviteStatus) {
          setStatusText(inviteStatus, '');
        }

        if (inviteForm) {
          if (limitHit) {
            inviteForm.classList.add('hidden');
          } else {
            inviteForm.classList.remove('hidden');
          }
        }

        if (!invite || !invite.wizarrInviteUrl) {
          inviteReady.classList.add('hidden');
          inviteLinkEl.removeAttribute('href');
          inviteLinkEl.textContent = '';
          inviteEmailDisplay.textContent = '';
          inviteCreated.textContent = '';
          inviteDescription.textContent = limitHit
            ? 'An invite has already been created for this subscription. Contact the server admin if you need it refreshed.'
            : 'Generate your Wizarr invite once and keep the link handy for future devices.';
          if (inviteSubmit) {
            inviteSubmit.textContent = limitHit
              ? 'Invite already created'
              : 'Generate invite';
            inviteSubmit.disabled = limitHit;
          }
          return;
        }

        inviteReady.classList.remove('hidden');
        inviteLinkEl.href = invite.wizarrInviteUrl;
        inviteLinkEl.textContent = invite.wizarrInviteUrl;
        inviteEmailDisplay.textContent = invite.recipientEmail
          ? `Delivering to ${invite.recipientEmail}`
          : '';
        inviteCreated.textContent = invite.createdAt
          ? `Created ${formatDate(invite.createdAt)}`
          : '';
        inviteDescription.textContent = limitHit
          ? 'Invite ready! Reach out to the server admin if you need the link refreshed.'
          : 'Invite ready! Use the link below whenever you set up a new device.';
        if (inviteSubmit) {
          inviteSubmit.textContent = limitHit
            ? 'Invite already created'
            : 'Generate another invite';
          inviteSubmit.disabled = limitHit;
        }
      }

      function setStepState(stepEl, state) {
        if (!stepEl) {
          return;
        }
        const allowed = new Set(['complete', 'current', 'upcoming']);
        const normalized = allowed.has(state) ? state : 'upcoming';
        stepEl.dataset.state = normalized;
        const numberEl = stepEl.querySelector('.step-number');
        if (numberEl && numberEl.dataset && numberEl.dataset.stepNumber) {
          if (normalized === 'complete') {
            numberEl.textContent = '✓';
          } else {
            numberEl.textContent = numberEl.dataset.stepNumber;
          }
        }
      }

      function updateOnboarding(data, { showSubscriptionCta } = {}) {
        if (!onboardingPanel) {
          return;
        }

        const donor = data && data.donor ? data.donor : null;
        const normalizedStatus = donor && donor.status
          ? donor.status.toLowerCase()
          : 'pending';
        const subscriptionComplete = normalizedStatus === 'active';
        const subscriptionStarted = Boolean(donor && donor.subscriptionId);
        const plexLinked = Boolean(donor && donor.plexLinked);
        const plexLinkPending = Boolean(
          data &&
            data.plexLink &&
            typeof data.plexLink.pending === 'boolean' &&
            data.plexLink.pending
        );
        const inviteReadyState = Boolean(
          data && data.invite && data.invite.wizarrInviteUrl
        );
        const inviteLimitReached = Boolean(data && data.inviteLimitReached);
        const allComplete = subscriptionComplete && plexLinked && inviteReadyState;

        if (allComplete) {
          onboardingPanel.classList.add('hidden');
          return;
        }

        onboardingPanel.classList.remove('hidden');

        const steps = [
          { el: stepSubscription, complete: subscriptionComplete },
          { el: stepPlex, complete: plexLinked },
          { el: stepInvite, complete: inviteReadyState },
        ];

        let currentAssigned = false;
        for (const step of steps) {
          if (!step.el) {
            continue;
          }
          if (step.complete) {
            setStepState(step.el, 'complete');
          } else if (!currentAssigned) {
            setStepState(step.el, 'current');
            currentAssigned = true;
          } else {
            setStepState(step.el, 'upcoming');
          }
        }

        if (stepSubscriptionNote) {
          if (!subscriptionStarted && showSubscriptionCta) {
            stepSubscriptionNote.textContent =
              'Use the PayPal button above to kick off your membership.';
          } else if (!subscriptionStarted && !showSubscriptionCta) {
            stepSubscriptionNote.textContent =
              'Subscription checkout is unavailable right now. Contact the server admin for help.';
          } else if (!subscriptionComplete) {
            stepSubscriptionNote.textContent =
              'We are waiting for PayPal to confirm your first payment. This usually takes just a moment.';
          } else {
            stepSubscriptionNote.textContent =
              'Subscription active! You are ready for the next step.';
          }
        }

        if (stepPlexNote) {
          if (!subscriptionComplete) {
            stepPlexNote.textContent =
              'We’ll unlock Plex linking after your subscription is confirmed.';
          } else if (plexLinked) {
            stepPlexNote.textContent =
              'Plex account verified—time to generate your invite!';
          } else if (plexLinkPending) {
            stepPlexNote.textContent =
              'Follow the Plex prompt you opened to finish authentication. This card updates automatically.';
          } else {
            stepPlexNote.textContent =
              'Watch for the Plex authentication prompt here once your access is approved.';
          }
        }

        if (stepInviteNote) {
          if (!subscriptionComplete) {
            stepInviteNote.textContent =
              'Invite generation unlocks after your subscription is active.';
          } else if (!plexLinked) {
            stepInviteNote.textContent =
              'Finish Plex authentication and we’ll enable invite generation.';
          } else if (!inviteReadyState) {
            stepInviteNote.textContent =
              'Use the form below to send the invite to your inbox as soon as you are verified.';
          } else if (inviteLimitReached) {
            stepInviteNote.textContent =
              'Your invite is ready below. Reach out to the server admin if you need it refreshed.';
          } else {
            stepInviteNote.textContent =
              'Invite ready! Grab it below whenever you set up a new device.';
          }
        }
      }

      function renderDashboard(data) {
        state.data = data;
        showApp();

        if (!data || !data.authenticated) {
          loginPanel.classList.remove('hidden');
          dashboardPanel.classList.add('hidden');
          loginForm.reset();
          setStatusText(loginStatus, '');
          setStatusText(memberStatusMessage, '');
          if (forgotPasswordHelp) {
            forgotPasswordHelp.classList.add('hidden');
          }
          if (forgotPasswordLink) {
            forgotPasswordLink.textContent = defaultForgotPasswordLinkText;
            forgotPasswordLink.setAttribute('aria-expanded', 'false');
          }
          if (onboardingPanel) {
            onboardingPanel.classList.add('hidden');
          }
          if (passwordForm) {
            passwordForm.reset();
          }
          if (passwordStatus) {
            setStatusText(passwordStatus, '');
          }
          if (passwordSave) {
            passwordSave.disabled = false;
          }
          return;
        }

        loginPanel.classList.add('hidden');
        dashboardPanel.classList.remove('hidden');

        const donor = data.donor || {};
        memberNameEl.textContent = donor.name
          ? `Hi ${donor.name}!`
          : 'Add a display name below so we know how to greet you.';
        memberEmailEl.textContent = donor.email
          ? donor.email
          : 'Set your preferred streaming email under profile settings.';

        const normalizedStatus = (donor.status || 'pending').toLowerCase();
        if (memberStatusEl) {
          memberStatusEl.dataset.status = normalizedStatus;
          memberStatusEl.textContent = normalizedStatus || 'pending';
        }

        if (donor.subscriptionId) {
          memberSubscriptionRow.classList.remove('hidden');
          memberSubscriptionId.textContent = donor.subscriptionId;
        } else {
          memberSubscriptionRow.classList.add('hidden');
          memberSubscriptionId.textContent = '';
        }

        if (donor.lastPaymentAt) {
          memberLastPaymentRow.classList.remove('hidden');
          memberLastPayment.textContent = formatDate(donor.lastPaymentAt);
        } else {
          memberLastPaymentRow.classList.add('hidden');
          memberLastPayment.textContent = '';
        }

        const price = formatPrice(
          Number(data.paypal && data.paypal.subscriptionPrice),
          data.paypal && data.paypal.currency
        );
        if (price) {
          memberPlanEl.classList.remove('hidden');
          memberPlanEl.innerHTML = `<span class="label">Monthly support</span><span>${price}</span>`;
        } else {
          memberPlanEl.classList.add('hidden');
          memberPlanEl.innerHTML = '';
        }

        const showSubscriptionCta = Boolean(
          data.paypal &&
            data.paypal.subscriptionCheckoutAvailable &&
            (!donor.subscriptionId || normalizedStatus !== 'active')
        );

        updateMembershipStatusMessage(donor, { showSubscriptionCta });
        updateOnboarding(data, { showSubscriptionCta });

        if (subscriptionButton && subscriptionCta) {
          if (showSubscriptionCta) {
            subscriptionCta.classList.remove('hidden');
            subscriptionButton.disabled = false;
            subscriptionButton.dataset.available = 'true';
            subscriptionButton.textContent = defaultSubscriptionButtonLabel;
            setStatusText(
              subscriptionNote,
              'Opens PayPal checkout in a new tab.',
              'info'
            );
            subscriptionNote.classList.add('small');
          } else {
            subscriptionCta.classList.add('hidden');
            subscriptionButton.disabled = true;
            subscriptionButton.dataset.available = 'false';
            subscriptionButton.textContent = defaultSubscriptionButtonLabel;
            setStatusText(subscriptionNote, '', null);
            subscriptionNote.classList.add('small');
          }
        }

        profileEmail.value = donor.email || '';
        profileName.value = donor.name || '';
        if (passwordForm) {
          passwordForm.reset();
        }
        if (passwordStatus) {
          setStatusText(passwordStatus, '');
        }
        if (passwordGuidance) {
          passwordGuidance.textContent = donor.hasPassword
            ? 'Update your dashboard password to keep your account secure.'
            : 'Set a password so you can return to the dashboard anytime.';
        }
        if (passwordCurrentRow) {
          if (donor.hasPassword) {
            passwordCurrentRow.classList.remove('hidden');
          } else {
            passwordCurrentRow.classList.add('hidden');
          }
        }
        if (passwordCurrent) {
          passwordCurrent.disabled = !donor.hasPassword;
          passwordCurrent.required = Boolean(donor.hasPassword);
        }
        if (passwordSave) {
          passwordSave.disabled = false;
        }
        inviteEmail.value = donor.email || '';

        const limitReached = Boolean(data.inviteLimitReached);

        renderInvite(data.invite, limitReached);

        const inviteBlocked = normalizedStatus !== 'active' || limitReached;
        if (inviteSubmit) {
          inviteSubmit.disabled = inviteBlocked;
        }
        if (inviteEmail) {
          inviteEmail.disabled = inviteBlocked;
        }
        if (inviteNote) {
          inviteNote.disabled = inviteBlocked;
        }

        if (inviteBlocked && !limitReached) {
          inviteDescription.textContent = showSubscriptionCta
            ? 'Start your PayPal subscription to unlock invite generation.'
            : 'Invite generation unlocks once your subscription is active.';
        }

        const identifier = donor.name || donor.email || donor.subscriptionId || '';
        if (identifier) {
          document.title = `Plex Dashboard • ${identifier}`;
        }
      }

      async function openDashboardSubscriptionCheckout() {
        if (!subscriptionButton || subscriptionButton.dataset.available !== 'true') {
          return;
        }

        subscriptionButton.disabled = true;
        subscriptionButton.textContent = 'Opening PayPal…';
        setStatusText(
          subscriptionNote,
          'Opening PayPal checkout in a new tab…',
          'info'
        );
        subscriptionNote.classList.add('small');

        const payload = {};
        const emailValue = profileEmail ? profileEmail.value.trim() : '';
        const nameValue = profileName ? profileName.value.trim() : '';
        if (emailValue) {
          payload.email = emailValue;
        }
        if (nameValue) {
          payload.name = nameValue;
        }

        const requestInit = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        };

        let checkoutWindow = null;
        try {
          checkoutWindow = window.open('', '_blank');
          if (checkoutWindow) {
            try {
              checkoutWindow.opener = null;
            } catch (err) {
              // Ignore browsers that prevent direct assignment.
            }
          }
        } catch (err) {
          checkoutWindow = null;
        }

        try {
          const response = await sessionFetch('/api/customer/paypal-checkout', requestInit);
          let data;
          try {
            data = await response.json();
          } catch (err) {
            data = {};
          }

          updateSessionTokenFromResponse(data);

          if (!response.ok) {
            throw new Error(data.error || 'Unable to start PayPal checkout.');
          }

          if (data.approvalUrl) {
            let opened = false;
            if (checkoutWindow) {
              checkoutWindow.location = data.approvalUrl;
              opened = true;
            } else {
              const fallbackWindow = window.open(data.approvalUrl, '_blank');
              if (fallbackWindow) {
                opened = true;
                checkoutWindow = fallbackWindow;
                try {
                  fallbackWindow.opener = null;
                } catch (err) {
                  // Ignore browsers that prevent direct assignment.
                }
              }
            }

            if (!opened) {
              throw new Error(
                'Your browser blocked the PayPal checkout window. Allow pop-ups and try again.'
              );
            }
            setStatusText(
              subscriptionNote,
              'Follow the steps in the PayPal tab to complete your subscription.',
              'success'
            );
            subscriptionNote.classList.add('small');
          } else {
            throw new Error('PayPal did not return a checkout URL.');
          }
        } catch (err) {
          setStatusText(subscriptionNote, err.message, 'error');
          subscriptionNote.classList.add('small');
          if (checkoutWindow) {
            try {
              checkoutWindow.close();
            } catch (closeErr) {
              // Ignore close errors.
            }
          }
        } finally {
          subscriptionButton.disabled = false;
          subscriptionButton.textContent = defaultSubscriptionButtonLabel;
        }
      }

      async function fetchSession() {
        showLoading();
        try {
          const response = await sessionFetch('/api/customer/session');
          const payload = await response.json();
          updateSessionTokenFromResponse(payload);
          renderDashboard(payload);
        } catch (err) {
          showError(err.message);
        }
      }

      if (forgotPasswordLink) {
        forgotPasswordLink.addEventListener('click', (event) => {
          event.preventDefault();
          if (!forgotPasswordHelp) {
            return;
          }
          const isHidden = forgotPasswordHelp.classList.contains('hidden');
          if (isHidden) {
            forgotPasswordHelp.classList.remove('hidden');
            forgotPasswordLink.setAttribute('aria-expanded', 'true');
            forgotPasswordLink.textContent = 'Hide password help';
          } else {
            forgotPasswordHelp.classList.add('hidden');
            forgotPasswordLink.setAttribute('aria-expanded', 'false');
            forgotPasswordLink.textContent = defaultForgotPasswordLinkText;
          }
        });
      }

      if (changePasswordButton) {
        changePasswordButton.addEventListener('click', () => {
          if (passwordPanel) {
            passwordPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
          window.setTimeout(() => {
            if (passwordNew) {
              try {
                passwordNew.focus();
              } catch (err) {
                // Ignore focus errors.
              }
            }
          }, 200);
        });
      }

      if (passwordForm) {
        passwordForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!passwordSave) {
            return;
          }
          setStatusText(passwordStatus, 'Saving…', 'info');
          passwordSave.disabled = true;
          const payload = {
            currentPassword: passwordCurrent ? passwordCurrent.value : '',
            newPassword: passwordNew ? passwordNew.value : '',
            confirmPassword: passwordConfirm ? passwordConfirm.value : '',
          };

          try {
            const response = await sessionFetch('/api/customer/password', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            });
            let responseBody;
            try {
              responseBody = await response.json();
            } catch (err) {
              responseBody = {};
            }
            updateSessionTokenFromResponse(responseBody);
            if (!response.ok) {
              throw new Error(responseBody.error || 'Failed to update password');
            }
            renderDashboard(responseBody);
            setStatusText(
              passwordStatus,
              'Password updated successfully.',
              'success'
            );
            if (passwordForm) {
              passwordForm.reset();
            }
          } catch (err) {
            setStatusText(passwordStatus, err.message, 'error');
          } finally {
            if (passwordSave) {
              passwordSave.disabled = false;
            }
          }
        });
      }

      loginForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const email = loginEmail.value.trim();
        const password = loginPassword.value;

        if (!email || !password) {
          setStatusText(
            loginStatus,
            'Enter both your email and password to continue.',
            'error'
          );
          return;
        }

        setStatusText(loginStatus, 'Signing in…', 'info');
        loginButton.disabled = true;
        try {
          const response = await sessionFetch('/api/customer/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email,
              password,
            }),
          });
          const payload = await response.json();
          updateSessionTokenFromResponse(payload);
          if (!response.ok) {
            throw new Error(payload.error || 'Unable to sign in');
          }
          setStatusText(loginStatus, 'Signed in successfully!', 'success');
          renderDashboard(payload);
          loginPassword.value = '';
        } catch (err) {
          setStatusText(loginStatus, err.message, 'error');
        } finally {
          loginButton.disabled = false;
        }
      });

      logoutButton.addEventListener('click', async () => {
        logoutButton.disabled = true;
        try {
          await sessionFetch('/api/customer/logout', { method: 'POST' });
          renderDashboard({ authenticated: false });
        } catch (err) {
          // ignore logout errors and show login anyway
          renderDashboard({ authenticated: false });
        } finally {
          setSessionToken(null);
          logoutButton.disabled = false;
        }
      });

      if (subscriptionButton) {
        subscriptionButton.addEventListener('click', async (event) => {
          event.preventDefault();
          if (subscriptionButton.disabled || subscriptionButton.dataset.available !== 'true') {
            return;
          }
          await openDashboardSubscriptionCheckout();
        });
      }

      profileForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        setStatusText(profileStatus, 'Saving…', 'info');
        profileSave.disabled = true;
        try {
          const response = await sessionFetch('/api/customer/profile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: profileEmail.value.trim(),
              name: profileName.value.trim(),
            }),
          });
          const payload = await response.json();
          updateSessionTokenFromResponse(payload);
          if (!response.ok) {
            throw new Error(payload.error || 'Failed to update profile');
          }
          setStatusText(profileStatus, 'Profile updated', 'success');
          renderDashboard(payload);
        } catch (err) {
          setStatusText(profileStatus, err.message, 'error');
        } finally {
          profileSave.disabled = false;
        }
      });

      inviteForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (
          inviteSubmit.disabled ||
          (inviteForm && inviteForm.classList.contains('hidden')) ||
          (state.data && state.data.inviteLimitReached)
        ) {
          return;
        }
        setStatusText(inviteStatus, 'Generating invite…', 'info');
        inviteSubmit.disabled = true;
        let responseData = null;
        try {
          const response = await sessionFetch('/api/customer/invite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: inviteEmail.value.trim(),
              note: inviteNote.value.trim(),
            }),
          });
          const payload = await response.json();
          responseData = payload;
          updateSessionTokenFromResponse(payload);
          if (!response.ok) {
            if (payload && payload.payload) {
              renderDashboard(payload.payload);
            }
            throw new Error(payload.error || 'Failed to generate invite');
          }
          setStatusText(
            inviteStatus,
            'Invite ready! Use the link below to finish connecting.',
            'success'
          );
          inviteNote.value = '';
          renderDashboard(payload);
        } catch (err) {
          setStatusText(inviteStatus, err.message, 'error');
        } finally {
          const limitHit = Boolean(
            (responseData && responseData.inviteLimitReached) ||
              (state.data && state.data.inviteLimitReached)
          );
          if (!limitHit) {
            inviteSubmit.disabled = false;
          }
        }
      });

      fetchSession();
    </script>
  </body>
</html>
