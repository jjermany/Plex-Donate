<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#f8fafc" />
    <meta name="msapplication-TileColor" content="#0f172a" />
    <meta name="msapplication-TileImage" content="/icons/plex-donate-android-any-144.png" />
    <meta name="application-name" content="Plex Donate" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Plex Donate" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <link rel="icon" type="image/png" sizes="144x144" href="/icons/plex-donate-android-any-144.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/plex-donate-android-any-192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/plex-donate-android-any-512.png" />
    <link rel="shortcut icon" href="/icons/plex-donate-android-any-144.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/plex-donate-ios-120.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/plex-donate-ios-152.png" />
    <link rel="apple-touch-icon" sizes="167x167" href="/icons/plex-donate-ios-167.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/plex-donate-ios-180.png" />

    <title>Plex Donate Admin</title>
    <script>
      (() => {
        try {
          const stored = localStorage.getItem('plexDonateTheme');
          const prefersDark =
            window.matchMedia &&
            window.matchMedia('(prefers-color-scheme: dark)').matches;
          const theme =
            stored === 'dark' || stored === 'light'
              ? stored
              : prefersDark
                ? 'dark'
                : 'light';
          document.documentElement.dataset.theme = theme;
          const meta = document.querySelector('meta[name="theme-color"]');
          if (meta) {
            meta.setAttribute('content', theme === 'dark' ? '#0f172a' : '#f8fafc');
          }
        } catch (err) {
          document.documentElement.dataset.theme = 'light';
        }
      })();
    </script>
    <style>
      :root {
        color-scheme: light;
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: var(--page-background);
        color: var(--text-primary);
        --page-background: #f8fafc;
        --background-gradient: linear-gradient(180deg, #eef2ff 0%, #f8fafc 100%);
        --text-primary: #0f172a;
        --text-muted: #475569;
        --text-muted-soft: #64748b;
        --panel-background: rgba(255, 255, 255, 0.88);
        --panel-border-color: rgba(148, 163, 184, 0.18);
        --panel-shadow: 0 25px 50px -12px rgba(30, 64, 175, 0.2);
        --input-border: #c7d2fe;
        --input-background: rgba(255, 255, 255, 0.7);
        --table-border: rgba(148, 163, 184, 0.3);
        --table-hover: rgba(99, 102, 241, 0.08);
        --settings-divider: rgba(148, 163, 184, 0.25);
        --events-time-color: #64748b;
        --event-payload-bg: #f1f5f9;
        --badge-bg: rgba(79, 70, 229, 0.12);
        --badge-color: #4f46e5;
        --badge-note-bg: rgba(99, 102, 241, 0.16);
        --badge-note-color: #4338ca;
        --badge-revoked-bg: rgba(248, 113, 113, 0.15);
        --badge-revoked-color: #b91c1c;
        --badge-visited-bg: rgba(34, 197, 94, 0.12);
        --badge-visited-color: #15803d;
        --status-active-bg: rgba(34, 197, 94, 0.15);
        --status-active-color: #15803d;
        --status-pending-bg: rgba(59, 130, 246, 0.15);
        --status-pending-color: #1d4ed8;
        --status-danger-bg: rgba(248, 113, 113, 0.18);
        --status-danger-color: #b91c1c;
        --status-message-color: #b91c1c;
        --form-status: #64748b;
        --form-status-error: #b91c1c;
        --form-status-success: #15803d;
        --button-primary-bg: #6366f1;
        --button-primary-color: #ffffff;
        --button-primary-shadow: 0 6px 12px rgba(79, 70, 229, 0.2);
        --button-secondary-bg: #e2e8f0;
        --button-secondary-color: #1e293b;
        --button-secondary-shadow: 0 6px 12px rgba(148, 163, 184, 0.35);
        --button-danger-bg: #f87171;
        --button-danger-color: #ffffff;
        --button-danger-shadow: 0 6px 12px rgba(248, 113, 113, 0.35);
      }

      :root[data-theme='dark'] {
        color-scheme: dark;
        --page-background: #0f172a;
        --background-gradient: linear-gradient(180deg, #0f172a 0%, #111827 100%);
        --text-primary: #e2e8f0;
        --text-muted: #cbd5f5;
        --text-muted-soft: #94a3b8;
        --panel-background: rgba(15, 23, 42, 0.9);
        --panel-border-color: rgba(71, 85, 105, 0.55);
        --panel-shadow: 0 25px 50px -16px rgba(15, 23, 42, 0.6);
        --input-border: rgba(129, 140, 248, 0.4);
        --input-background: rgba(15, 23, 42, 0.75);
        --table-border: rgba(71, 85, 105, 0.6);
        --table-hover: rgba(79, 70, 229, 0.2);
        --settings-divider: rgba(71, 85, 105, 0.6);
        --events-time-color: #94a3b8;
        --event-payload-bg: rgba(30, 41, 59, 0.75);
        --badge-bg: rgba(165, 180, 252, 0.18);
        --badge-color: #c7d2fe;
        --badge-note-bg: rgba(99, 102, 241, 0.28);
        --badge-note-color: #c7d2fe;
        --badge-revoked-bg: rgba(248, 113, 113, 0.28);
        --badge-revoked-color: #fecdd3;
        --badge-visited-bg: rgba(34, 197, 94, 0.28);
        --badge-visited-color: #bbf7d0;
        --status-active-bg: rgba(34, 197, 94, 0.32);
        --status-active-color: #bbf7d0;
        --status-pending-bg: rgba(59, 130, 246, 0.28);
        --status-pending-color: #bfdbfe;
        --status-danger-bg: rgba(248, 113, 113, 0.32);
        --status-danger-color: #fecdd3;
        --status-message-color: #fca5a5;
        --form-status: #94a3b8;
        --form-status-error: #fca5a5;
        --form-status-success: #bbf7d0;
        --button-primary-bg: #4f46e5;
        --button-primary-shadow: 0 6px 12px rgba(99, 102, 241, 0.4);
        --button-secondary-bg: rgba(71, 85, 105, 0.7);
        --button-secondary-color: #e2e8f0;
        --button-secondary-shadow: 0 6px 12px rgba(15, 23, 42, 0.5);
        --button-danger-bg: #ef4444;
        --button-danger-color: #ffffff;
        --button-danger-shadow: 0 6px 12px rgba(239, 68, 68, 0.45);
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--background-gradient);
        background-color: var(--page-background);
        color: var(--text-primary);
        transition: background 0.3s ease, color 0.3s ease;
      }

      .container {
        max-width: 1080px;
        margin: 0 auto;
        padding: 32px 24px 64px;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 32px;
        gap: 16px;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      h1 {
        font-size: clamp(1.8rem, 2.2vw, 2.4rem);
        margin: 0;
      }

      button {
        cursor: pointer;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        padding: 10px 18px;
        background: var(--button-primary-bg);
        color: var(--button-primary-color);
        transition: transform 0.1s ease, box-shadow 0.1s ease;
      }

      button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: var(--button-primary-shadow);
      }

      button.secondary {
        background: var(--button-secondary-bg);
        color: var(--button-secondary-color);
      }

      button.secondary:hover:not(:disabled) {
        box-shadow: var(--button-secondary-shadow);
      }

      button.danger {
        background: var(--button-danger-bg);
        color: var(--button-danger-color);
      }

      button.danger:hover:not(:disabled) {
        box-shadow: var(--button-danger-shadow);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .panel {
        background: var(--panel-background);
        border-radius: 16px;
        padding: 28px;
        box-shadow: var(--panel-shadow);
        margin-bottom: 24px;
        border: 1px solid var(--panel-border-color);
        backdrop-filter: blur(14px);
      }

      .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .login-panel {
        position: relative;
        overflow: hidden;
      }

      .login-panel::before {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(
            circle at top right,
            rgba(99, 102, 241, 0.25),
            transparent 55%
          ),
          radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.2), transparent 60%);
        pointer-events: none;
        opacity: 0.85;
      }

      .login-panel > * {
        position: relative;
        z-index: 1;
      }

      .login-panel h2 {
        margin-top: 0;
        margin-bottom: 8px;
      }

      .login-description {
        margin-top: 0;
        margin-bottom: 20px;
        color: var(--text-muted);
      }

      .login-form {
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .input-shell {
        position: relative;
        display: flex;
        align-items: center;
        gap: 12px;
        border-radius: 16px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.22), rgba(56, 189, 248, 0.18));
        padding: 6px 18px;
        backdrop-filter: blur(16px);
        box-shadow: 0 22px 40px -26px rgba(79, 70, 229, 0.65);
        transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
      }

      :root[data-theme='dark'] .input-shell {
        border-color: rgba(129, 140, 248, 0.45);
        background: linear-gradient(135deg, rgba(79, 70, 229, 0.38), rgba(14, 165, 233, 0.22));
        box-shadow: 0 22px 44px -28px rgba(15, 23, 42, 0.85);
      }

      .input-shell:focus-within {
        border-color: rgba(79, 70, 229, 0.85);
        box-shadow: 0 26px 48px -24px rgba(79, 70, 229, 0.75);
        transform: translateY(-1px);
      }

      .input-shell .input-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 38px;
        height: 38px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.22);
        color: var(--text-muted);
        font-size: 1rem;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3);
      }

      :root[data-theme='dark'] .input-shell .input-icon {
        background: rgba(15, 23, 42, 0.6);
        color: #cbd5f5;
        box-shadow: inset 0 1px 0 rgba(148, 163, 184, 0.35);
      }

      .input-shell input {
        flex: 1;
        border: none;
        background: transparent;
        color: inherit;
        padding: 10px 0;
        font-size: 1.05rem;
        font-weight: 500;
        outline: none;
      }

      .input-shell input::placeholder {
        color: var(--text-muted-soft);
        font-weight: 400;
      }

      .input-shell button {
        margin-left: auto;
        padding: 6px 12px;
        font-size: 0.85rem;
        border-radius: 10px;
        background: rgba(15, 23, 42, 0.08);
        color: var(--text-muted);
        transition: background 0.2s ease, color 0.2s ease;
      }

      :root[data-theme='dark'] .input-shell button {
        background: rgba(148, 163, 184, 0.18);
        color: #e2e8f0;
      }

      .input-shell button:hover:not(:disabled) {
        background: rgba(79, 70, 229, 0.18);
        color: var(--button-primary-color);
      }

      .login-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .login-actions button {
        width: 100%;
      }

      .form-status-text {
        margin: 16px 0 0;
        color: var(--form-status);
      }

      .form-status-text.error {
        color: var(--form-status-error);
      }

      .form-status-text.success {
        color: var(--form-status-success);
      }

      label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
      }

      input[type='password'] {
        width: 100%;
        border-radius: 8px;
        border: 1px solid var(--input-border);
        padding: 10px 12px;
        font-size: 1rem;
        box-sizing: border-box;
        background: var(--input-background);
        color: var(--text-primary);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }

      th,
      td {
        text-align: left;
        padding: 10px 12px;
        border-bottom: 1px solid var(--table-border);
        vertical-align: top;
      }

      th {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
      }

      tbody tr:hover {
        background-color: var(--table-hover);
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        border-radius: 999px;
        padding: 4px 10px;
        font-weight: 600;
        text-transform: capitalize;
      }

      .status-pill[data-status='active'] {
        background: var(--status-active-bg);
        color: var(--status-active-color);
      }

      .status-pill[data-status='pending'] {
        background: var(--status-pending-bg);
        color: var(--status-pending-color);
      }

      .status-pill[data-status='cancelled'],
      .status-pill[data-status='canceled'],
      .status-pill[data-status='suspended'] {
        background: var(--status-danger-bg);
        color: var(--status-danger-color);
      }

      .status-cell {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .status-note {
        font-size: 0.8rem;
        color: var(--status-message-color);
        line-height: 1.4;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .action-menu {
        position: relative;
        display: inline-block;
        width: 100%;
        max-width: 220px;
      }

      .action-menu-toggle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        width: 100%;
      }

      .action-menu-toggle::after {
        content: '';
        border-style: solid;
        border-width: 5px 5px 0 5px;
        border-color: currentColor transparent transparent transparent;
        transition: transform 0.2s ease;
      }

      .action-menu.open .action-menu-toggle::after {
        transform: rotate(180deg);
      }

      .action-menu-panel {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        display: none;
        flex-direction: column;
        gap: 6px;
        padding: 12px;
        background: var(--panel-background);
        border: 1px solid var(--panel-border-color);
        border-radius: 12px;
        box-shadow: var(--panel-shadow);
        width: min(260px, calc(100vw - 48px));
        z-index: 20;
        backdrop-filter: blur(12px);
      }

      .action-menu.open .action-menu-panel {
        display: flex;
      }

      .action-menu-panel .menu-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        width: 100%;
        background: transparent;
        color: var(--text-primary);
        border-radius: 10px;
        padding: 10px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 0.95rem;
        box-shadow: none;
        transform: none;
      }

      .action-menu-panel .menu-item:hover:not(:disabled) {
        background: var(--table-hover);
        box-shadow: none;
        transform: none;
      }

      .action-menu-panel .menu-item:focus-visible {
        outline: 2px solid var(--button-primary-bg);
        outline-offset: 2px;
      }

      .action-menu-panel .menu-item:disabled {
        opacity: 0.55;
      }

      .action-menu-panel .menu-item.danger {
        color: var(--status-danger-color);
      }

      .action-menu-panel .menu-item.danger:hover:not(:disabled) {
        background: var(--status-danger-bg);
        color: var(--status-danger-color);
      }

      .link-open-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        max-width: 240px;
      }

      @media (max-width: 600px) {
        .action-menu {
          max-width: none;
        }

        .link-open-button {
          max-width: none;
        }
      }

      #status-message {
        margin-top: 12px;
        color: var(--status-message-color);
        font-weight: 500;
      }

      .hidden {
        display: none;
      }

      .grid {
        display: grid;
        gap: 24px;
      }

      @media (min-width: 960px) {
        .grid {
          grid-template-columns: 2fr 1fr;
        }
      }

      .events-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 420px;
        overflow-y: auto;
      }

      .events-list li {
        padding: 10px 0;
        border-bottom: 1px dashed var(--table-border);
        font-size: 0.9rem;
      }

      .events-list time {
        display: block;
        font-size: 0.78rem;
        color: var(--events-time-color);
        margin-bottom: 4px;
      }

      .event-payload {
        white-space: pre-wrap;
        background: var(--event-payload-bg);
        padding: 8px;
        border-radius: 8px;
        margin-top: 6px;
      }

      .settings-form {
        margin-top: 24px;
        padding-top: 16px;
        border-top: 1px solid var(--settings-divider);
        display: grid;
        gap: 12px;
      }

      .settings-form:first-of-type {
        margin-top: 0;
        padding-top: 0;
        border-top: none;
      }

      .settings-form h3 {
        margin: 0;
      }

      .settings-form label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-weight: 600;
        margin-bottom: 0;
      }

      .settings-form input[type='text'],
      .settings-form input[type='password'],
      .settings-form input[type='url'],
      .settings-form input[type='number'],
      .settings-form input[type='email'] {
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        padding: 12px 14px;
        font-size: 0.95rem;
        box-sizing: border-box;
        background: var(--input-background);
        color: var(--text-primary);
        box-shadow: 0 18px 36px -28px rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(12px);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        outline: none;
      }

      .settings-form input[type='text']:focus,
      .settings-form input[type='password']:focus,
      .settings-form input[type='url']:focus,
      .settings-form input[type='number']:focus,
      .settings-form input[type='email']:focus {
        border-color: rgba(79, 70, 229, 0.8);
        box-shadow: 0 22px 44px -28px rgba(79, 70, 229, 0.65);
      }

      .settings-form label span.help {
        font-weight: 500;
        color: var(--text-muted-soft);
        font-size: 0.8rem;
      }

      .library-selector {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .library-selector-label {
        display: block;
        font-weight: 600;
      }

      .library-selector .library-selector-control {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        width: 100%;
        gap: 8px;
      }

      .library-selector .library-selector-toggle {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 12px 16px;
        text-align: left;
      }

      .library-selector .help,
      .library-selector .library-selector-summary {
        margin: 0;
      }

      .library-selector .help {
        font-weight: 500;
        color: var(--text-muted-soft);
        font-size: 0.85rem;
      }

      .library-selector .library-selector-summary {
        font-size: 0.85rem;
      }

      .library-selector .library-selector-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        z-index: 20;
        min-width: 100%;
        max-width: min(420px, calc(100vw - 48px));
        border-radius: 16px;
        border: 1px solid var(--panel-border-color);
        background: var(--panel-background);
        box-shadow: 0 28px 60px -32px rgba(15, 23, 42, 0.6);
        padding: 20px;
        display: grid;
        gap: 12px;
      }

      .library-selector .library-selector-dropdown[hidden] {
        display: none !important;
      }

      .library-selector-options {
        display: grid;
        gap: 8px;
        max-height: 240px;
        overflow-y: auto;
        padding-right: 4px;
      }

      .library-selector-options .checkbox-row {
        font-weight: 600;
      }

      .library-selector-empty {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-muted-soft);
      }

      .library-selector-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        flex-wrap: wrap;
      }

      .paypal-plan-management {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--settings-divider);
        display: grid;
        gap: 16px;
      }

      .paypal-plan-management.hidden {
        display: none;
      }

      .paypal-plan-management .plan-management-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
      }

      .paypal-plan-management .plan-management-header h4 {
        margin: 0 0 4px;
        font-size: 1rem;
      }

      .paypal-plan-management .plan-management-header p {
        margin: 0;
        color: var(--text-muted-soft);
        font-size: 0.9rem;
      }

      .paypal-plan-management .plan-management-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }

      .paypal-plan-management .plan-management-actions .manage-link {
        font-weight: 600;
        color: var(--button-primary-bg);
        text-decoration: none;
      }

      .paypal-plan-management .plan-management-actions .manage-link:hover {
        text-decoration: underline;
      }

      .paypal-plan-management .plan-management-body {
        border-radius: 12px;
        border: 1px solid var(--panel-border-color);
        background: var(--event-payload-bg);
        padding: 16px;
      }

      .paypal-plan-management .plan-management-body.empty {
        border-style: dashed;
        background: transparent;
        color: var(--text-muted-soft);
      }

      .paypal-plan-management .plan-management-body p {
        margin: 0;
      }

      .paypal-plan-management .plan-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin: 0;
        padding: 0;
        list-style: none;
      }

      .paypal-plan-management .plan-details dt {
        margin: 0;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      .paypal-plan-management .plan-details dd {
        margin: 6px 0 0;
        font-size: 0.95rem;
        font-weight: 600;
      }

      .paypal-plan-management .plan-error {
        color: var(--form-status-error);
        font-weight: 600;
      }

      .paypal-plan-management .plan-loading {
        color: var(--text-muted-soft);
      }

      .field-grid {
        display: grid;
        gap: 12px;
      }

      @media (min-width: 720px) {
        .field-grid {
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
      }

      .test-invite-group {
        margin-top: 24px;
        display: grid;
        gap: 12px;
      }

      .test-invite-group p {
        margin: 0;
        color: var(--text-muted-soft);
        font-size: 0.9rem;
      }

      .checkbox-row {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
      }

      .checkbox-row input[type='checkbox'] {
        width: 18px;
        height: 18px;
      }

      .form-status {
        min-height: 18px;
        font-size: 0.85rem;
        color: var(--form-status);
      }

      .form-status[data-state='error'] {
        color: var(--form-status-error);
      }

      .form-status[data-state='success'] {
        color: var(--form-status-success);
      }

      .form-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      @media (min-width: 560px) {
        .form-actions {
          flex-direction: row;
        }
      }

      #prospect-share-form input,
      #prospect-share-form textarea {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--input-border);
        padding: 12px 14px;
        font-size: 1rem;
        background: var(--input-background);
        color: var(--text-primary);
        box-sizing: border-box;
      }

      #prospect-share-form textarea {
        min-height: 96px;
        resize: vertical;
      }

      .share-output {
        margin-top: 20px;
        padding: 16px;
        border-radius: 12px;
        border: 1px dashed var(--panel-border-color);
        background: var(--event-payload-bg);
        display: grid;
        gap: 12px;
      }

      .share-output .share-url {
        display: inline-block;
        word-break: break-word;
        font-weight: 600;
      }

      .share-output-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .share-output-meta {
        color: var(--text-muted-soft);
        font-size: 0.9rem;
      }

      .badge {
        background: var(--badge-bg);
        color: var(--badge-color);
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 0.75rem;
        margin-right: 6px;
        font-weight: 600;
        display: inline-flex;
        gap: 6px;
        align-items: center;
      }

      .badge-note {
        background: var(--badge-note-bg);
        color: var(--badge-note-color);
      }

      .badge-revoked {
        background: var(--badge-revoked-bg);
        color: var(--badge-revoked-color);
      }

      .badge-visited {
        background: var(--badge-visited-bg);
        color: var(--badge-visited-color);
      }

      .muted-text {
        color: var(--text-muted);
      }

      .subtle-text {
        color: var(--text-muted-soft);
        font-size: 0.85rem;
      }

      .dashboard-toast {
        background: var(--panel-background);
        border: 1px solid var(--panel-border-color);
        border-radius: 10px;
        padding: 12px 16px;
        margin: 0 0 16px;
        box-shadow: var(--panel-shadow);
        font-weight: 600;
      }

      .dashboard-toast[data-state='success'] {
        border-color: rgba(34, 197, 94, 0.35);
        color: var(--status-active-color);
      }

      .dashboard-toast[data-state='error'] {
        border-color: rgba(248, 113, 113, 0.35);
        color: var(--status-danger-color);
      }

      #plex-status-note {
        margin: 12px 0 0;
        font-size: 0.9rem;
      }

      #plex-status-note[data-state='error'] {
        color: var(--status-danger-color);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Plex Donate Control Center</h1>
        <div class="header-actions">
          <button id="theme-toggle" type="button" class="secondary" aria-pressed="false">
            Use dark theme
          </button>
          <button id="logout-button" class="hidden" type="button">Log out</button>
        </div>
      </header>
      <div id="dashboard-toast" class="dashboard-toast" hidden aria-live="polite"></div>

      <section id="login-panel" class="panel login-panel">
        <h2>Admin sign in</h2>
        <p class="login-description" id="login-help">
          Use the admin username and password configured for Plex Donate. The default username is
          <code>admin</code>. On first run a temporary password is written to your server logs.
        </p>
        <form id="login-form" class="login-form" autocomplete="on">
          <label class="visually-hidden" for="username">Username</label>
          <div class="input-shell">
            <span class="input-icon" aria-hidden="true">ðŸ‘¤</span>
            <input
              id="username"
              name="username"
              type="text"
              autocomplete="username"
              placeholder="Admin username"
              required
            />
          </div>
          <label class="visually-hidden" for="password">Password</label>
          <div class="input-shell">
            <span class="input-icon" aria-hidden="true">ðŸ”’</span>
            <input
              id="password"
              name="password"
              type="password"
              autocomplete="current-password"
              placeholder="Password"
              required
            />
            <button type="button" class="secondary" id="toggle-password-visibility" aria-pressed="false">
              Show
            </button>
          </div>
          <div class="login-actions">
            <button id="login-submit" type="submit">Sign in</button>
          </div>
        </form>
        <p id="status-message" class="form-status-text"></p>
      </section>

      <div id="dashboard" class="hidden">
        <section class="panel" id="admin-account-panel">
          <h2 style="margin-top:0;">Admin account</h2>
          <p class="muted-text" id="admin-account-description">
            Update the username and password used to access this dashboard. Password changes require at least 12 characters.
          </p>
          <form id="admin-credentials-form" class="settings-form">
            <div class="field-grid">
              <label>
                Username
                <input name="username" type="text" autocomplete="username" placeholder="Admin username" />
              </label>
              <label>
                New password
                <input
                  name="newPassword"
                  type="password"
                  autocomplete="new-password"
                  placeholder="Leave blank to keep current"
                />
              </label>
              <label>
                Confirm new password
                <input
                  name="confirmPassword"
                  type="password"
                  autocomplete="new-password"
                  placeholder="Repeat the new password"
                />
              </label>
            </div>
            <label>
              Current password
              <input name="currentPassword" type="password" autocomplete="current-password" required />
            </label>
            <p class="form-status" data-status-for="admin-credentials"></p>
            <div class="form-actions">
              <button type="submit">Save admin credentials</button>
            </div>
          </form>
        </section>
        <section class="panel" id="prospect-share-panel">
          <h2 style="margin-top:0;">Invite a new supporter</h2>
          <p class="muted-text" style="margin:0 0 16px;">
            Generate a share page for someone who isn't subscribed yet. The link walks them
            through account creation and the PayPal signup flow before unlocking Plex access.
          </p>
          <form id="prospect-share-form">
            <input type="hidden" name="prospectId" />
            <div class="field-grid">
              <label>
                Contact email
                <input
                  name="email"
                  type="email"
                  autocomplete="off"
                  placeholder="future.supporter@example.com"
                />
              </label>
              <label>
                Display name
                <input
                  name="name"
                  type="text"
                  autocomplete="off"
                  placeholder="Future Supporter"
                />
              </label>
            </div>
            <label>
              Internal notes
              <textarea name="note" placeholder="Optional details for other admins"></textarea>
            </label>
            <p class="form-status" data-status-for="prospect-share"></p>
            <div class="form-actions">
              <button type="submit">Generate invite page link</button>
              <button type="button" class="secondary" id="prospect-share-reset">Clear form</button>
            </div>
          </form>
          <div class="share-output hidden" id="prospect-share-result">
            <div>
              <div class="share-output-meta" id="prospect-share-summary"></div>
              <a
                id="prospect-share-url"
                class="share-url"
                href="#"
                target="_blank"
                rel="noopener"
              ></a>
            </div>
            <div class="share-output-actions">
              <button type="button" class="secondary" id="prospect-share-copy">Copy link</button>
              <button type="button" class="secondary" id="prospect-share-regenerate">
                Generate new link
              </button>
            </div>
            <div class="share-output-meta" id="prospect-share-note"></div>
          </div>
        </section>
        <div class="grid">
          <section class="panel">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;">
              <div>
                <h2 style="margin:0 0 4px;">Active subscribers</h2>
                <p class="muted-text" style="margin:0;">Manage Plex invites and check the latest payments.</p>
              </div>
              <button id="refresh-button" type="button" class="secondary">Refresh</button>
            </div>
            <p id="plex-status-note" class="muted-text" hidden></p>
            <div style="overflow-x:auto;">
              <table id="subscribers-table">
                <thead>
                  <tr>
                    <th>Subscriber</th>
                    <th>Status</th>
                    <th>Last payment</th>
                    <th>Invite</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </section>

          <section class="panel" id="share-links-panel">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;">
              <div>
                <h2 style="margin:0 0 4px;">Invite page links</h2>
                <p class="muted-text" style="margin:0;">
                  Review active share URLs and remove any that are no longer needed.
                </p>
              </div>
            </div>
            <div style="overflow-x:auto;">
              <table id="share-links-table">
                <thead>
                  <tr>
                    <th>Link</th>
                    <th>Owner</th>
                    <th>Created</th>
                    <th>Last used</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </section>

          <section class="panel">
            <h2 style="margin-top:0;">Recent activity</h2>
            <ul id="events-list" class="events-list"></ul>
          </section>
        </div>
        <section class="panel" id="settings-panel">
          <h2 style="margin-top:0;">Integration settings</h2>
          <p class="muted-text" style="margin:0 0 16px;">Keep service credentials in one place so you can avoid editing environment files.</p>

          <form class="settings-form" data-group="app">
            <h3>Application</h3>
            <div class="field-grid">
              <label>
                Public base URL
                <input
                  name="publicBaseUrl"
                  type="url"
                  placeholder="https://plexdonate.example.com"
                />
                <span class="help"
                  >Used to build invite page links that work outside your
                  network.</span
                >
              </label>
            </div>
            <p class="form-status" data-status-for="app"></p>
            <div class="form-actions">
              <button type="submit" class="secondary">
                Save application settings
              </button>
            </div>
          </form>

          <form class="settings-form" data-group="paypal">
            <h3>PayPal</h3>
            <div class="field-grid">
              <label>
                Client ID
                <input name="clientId" type="text" autocomplete="off" placeholder="A..." />
              </label>
              <label>
                Client Secret
                <input name="clientSecret" type="password" autocomplete="new-password" placeholder="E..." />
              </label>
              <label>
                Webhook ID
                <input name="webhookId" type="text" autocomplete="off" placeholder="0..." />
              </label>
              <label>
                API base URL
                <input name="apiBase" type="url" placeholder="https://api-m.sandbox.paypal.com" />
                <span class="help">Use the sandbox URL for testing or the live URL for production.</span>
              </label>
              <label>
                Plan ID
                <input name="planId" type="text" autocomplete="off" placeholder="P-123456789" />
                <span class="help">Used to generate the PayPal subscription link that donors visit.</span>
              </label>
              <label>
                Monthly price
                <input name="subscriptionPrice" type="number" min="0" step="0.01" placeholder="5.00" />
                <span class="help">Shown on share pages so donors know the recurring amount.</span>
              </label>
              <label>
                Currency
                <input name="currency" type="text" autocomplete="off" placeholder="USD" />
              </label>
            </div>
            <div class="paypal-plan-management" id="paypal-plan-management">
              <div class="plan-management-header">
                <div>
                  <h4>Subscription plan management</h4>
                  <p>
                    Manage your PayPal billing plan from the PayPal dashboard. Once a
                    plan ID is saved, details will appear below.
                  </p>
                </div>
                <div class="plan-management-actions">
                  <a
                    href="#"
                    class="manage-link"
                    id="paypal-plan-manage-link"
                    target="_blank"
                    rel="noopener"
                    hidden
                    >Open in PayPal</a
                  >
                </div>
              </div>
              <div class="plan-management-body empty" id="paypal-plan-body">
                <p>No PayPal subscription plan has been generated yet.</p>
              </div>
            </div>
            <p class="form-status" data-status-for="paypal"></p>
            <div class="form-actions">
              <button type="submit" class="secondary">Save PayPal settings</button>
              <button type="button" data-action="test">Test PayPal settings</button>
            </div>
          </form>

          <form class="settings-form" data-group="smtp">
            <h3>Email (SMTP)</h3>
            <div class="field-grid">
              <label>
                Host
                <input name="host" type="text" placeholder="smtp.example.com" />
              </label>
              <label>
                Port
                <input name="port" type="number" min="1" />
              </label>
              <label class="checkbox-row">
                <input name="secure" type="checkbox" />
                Use TLS (secure)
              </label>
              <label>
                Username
                <input name="user" type="text" autocomplete="off" />
              </label>
              <label>
                Password
                <input name="pass" type="password" autocomplete="new-password" />
              </label>
              <label>
                From address
                <input name="from" type="email" placeholder="Plex Donate &lt;donations@example.com&gt;" />
              </label>
            </div>
            <p class="form-status" data-status-for="smtp"></p>
            <div class="form-actions">
              <button type="submit" class="secondary">Save email settings</button>
              <button type="button" data-action="test">Test email delivery</button>
            </div>
          </form>

          <form class="settings-form" data-group="plex">
            <h3>Plex invites</h3>
            <p class="muted-text subtle-text" style="margin:0 0 12px;">
              Connect Plex Donate to your server so you can send invites without leaving the dashboard.
            </p>
            <div class="field-grid">
              <label>
                Server URL
                <input name="baseUrl" type="url" placeholder="https://plex.example.com" />
              </label>
              <label>
                Plex token
                <input name="token" type="password" autocomplete="new-password" />
              </label>
              <label>
                Server UUID
                <input
                  name="serverIdentifier"
                  type="text"
                  placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                />
                <span class="muted-text subtle-text">
                  Enter your Plex machine identifier; Plex Donate will resolve the numeric
                  server ID automatically.
                </span>
              </label>
              <div class="library-selector" data-library-picker>
                <label class="library-selector-label">Library access</label>
                <input
                  name="librarySectionIds"
                  type="hidden"
                  data-library-input
                />
                <div class="library-selector-control">
                  <button
                    type="button"
                    class="secondary library-selector-toggle"
                    data-library-toggle
                    aria-haspopup="true"
                    aria-expanded="false"
                    disabled
                  >
                    Select libraries
                  </button>
                  <p class="help" data-library-help>
                    Test the Plex connection to load your server's libraries.
                  </p>
                  <p
                    class="muted-text subtle-text library-selector-summary"
                    data-library-summary
                    hidden
                  ></p>
                </div>
                <div class="library-selector-dropdown" data-library-dropdown hidden>
                  <div class="library-selector-options" data-library-options></div>
                  <p class="library-selector-empty" data-library-empty hidden>
                    No libraries were returned. Check your Plex permissions and try again.
                  </p>
                  <div class="library-selector-actions">
                    <button type="button" class="secondary" data-library-clear>
                      Clear selection
                    </button>
                    <button type="button" class="secondary" data-library-apply>
                      OK
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="test-invite-group">
              <label>
                Send test invite to
                <input
                  name="testInviteEmail"
                  type="email"
                  placeholder="you@example.com"
                  autocomplete="off"
                  data-test-field="invite-email"
                  data-transient="true"
                />
                <span class="help"
                  >Creates a real Plex invite and emails it using your saved SMTP settings.</span
                >
              </label>
              <label>
                Plex password for test invite
                <input
                  name="testInvitePassword"
                  type="password"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  autocomplete="current-password"
                  data-test-field="invite-password"
                  data-transient="true"
                />
                <span class="help"
                  >Used temporarily to authenticate the Plex account before sending the
                  invite. This password is not stored.</span
                >
              </label>
              <p>Use this to verify invite delivery before sharing your donation link.</p>
            </div>
            <p class="form-status" data-status-for="plex"></p>
            <div class="form-actions">
              <button type="submit" class="secondary">Save Plex settings</button>
              <button type="button" data-action="test">Test Plex connection</button>
              <button type="button" data-action="test-invite">Send Plex test invite</button>
            </div>
          </form>
        </section>
      </div>
    </div>

    <template id="subscriber-row">
      <tr>
        <td class="col-subscriber"></td>
        <td class="col-status">
          <div class="status-cell">
            <span class="status-pill"></span>
            <div class="status-note" hidden></div>
          </div>
        </td>
        <td class="col-last-payment"></td>
        <td class="col-invite"></td>
        <td class="col-actions">
          <div class="action-menu">
            <button type="button" class="action-menu-toggle secondary" data-menu-toggle>
              Actions
            </button>
            <div class="action-menu-panel" role="menu" hidden aria-hidden="true">
              <button
                type="button"
                class="menu-item"
                data-action="invite"
                role="menuitem"
              >
                Send Plex invite
              </button>
              <button
                type="button"
                class="menu-item"
                data-action="share"
                role="menuitem"
              >
                Copy invite page link
              </button>
              <button
                type="button"
                class="menu-item"
                data-action="refresh"
                role="menuitem"
              >
                Re-verify PayPal
              </button>
              <button
                type="button"
                class="menu-item"
                data-action="share-generate"
                role="menuitem"
              >
                Generate invite page link
              </button>
              <button
                type="button"
                class="menu-item"
                data-action="resend"
                role="menuitem"
              >
                Resend email
              </button>
              <button
                type="button"
                class="menu-item danger"
                data-action="revoke"
                role="menuitem"
              >
                Revoke invite
              </button>
              <button
                type="button"
                class="menu-item danger"
                data-action="remove"
                role="menuitem"
              >
                Remove subscriber
              </button>
            </div>
          </div>
        </td>
      </tr>
    </template>

    <template id="share-link-row">
      <tr>
        <td class="col-link"></td>
        <td class="col-owner"></td>
        <td class="col-created"></td>
        <td class="col-last-used"></td>
        <td>
          <div class="actions">
            <button data-action="copy" class="secondary">Copy link</button>
            <button data-action="remove" class="danger secondary">Remove</button>
          </div>
        </td>
      </tr>
    </template>

    <script>
      const loginPanel = document.getElementById('login-panel');
      const loginForm = document.getElementById('login-form');
      const loginUsernameInput = document.getElementById('username');
      const loginPasswordInput = document.getElementById('password');
      const loginSubmitButton = document.getElementById('login-submit');
      const loginHelp = document.getElementById('login-help');
      const togglePasswordVisibilityButton = document.getElementById('toggle-password-visibility');
      const dashboard = document.getElementById('dashboard');
      const logoutButton = document.getElementById('logout-button');
      const statusMessage = document.getElementById('status-message');
      const dashboardToast = document.getElementById('dashboard-toast');
      const adminAccountPanel = document.getElementById('admin-account-panel');
      const adminCredentialsForm = document.getElementById('admin-credentials-form');
      const adminAccountDescription = document.getElementById('admin-account-description');
      const subscribersTable = document.querySelector('#subscribers-table tbody');
      const plexStatusNote = document.getElementById('plex-status-note');
      const shareLinksPanel = document.getElementById('share-links-panel');
      const shareLinksTable = document.querySelector('#share-links-table tbody');
      const eventsList = document.getElementById('events-list');
      const refreshButton = document.getElementById('refresh-button');
      const settingsPanel = document.getElementById('settings-panel');
      const settingsForms = settingsPanel
        ? Array.from(settingsPanel.querySelectorAll('.settings-form'))
        : [];
      const plexLibraryPicker = settingsPanel
        ? settingsPanel.querySelector('[data-library-picker]')
        : null;
      const plexLibraryInput = plexLibraryPicker
        ? plexLibraryPicker.querySelector('[data-library-input]')
        : null;
      const plexLibraryToggle = plexLibraryPicker
        ? plexLibraryPicker.querySelector('[data-library-toggle]')
        : null;
      const plexLibraryDropdown = plexLibraryPicker
        ? plexLibraryPicker.querySelector('[data-library-dropdown]')
        : null;
      const plexLibraryOptions = plexLibraryPicker
        ? plexLibraryPicker.querySelector('[data-library-options]')
        : null;
      const plexLibraryEmpty = plexLibraryPicker
        ? plexLibraryPicker.querySelector('[data-library-empty]')
        : null;
      const plexLibraryHelp = plexLibraryPicker
        ? plexLibraryPicker.querySelector('[data-library-help]')
        : null;
      const plexLibrarySummary = plexLibraryPicker
        ? plexLibraryPicker.querySelector('[data-library-summary]')
        : null;
      const plexLibraryClearButton = plexLibraryPicker
        ? plexLibraryPicker.querySelector('[data-library-clear]')
        : null;
      const plexLibraryApplyButton = plexLibraryPicker
        ? plexLibraryPicker.querySelector('[data-library-apply]')
        : null;
      const paypalPlanSection = document.getElementById('paypal-plan-management');
      const paypalPlanBody = document.getElementById('paypal-plan-body');
      const paypalPlanManageLink = document.getElementById('paypal-plan-manage-link');
      const prospectSharePanel = document.getElementById('prospect-share-panel');
      const prospectShareForm = document.getElementById('prospect-share-form');
      const prospectShareResult = document.getElementById('prospect-share-result');
      const prospectShareSummary = document.getElementById('prospect-share-summary');
      const prospectShareUrl = document.getElementById('prospect-share-url');
      const prospectShareNote = document.getElementById('prospect-share-note');
      const prospectShareCopy = document.getElementById('prospect-share-copy');
      const prospectShareRegenerate = document.getElementById('prospect-share-regenerate');
      const prospectShareReset = document.getElementById('prospect-share-reset');
      const themeToggleButton = document.getElementById('theme-toggle');
      const themeMeta = document.querySelector('meta[name="theme-color"]');
      const rootElement = document.documentElement;
      const THEME_STORAGE_KEY = 'plexDonateTheme';

      if (prospectShareCopy) {
        prospectShareCopy.disabled = true;
      }
      if (prospectShareRegenerate) {
        prospectShareRegenerate.disabled = true;
      }

      let csrfToken = null;
      const SESSION_TOKEN_QUERY_PARAM = 'session';
      let sessionToken = null;

      let openSubscriberActionMenu = null;

      function closeSubscriberActionMenu(menu, options = {}) {
        const targetMenu = menu || openSubscriberActionMenu;
        if (!targetMenu) {
          return;
        }
        const { focusToggle = false } = options;
        targetMenu.classList.remove('open');
        const panel = targetMenu.querySelector('.action-menu-panel');
        if (panel) {
          panel.hidden = true;
          panel.setAttribute('aria-hidden', 'true');
        }
        const toggle = targetMenu.querySelector('[data-menu-toggle]');
        if (toggle) {
          toggle.setAttribute('aria-expanded', 'false');
          if (focusToggle) {
            toggle.focus();
          }
        }
        if (openSubscriberActionMenu === targetMenu) {
          openSubscriberActionMenu = null;
        }
      }

      function openSubscriberActionMenuFor(menu) {
        if (!menu) {
          return;
        }
        if (openSubscriberActionMenu && openSubscriberActionMenu !== menu) {
          closeSubscriberActionMenu(openSubscriberActionMenu);
        }
        menu.classList.add('open');
        const panel = menu.querySelector('.action-menu-panel');
        if (panel) {
          panel.hidden = false;
          panel.setAttribute('aria-hidden', 'false');
        }
        const toggle = menu.querySelector('[data-menu-toggle]');
        if (toggle) {
          toggle.setAttribute('aria-expanded', 'true');
        }
        openSubscriberActionMenu = menu;
        window.requestAnimationFrame(() => {
          const firstItem = menu.querySelector(
            '.action-menu-panel button[data-action]:not(:disabled)'
          );
          if (firstItem) {
            firstItem.focus();
          }
        });
      }

      function toggleSubscriberActionMenu(menu) {
        if (!menu) {
          return;
        }
        if (menu.classList.contains('open')) {
          closeSubscriberActionMenu(menu, { focusToggle: true });
        } else {
          openSubscriberActionMenuFor(menu);
        }
      }

      function normalizeSessionToken(token) {
        if (typeof token !== 'string') {
          return null;
        }
        const trimmed = token.trim();
        return trimmed ? trimmed : null;
      }

      function applySessionTokenToUrl(token) {
        try {
          const url = new URL(window.location.href);
          if (token) {
            url.searchParams.set(SESSION_TOKEN_QUERY_PARAM, token);
          } else {
            url.searchParams.delete(SESSION_TOKEN_QUERY_PARAM);
          }
          const nextUrl = `${url.pathname}${url.search}${url.hash}`;
          window.history.replaceState({}, '', nextUrl);
        } catch (err) {
          // Ignore URL update errors.
        }
      }

      function setSessionToken(token) {
        const normalized = normalizeSessionToken(token);
        if (normalized === sessionToken) {
          return;
        }
        sessionToken = normalized;
        applySessionTokenToUrl(sessionToken);
      }

      (function initializeSessionTokenFromUrl() {
        try {
          const url = new URL(window.location.href);
          const existing = url.searchParams.get(SESSION_TOKEN_QUERY_PARAM);
          if (existing) {
            setSessionToken(existing);
          }
        } catch (err) {
          sessionToken = null;
        }
      })();

      function withSessionToken(path) {
        if (!sessionToken) {
          return path;
        }
        try {
          const url = new URL(path, window.location.origin);
          url.searchParams.set(SESSION_TOKEN_QUERY_PARAM, sessionToken);
          return url.toString();
        } catch (err) {
          return path;
        }
      }

      function updateSessionTokenFromResponse(data) {
        if (!data || typeof data !== 'object') {
          return;
        }
        if (Object.prototype.hasOwnProperty.call(data, 'sessionToken')) {
          setSessionToken(data.sessionToken);
        }
      }

      let state = {
        authenticated: false,
        donors: [],
        shareLinks: [],
        events: [],
        prospectShare: null,
        settings: null,
        paypalPlan: null,
        paypalProduct: null,
        paypalPlanError: '',
        paypalPlanManageUrl: '',
        paypalPlanLoading: false,
        adminUsername: 'admin',
        plex: null,
        plexLibraries: null,
      };

      function setLoginStatus(message = '', stateAttr = '') {
        if (!statusMessage) {
          return;
        }
        statusMessage.textContent = message;
        statusMessage.classList.remove('error', 'success');
        if (stateAttr) {
          statusMessage.classList.add(stateAttr);
        }
      }

      const AUTO_REFRESH_INTERVAL_MS = 30 * 1000;
      let autoRefreshTimerId = null;
      let dashboardDataPromise = null;

      const statusClearTimers = new WeakMap();
      let toastTimerId = null;

      function stopDashboardAutoRefresh() {
        if (autoRefreshTimerId) {
          window.clearInterval(autoRefreshTimerId);
          autoRefreshTimerId = null;
        }
      }

      async function autoRefreshDashboardData() {
        if (!state.authenticated) {
          stopDashboardAutoRefresh();
          return;
        }
        try {
          await loadDashboardData();
        } catch (err) {
          console.error('Automatic dashboard refresh failed', err);
        }
      }

      function startDashboardAutoRefresh() {
        stopDashboardAutoRefresh();
        autoRefreshTimerId = window.setInterval(
          autoRefreshDashboardData,
          AUTO_REFRESH_INTERVAL_MS
        );
      }

      function storeThemePreference(theme) {
        try {
          localStorage.setItem(THEME_STORAGE_KEY, theme);
        } catch (err) {
          /* noop */
        }
      }

      function applyTheme(theme, persist = true) {
        const normalized = theme === 'dark' ? 'dark' : 'light';
        rootElement.dataset.theme = normalized;
        if (persist) {
          storeThemePreference(normalized);
        }
        if (themeMeta) {
          themeMeta.setAttribute('content', normalized === 'dark' ? '#0f172a' : '#f8fafc');
        }
        if (themeToggleButton) {
          themeToggleButton.textContent =
            normalized === 'dark' ? 'Use light theme' : 'Use dark theme';
          themeToggleButton.setAttribute('aria-pressed', normalized === 'dark' ? 'true' : 'false');
        }
      }

      applyTheme(rootElement.dataset.theme || 'light', false);

      if (themeToggleButton) {
        themeToggleButton.addEventListener('click', () => {
          const nextTheme = rootElement.dataset.theme === 'dark' ? 'light' : 'dark';
          applyTheme(nextTheme);
        });
      }

      function registerServiceWorker() {
        if (!('serviceWorker' in navigator)) {
          return;
        }
        window.addEventListener('load', () => {
          navigator.serviceWorker
            .register('/service-worker.js')
            .catch((err) => {
              console.warn('Service worker registration failed', err);
            });
        });
      }

      function escapeHtml(value) {
        return String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function formatDateTime(value) {
        if (!value) {
          return 'â€”';
        }
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return String(value);
        }
        return date.toLocaleString();
      }

      function getPublicBaseUrl() {
        if (!state.settings || !state.settings.app) {
          return '';
        }
        const raw = state.settings.app.publicBaseUrl;
        if (!raw) {
          return '';
        }
        return String(raw).trim().replace(/\/+$/, '');
      }

      function buildShareUrl(link) {
        if (!link || typeof link !== 'object') {
          return '';
        }
        if (link.url) {
          return String(link.url);
        }
        if (link.token) {
          const configuredBase = getPublicBaseUrl();
          const origin = configuredBase || window.location.origin.replace(/\/$/, '');
          return `${origin}/share/${link.token}`;
        }
        return '';
      }

      function toTitleCase(value) {
        const normalized = String(value || '').replace(/_/g, ' ').trim();
        if (!normalized) {
          return 'Unknown';
        }
        return normalized.replace(/\b\w/g, (char) => char.toUpperCase());
      }

      function formatPlanFrequency(frequency) {
        if (!frequency || typeof frequency !== 'object') {
          return '';
        }
        const count = Number(frequency.interval_count || frequency.intervalCount || 0);
        const unitRaw = frequency.interval_unit || frequency.intervalUnit;
        const unit = unitRaw ? String(unitRaw).toLowerCase() : '';
        if (!unit) {
          return count > 0 ? `${count}` : '';
        }
        if (!Number.isFinite(count) || count <= 0) {
          return unit;
        }
        const plural = count === 1 ? unit : `${unit}s`;
        return `${count} ${plural}`;
      }

      function buildPaypalPlanDetails(plan, product) {
        if (!plan || typeof plan !== 'object') {
          return '<p class="plan-error">Unable to display PayPal plan details.</p>';
        }

        const planId = plan.id || '';
        const statusLabel = toTitleCase(plan.status || 'unknown');
        const billingCycles = Array.isArray(plan.billing_cycles)
          ? plan.billing_cycles
          : [];
        const regularCycle =
          billingCycles.find((cycle) => cycle && cycle.tenure_type === 'REGULAR') ||
          billingCycles[0];

        let priceLabel = 'â€”';
        if (
          regularCycle &&
          regularCycle.pricing_scheme &&
          regularCycle.pricing_scheme.fixed_price &&
          regularCycle.pricing_scheme.fixed_price.value != null
        ) {
          const fixed = regularCycle.pricing_scheme.fixed_price;
          const value = String(fixed.value);
          const currency = fixed.currency_code || '';
          priceLabel = `${value} ${currency}`.trim();
        }

        const frequencyLabel = formatPlanFrequency(regularCycle && regularCycle.frequency);
        const cycleLabel =
          priceLabel !== 'â€”' && frequencyLabel
            ? `${priceLabel} every ${frequencyLabel}`
            : priceLabel !== 'â€”'
              ? priceLabel
              : frequencyLabel || 'â€”';

        let productLabel = 'â€”';
        if (product && (product.name || product.id)) {
          if (product.name && (plan.product_id || product.id)) {
            const idLabel = plan.product_id || product.id;
            productLabel = `${escapeHtml(product.name)} (${escapeHtml(idLabel)})`;
          } else {
            productLabel = escapeHtml(product.name || product.id);
          }
        } else if (plan.product_id) {
          productLabel = escapeHtml(plan.product_id);
        }

        const createdAt = plan.create_time
          ? new Date(plan.create_time).toLocaleString()
          : 'â€”';
        const updatedAt = plan.update_time
          ? new Date(plan.update_time).toLocaleString()
          : 'â€”';

        return `
          <dl class="plan-details">
            <div>
              <dt>Plan ID</dt>
              <dd>${escapeHtml(planId)}</dd>
            </div>
            <div>
              <dt>Status</dt>
              <dd>${escapeHtml(statusLabel)}</dd>
            </div>
            <div>
              <dt>Billing cycle</dt>
              <dd>${escapeHtml(cycleLabel)}</dd>
            </div>
            <div>
              <dt>Product</dt>
              <dd>${productLabel}</dd>
            </div>
            <div>
              <dt>Created</dt>
              <dd>${escapeHtml(createdAt)}</dd>
            </div>
            <div>
              <dt>Last updated</dt>
              <dd>${escapeHtml(updatedAt)}</dd>
            </div>
          </dl>
        `;
      }

      async function refreshAdminSession() {
        const response = await fetch(withSessionToken('/api/admin/session'), {
          credentials: 'include',
        });
        const contentType = response.headers.get('content-type') || '';
        const data = contentType.includes('application/json')
          ? await response.json()
          : {};

        if (!response.ok) {
          const error = data.error || 'Failed to refresh session';
          throw new Error(error);
        }

        if (data && data.csrfToken) {
          csrfToken = data.csrfToken;
        }

        updateSessionTokenFromResponse(data);

        state.authenticated = Boolean(data.authenticated);
        if (data.adminUsername) {
          state.adminUsername = data.adminUsername;
        }
        render();

        return data;
      }

      async function api(path, options = {}) {
        const { _retry, ...requestOptions } = options || {};
        const opts = { ...requestOptions };
        opts.credentials = 'include';
        opts.headers = opts.headers ? { ...opts.headers } : {};
        if (opts.body && typeof opts.body !== 'string') {
          opts.headers['Content-Type'] = 'application/json';
          opts.body = JSON.stringify(opts.body);
        }
        if (csrfToken && opts.method && opts.method !== 'GET') {
          opts.headers['X-CSRF-Token'] = csrfToken;
        }
        if (sessionToken) {
          opts.headers['X-Session-Token'] = sessionToken;
        }

        const requestUrl = withSessionToken(path);
        const response = await fetch(requestUrl, opts);
        const contentType = response.headers.get('content-type') || '';
        const data = contentType.includes('application/json')
          ? await response.json()
          : {};

        if (data && data.csrfToken) {
          csrfToken = data.csrfToken;
        }

        updateSessionTokenFromResponse(data);

        if (response.status === 401) {
          state.authenticated = false;
          state.settings = null;
          stopDashboardAutoRefresh();
          setSessionToken(null);
          render();
          throw new Error('Authentication required');
        }

        if (
          response.status === 403 &&
          data &&
          data.error === 'Invalid CSRF token' &&
          !_retry
        ) {
          csrfToken = null;
          try {
            await refreshAdminSession();
          } catch (err) {
            console.error('Failed to recover from CSRF token error', err);
            throw new Error(data.error || 'Invalid CSRF token');
          }
          return api(path, { ...requestOptions, _retry: true });
        }

        if (!response.ok) {
          const error = data.error || 'Request failed';
          throw new Error(error);
        }

        return data;
      }

      async function ensureCsrfToken() {
        if (csrfToken) {
          return csrfToken;
        }
        try {
          const data = await refreshAdminSession();
          csrfToken = data.csrfToken || csrfToken;
          return csrfToken;
        } catch (err) {
          console.error('Failed to refresh CSRF token', err);
          throw err;
        }
      }

      function render() {
        renderAdminAccountPanel();
        renderProspectSharePanel();
        renderShareLinks();
        if (state.authenticated) {
          loginPanel.classList.add('hidden');
          dashboard.classList.remove('hidden');
          logoutButton.classList.remove('hidden');
          setLoginStatus('', '');
          renderSubscribers();
          renderEvents();
          renderSettings();
        } else {
          loginPanel.classList.remove('hidden');
          dashboard.classList.add('hidden');
          logoutButton.classList.add('hidden');
          setLoginStatus('', '');
          if (loginHelp) {
            loginHelp.innerHTML =
              'Use your Plex Donate admin username and password to sign in. The default username is <code>admin</code>. On first run a temporary password is written to your server logs.';
          }
          if (loginUsernameInput && document.activeElement !== loginUsernameInput) {
            loginUsernameInput.value = state.adminUsername || '';
          }
          if (prospectSharePanel) {
            prospectSharePanel.classList.add('hidden');
          }
        }
      }

      function setFormStatus(form, message, stateAttr = '') {
        if (!form) {
          return;
        }
        const statusEl = form.querySelector('.form-status');
        if (!statusEl) {
          return;
        }
        statusEl.textContent = message;
        if (stateAttr) {
          statusEl.dataset.state = stateAttr;
        } else {
          delete statusEl.dataset.state;
        }
        if (stateAttr !== 'success') {
          const existing = statusClearTimers.get(form);
          if (existing) {
            clearTimeout(existing);
            statusClearTimers.delete(form);
          }
        }
      }

      function scheduleStatusClear(form, delay = 3000) {
        if (!form) {
          return;
        }
        const existing = statusClearTimers.get(form);
        if (existing) {
          clearTimeout(existing);
        }
        const timer = setTimeout(() => {
          const statusEl = form.querySelector('.form-status');
          if (statusEl && statusEl.dataset.state === 'success') {
            statusEl.textContent = '';
            delete statusEl.dataset.state;
          }
          statusClearTimers.delete(form);
        }, delay);
        statusClearTimers.set(form, timer);
      }

      function showDashboardToast(message, stateAttr = 'success', duration = 4000) {
        if (!dashboardToast) {
          return;
        }

        if (toastTimerId) {
          clearTimeout(toastTimerId);
          toastTimerId = null;
        }

        if (!message) {
          dashboardToast.textContent = '';
          dashboardToast.hidden = true;
          delete dashboardToast.dataset.state;
          return;
        }

        dashboardToast.textContent = message;
        if (stateAttr) {
          dashboardToast.dataset.state = stateAttr;
        } else {
          delete dashboardToast.dataset.state;
        }
        dashboardToast.hidden = false;

        toastTimerId = setTimeout(() => {
          dashboardToast.textContent = '';
          dashboardToast.hidden = true;
          delete dashboardToast.dataset.state;
          toastTimerId = null;
        }, duration);
      }

      function getFormPayload(form) {
        const payload = {};
        form.querySelectorAll('[name]').forEach((input) => {
          if (input.dataset && input.dataset.transient === 'true') {
            return;
          }
          if (input.type === 'checkbox') {
            payload[input.name] = input.checked;
          } else {
            payload[input.name] = input.value;
          }
        });
        return payload;
      }

      function parseLibraryIdList(value) {
        if (value === undefined || value === null) {
          return [];
        }
        if (Array.isArray(value)) {
          const result = [];
          value.forEach((entry) => {
            result.push(...parseLibraryIdList(entry));
          });
          return result;
        }
        return String(value)
          .split(',')
          .map((entry) => entry.trim())
          .filter((entry) => entry.length > 0);
      }

      function normalizePlexLibraryValue(value, options = {}) {
        const { skipAvailabilityCheck = false } = options;
        const candidates = parseLibraryIdList(value);
        const seen = new Set();
        const normalized = [];
        candidates.forEach((entry) => {
          const id = String(entry).trim();
          if (!id || seen.has(id)) {
            return;
          }
          seen.add(id);
          normalized.push(id);
        });
        if (skipAvailabilityCheck) {
          return normalized;
        }
        if (Array.isArray(state.plexLibraries) && state.plexLibraries.length) {
          const allowed = new Set(
            state.plexLibraries.map((library) => String(library.id))
          );
          return normalized.filter((id) => allowed.has(id));
        }
        return normalized;
      }

      function getPlexLibraryRawSelection() {
        if (!plexLibraryInput) {
          return [];
        }
        const raw = plexLibraryInput.dataset.rawSelection || plexLibraryInput.value;
        return normalizePlexLibraryValue(raw, { skipAvailabilityCheck: true });
      }

      function getPlexLibrarySelection() {
        if (!plexLibraryInput) {
          return [];
        }
        return normalizePlexLibraryValue(plexLibraryInput.value);
      }

      function setPlexLibrarySelection(value, options = {}) {
        if (!plexLibraryInput) {
          return;
        }
        const { skipAvailabilityCheck = false, rawValue } = options;
        const rawSource = rawValue !== undefined ? rawValue : value;
        const normalizedRaw = normalizePlexLibraryValue(rawSource, {
          skipAvailabilityCheck: true,
        });
        plexLibraryInput.dataset.rawSelection = normalizedRaw.join(',');
        const normalized = normalizePlexLibraryValue(value, { skipAvailabilityCheck });
        plexLibraryInput.value = normalized.join(',');
      }

      function updatePlexLibraryToggleState() {
        if (!plexLibraryToggle) {
          return;
        }
        const availableCount = Array.isArray(state.plexLibraries)
          ? state.plexLibraries.length
          : 0;
        if (Array.isArray(state.plexLibraries)) {
          hasCachedPlexLibraries = availableCount > 0;
        }
        const disabled = availableCount === 0 && !hasCachedPlexLibraries;
        plexLibraryToggle.disabled = disabled;
        if (disabled) {
          plexLibraryToggle.setAttribute('aria-expanded', 'false');
          closePlexLibraryDropdown();
        }
      }

      function updatePlexLibraryHelp() {
        if (!plexLibraryHelp) {
          return;
        }
        if (Array.isArray(state.plexLibraries) && state.plexLibraries.length) {
          plexLibraryHelp.textContent =
            'Choose the Plex libraries that new invites should include.';
        } else {
          plexLibraryHelp.textContent =
            'Test the Plex connection to load your server\'s libraries.';
        }
      }

      function updatePlexLibraryToggleLabel() {
        if (!plexLibraryToggle) {
          return;
        }
        const selection = getPlexLibrarySelection();
        const rawSelection = getPlexLibraryRawSelection();
        const hasLoadedLibraries = Array.isArray(state.plexLibraries)
          ? state.plexLibraries.length > 0
          : false;
        const count = hasLoadedLibraries ? selection.length : rawSelection.length;

        if (count === 1) {
          plexLibraryToggle.textContent = '1 library selected';
        } else if (count > 1) {
          plexLibraryToggle.textContent = `${count} libraries selected`;
        } else {
          plexLibraryToggle.textContent = 'Select libraries';
        }
      }

      function updatePlexLibraryOptions() {
        if (!plexLibraryOptions) {
          return;
        }
        plexLibraryOptions.innerHTML = '';
        const libraries = Array.isArray(state.plexLibraries)
          ? state.plexLibraries
          : [];
        const hasLibraries = libraries.length > 0;
        if (plexLibraryEmpty) {
          plexLibraryEmpty.hidden = Array.isArray(state.plexLibraries)
            ? hasLibraries
            : true;
        }
        if (!hasLibraries) {
          return;
        }

        const selected = new Set(getPlexLibrarySelection());
        libraries.forEach((library) => {
          if (!library) {
            return;
          }
          const id = library.id != null ? String(library.id) : '';
          if (!id) {
            return;
          }
          const label = document.createElement('label');
          label.className = 'checkbox-row library-option';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = id;
          checkbox.checked = selected.has(id);
          checkbox.addEventListener('change', () => {
            const rawSelection = new Set(getPlexLibraryRawSelection());
            if (checkbox.checked) {
              rawSelection.add(id);
            } else {
              rawSelection.delete(id);
            }
            const nextSelection = Array.from(rawSelection);
            setPlexLibrarySelection(nextSelection, { rawValue: nextSelection });
            updatePlexLibrarySummary();
            updatePlexLibraryToggleLabel();
          });
          const name = document.createElement('span');
          name.textContent = library.title || 'Unnamed library';
          label.appendChild(checkbox);
          label.appendChild(name);
          plexLibraryOptions.appendChild(label);
        });
      }

      function updatePlexLibrarySummary() {
        if (!plexLibrarySummary) {
          return;
        }
        const rawSelection = getPlexLibraryRawSelection();
        const validatedSelection = getPlexLibrarySelection();
        const librariesLoaded = Array.isArray(state.plexLibraries);
        const hasLibraries = librariesLoaded
          ? state.plexLibraries.length > 0
          : false;
        const missing = rawSelection.filter(
          (id) => !validatedSelection.includes(id)
        );

        if (librariesLoaded && missing.length) {
          plexLibrarySummary.textContent =
            'Some previously selected libraries are no longer available. Test the Plex connection again to refresh the list.';
          plexLibrarySummary.hidden = false;
          return;
        }

        if (!librariesLoaded && rawSelection.length) {
          plexLibrarySummary.textContent =
            'Your saved library selection will appear after testing the Plex connection.';
          plexLibrarySummary.hidden = false;
          return;
        }

        if (librariesLoaded && hasLibraries && validatedSelection.length === 0) {
          plexLibrarySummary.textContent = 'No libraries selected yet.';
          plexLibrarySummary.hidden = false;
          return;
        }

        if (librariesLoaded && validatedSelection.length > 0) {
          const names = validatedSelection
            .map((id) => {
              const match = state.plexLibraries.find(
                (library) => String(library.id) === id
              );
              return match && match.title ? match.title : null;
            })
            .filter(Boolean);

          if (names.length) {
            plexLibrarySummary.textContent = `Selected libraries: ${names.join(', ')}.`;
            plexLibrarySummary.hidden = false;
            return;
          }
        }

        plexLibrarySummary.textContent = '';
        plexLibrarySummary.hidden = true;
      }

      function renderPlexLibrarySelector(options = {}) {
        if (!plexLibraryInput) {
          return;
        }
        const { preserveSelection = false, preferredSelection = null } = options;
        const savedValue =
          state.settings &&
          state.settings.plex &&
          state.settings.plex.librarySectionIds;

        if (!preserveSelection || !plexLibraryInput.value) {
          const initialValue =
            preferredSelection !== null && preferredSelection !== undefined
              ? preferredSelection
              : savedValue || '';
          setPlexLibrarySelection(initialValue, { skipAvailabilityCheck: true });
        } else if (
          preferredSelection !== null &&
          preferredSelection !== undefined
        ) {
          setPlexLibrarySelection(preferredSelection, {
            skipAvailabilityCheck: true,
          });
        }

        if (Array.isArray(state.plexLibraries)) {
          const rawSelection = getPlexLibraryRawSelection();
          setPlexLibrarySelection(rawSelection);
        }

        updatePlexLibraryToggleState();
        updatePlexLibraryHelp();
        if (plexLibraryDropdownOpen || plexLibraryOptionsDirty) {
          updatePlexLibraryOptions();
          plexLibraryOptionsDirty = false;
        }
        updatePlexLibrarySummary();
        updatePlexLibraryToggleLabel();
      }

      let plexLibraryDropdownOpen = false;
      let plexLibraryOptionsDirty = false;
      let hasCachedPlexLibraries = false;

      function closePlexLibraryDropdown(options = {}) {
        if (!plexLibraryDropdown) {
          return;
        }
        plexLibraryDropdown.hidden = true;
        plexLibraryDropdownOpen = false;
        document.removeEventListener('click', handlePlexLibraryDocumentClick, true);
        document.removeEventListener('keydown', handlePlexLibraryKeydown);
        if (options.focusToggle && plexLibraryToggle) {
          plexLibraryToggle.focus();
        }
        if (plexLibraryToggle) {
          plexLibraryToggle.setAttribute('aria-expanded', 'false');
        }
      }

      function openPlexLibraryDropdown() {
        if (!plexLibraryDropdown || !plexLibraryToggle) {
          return;
        }
        if (plexLibraryToggle.disabled) {
          return;
        }
        updatePlexLibraryOptions();
        plexLibraryOptionsDirty = false;
        plexLibraryDropdown.hidden = false;
        plexLibraryDropdownOpen = true;
        plexLibraryToggle.setAttribute('aria-expanded', 'true');
        document.addEventListener('click', handlePlexLibraryDocumentClick, true);
        document.addEventListener('keydown', handlePlexLibraryKeydown);
      }

      function handlePlexLibraryDocumentClick(event) {
        if (!plexLibraryDropdownOpen || !plexLibraryPicker) {
          return;
        }
        if (plexLibraryPicker.contains(event.target)) {
          return;
        }
        closePlexLibraryDropdown();
      }

      function handlePlexLibraryKeydown(event) {
        if (event.key === 'Escape') {
          closePlexLibraryDropdown({ focusToggle: true });
        }
      }

      if (plexLibraryToggle) {
        plexLibraryToggle.addEventListener('click', (event) => {
          event.preventDefault();
          if (plexLibraryToggle.disabled) {
            return;
          }
          if (plexLibraryDropdownOpen) {
            closePlexLibraryDropdown({ focusToggle: true });
          } else {
            openPlexLibraryDropdown();
          }
        });
      }

      if (plexLibraryApplyButton) {
        plexLibraryApplyButton.addEventListener('click', (event) => {
          event.preventDefault();
          closePlexLibraryDropdown({ focusToggle: true });
        });
      }

      if (plexLibraryClearButton) {
        plexLibraryClearButton.addEventListener('click', (event) => {
          event.preventDefault();
          setPlexLibrarySelection([], { rawValue: [] });
          updatePlexLibraryOptions();
          updatePlexLibrarySummary();
          updatePlexLibraryToggleLabel();
        });
      }

      closePlexLibraryDropdown();

      function renderSettings() {
        if (!settingsPanel) {
          return;
        }
        if (state.settings) {
          settingsForms.forEach((form) => {
            const group = form.dataset.group;
            const values = group && state.settings ? state.settings[group] : null;
            form.querySelectorAll('[name]').forEach((input) => {
              if (input.dataset && input.dataset.transient === 'true') {
                return;
              }
              if (input.type === 'checkbox') {
                input.checked = Boolean(values && values[input.name]);
              } else {
                const rawValue = values ? values[input.name] : '';
                input.value = rawValue == null ? '' : String(rawValue);
              }
            });
          });
        }
        renderPlexLibrarySelector({ preserveSelection: false });
        renderPaypalPlan();
      }

      function renderPaypalPlan() {
        if (!paypalPlanSection || !paypalPlanBody) {
          return;
        }

        if (paypalPlanManageLink) {
          if (state.paypalPlanManageUrl) {
            paypalPlanManageLink.href = state.paypalPlanManageUrl;
            paypalPlanManageLink.hidden = false;
          } else {
            paypalPlanManageLink.hidden = true;
          }
        }

        if (state.paypalPlanLoading) {
          paypalPlanBody.classList.remove('empty');
          paypalPlanBody.innerHTML =
            '<p class="plan-loading">Loading PayPal plan detailsâ€¦</p>';
          return;
        }

        if (state.paypalPlanError) {
          paypalPlanBody.classList.remove('empty');
          paypalPlanBody.innerHTML = `<p class="plan-error">${escapeHtml(
            state.paypalPlanError
          )}</p>`;
          return;
        }

        if (!state.paypalPlan) {
          paypalPlanBody.classList.add('empty');
          paypalPlanBody.innerHTML =
            '<p>No PayPal subscription plan has been generated yet.</p>';
          if (paypalPlanManageLink) {
            paypalPlanManageLink.hidden = true;
          }
          return;
        }

        paypalPlanBody.classList.remove('empty');
        paypalPlanBody.innerHTML = buildPaypalPlanDetails(
          state.paypalPlan,
          state.paypalProduct
        );
      }

      function renderProspectSharePanel() {
        if (!prospectSharePanel) {
          return;
        }

        if (!state.authenticated) {
          prospectSharePanel.classList.add('hidden');
          if (prospectShareResult) {
            prospectShareResult.classList.add('hidden');
          }
          if (prospectShareCopy) {
            prospectShareCopy.disabled = true;
          }
          if (prospectShareRegenerate) {
            prospectShareRegenerate.disabled = true;
          }
          return;
        }

        prospectSharePanel.classList.remove('hidden');

        const shareData = state.prospectShare || null;
        const prospect = shareData && shareData.prospect ? shareData.prospect : null;
        const shareLink = shareData && shareData.shareLink ? shareData.shareLink : null;
        const shareUrl = buildShareUrl(shareLink);

        if (prospectShareUrl) {
          if (shareUrl) {
            prospectShareUrl.href = shareUrl;
            prospectShareUrl.textContent = shareUrl;
          } else {
            prospectShareUrl.removeAttribute('href');
            prospectShareUrl.textContent = '';
          }
        }

        if (prospectShareNote) {
          prospectShareNote.textContent =
            prospect && prospect.note ? `Note: ${prospect.note}` : '';
        }

        if (prospectShareSummary) {
          const summaryParts = [];
          if (prospect && prospect.name) {
            summaryParts.push(prospect.name);
          }
          if (prospect && prospect.email) {
            summaryParts.push(prospect.email);
          }
          if (shareUrl) {
            prospectShareSummary.textContent =
              summaryParts.length > 0
                ? `Link ready for ${summaryParts.join(' â€¢ ')}`
                : 'Share this link with your prospective supporter.';
          } else if (summaryParts.length > 0) {
            prospectShareSummary.textContent = `Preparing link for ${summaryParts.join(
              ' â€¢ '
            )}`;
          } else {
            prospectShareSummary.textContent = '';
          }
        }

        if (!shareUrl) {
          if (prospectShareResult) {
            prospectShareResult.classList.add('hidden');
          }
          if (prospectShareCopy) {
            prospectShareCopy.disabled = true;
          }
          if (prospectShareRegenerate) {
            prospectShareRegenerate.disabled = !(prospect && prospect.id);
          }
          return;
        }

        if (prospectShareResult) {
          prospectShareResult.classList.remove('hidden');
        }
        if (prospectShareCopy) {
          prospectShareCopy.disabled = false;
        }
        if (prospectShareRegenerate) {
          prospectShareRegenerate.disabled = false;
        }
      }

      async function generateProspectShareLink({ regenerate = false } = {}) {
        if (!prospectShareForm) {
          return;
        }

        const submitButton = prospectShareForm.querySelector('button[type="submit"]');
        const previousDisabledState = submitButton ? submitButton.disabled : false;

        const formPayload = getFormPayload(prospectShareForm);
        const requestBody = {
          email: (formPayload.email || '').trim(),
          name: (formPayload.name || '').trim(),
          note: (formPayload.note || '').trim(),
        };

        const parsedProspectId = Number.parseInt(formPayload.prospectId, 10);
        if (Number.isFinite(parsedProspectId) && parsedProspectId > 0) {
          requestBody.prospectId = parsedProspectId;
        }
        if (regenerate) {
          requestBody.regenerate = true;
        }

        setFormStatus(
          prospectShareForm,
          regenerate
            ? 'Regenerating invite page linkâ€¦'
            : 'Generating invite page linkâ€¦',
          'info'
        );

        if (submitButton) {
          submitButton.disabled = true;
        }
        if (prospectShareRegenerate) {
          prospectShareRegenerate.disabled = true;
        }
        if (prospectShareCopy) {
          prospectShareCopy.disabled = true;
        }

        try {
          const response = await api('/api/admin/share-links/prospect', {
            method: 'POST',
            body: requestBody,
          });

          const prospect = response.prospect || null;
          const shareLink = response.shareLink || null;
          state.prospectShare = { prospect, shareLink };

          if (prospectShareForm) {
            const emailInput = prospectShareForm.querySelector('[name="email"]');
            if (emailInput) {
              emailInput.value = prospect && prospect.email ? prospect.email : '';
            }
            const nameInput = prospectShareForm.querySelector('[name="name"]');
            if (nameInput) {
              nameInput.value = prospect && prospect.name ? prospect.name : '';
            }
            const noteInput = prospectShareForm.querySelector('[name="note"]');
            if (noteInput) {
              noteInput.value = prospect && prospect.note ? prospect.note : '';
            }
            const idInput = prospectShareForm.querySelector('[name="prospectId"]');
            if (idInput) {
              idInput.value = prospect && prospect.id ? String(prospect.id) : '';
            }
          }

          renderProspectSharePanel();

          await refreshShareLinks();
          renderShareLinks();

          const shareUrl = buildShareUrl(shareLink);
          let copied = false;
          if (shareUrl && navigator.clipboard && navigator.clipboard.writeText) {
            try {
              await navigator.clipboard.writeText(shareUrl);
              copied = true;
            } catch (err) {
              console.warn('Clipboard copy failed', err);
            }
          }

          setFormStatus(
            prospectShareForm,
            copied
              ? 'Invite page link copied to clipboard!'
              : 'Invite page link ready! Use the buttons below to share.',
            'success'
          );
          scheduleStatusClear(prospectShareForm, 4000);
        } catch (err) {
          setFormStatus(prospectShareForm, err.message, 'error');
        } finally {
          if (submitButton) {
            submitButton.disabled = previousDisabledState;
          }
          const hasProspect = Boolean(
            state.prospectShare &&
              state.prospectShare.prospect &&
              state.prospectShare.prospect.id
          );
          const hasShareLink = Boolean(
            buildShareUrl(state.prospectShare && state.prospectShare.shareLink)
          );
          if (prospectShareRegenerate) {
            prospectShareRegenerate.disabled = !hasProspect;
          }
          if (prospectShareCopy) {
            prospectShareCopy.disabled = !hasShareLink;
          }
        }
      }

      function getPlexCredentialSignature(settings) {
        if (!settings || !settings.plex) {
          return null;
        }
        const { baseUrl, token, serverIdentifier } = settings.plex;
        const normalize = (value) => (value == null ? '' : String(value));
        return [
          normalize(baseUrl),
          normalize(token),
          normalize(serverIdentifier),
        ].join('::');
      }

      async function loadSettings() {
        if (!settingsPanel) {
          return;
        }
        try {
          const previousSignature = getPlexCredentialSignature(state.settings);
          const response = await api('/api/admin/settings');
          const nextSettings = response.settings || {};
          const nextSignature = getPlexCredentialSignature(nextSettings);
          const credentialsChanged = previousSignature !== nextSignature;
          state.settings = nextSettings;
          if (credentialsChanged) {
            state.plexLibraries = null;
            hasCachedPlexLibraries = false;
          }
          plexLibraryOptionsDirty = true;
          settingsForms.forEach((form) => setFormStatus(form, ''));
        } catch (err) {
          console.error(err);
        }
      }

      async function loadPaypalPlan() {
        if (!paypalPlanSection) {
          return;
        }

        const paypalSettings =
          state.settings && state.settings.paypal ? state.settings.paypal : null;

        if (!paypalSettings || !paypalSettings.planId) {
          state.paypalPlan = null;
          state.paypalProduct = null;
          state.paypalPlanManageUrl = '';
          state.paypalPlanError = '';
          state.paypalPlanLoading = false;
          renderPaypalPlan();
          return;
        }

        state.paypalPlanLoading = true;
        state.paypalPlanError = '';
        renderPaypalPlan();

        try {
          const response = await api('/api/admin/settings/paypal/plan');
          state.paypalPlan = response.plan || null;
          state.paypalProduct = response.product || null;
          state.paypalPlanManageUrl = response.manageUrl || '';
          state.paypalPlanError = response.error || '';
        } catch (err) {
          state.paypalPlan = null;
          state.paypalProduct = null;
          state.paypalPlanManageUrl = '';
          state.paypalPlanError =
            err.message || 'Unable to load PayPal plan details.';
        } finally {
          state.paypalPlanLoading = false;
          renderPaypalPlan();
        }
      }

      function renderSubscribers() {
        closeSubscriberActionMenu();
        if (plexStatusNote) {
          plexStatusNote.textContent = '';
          plexStatusNote.hidden = true;
          delete plexStatusNote.dataset.state;
          const plexState = state.plex;
          if (plexState) {
            if (!plexState.configured) {
              plexStatusNote.textContent =
                'Configure Plex settings to send invites from this dashboard.';
              plexStatusNote.hidden = false;
            } else if (plexState.error) {
              plexStatusNote.textContent = `Unable to refresh Plex members: ${plexState.error}`;
              plexStatusNote.dataset.state = 'error';
              plexStatusNote.hidden = false;
            }
          }
        }

        const donors = Array.isArray(state.donors) ? state.donors : [];
        subscribersTable.innerHTML = '';
        if (donors.length === 0) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 5;
          cell.textContent = 'No subscribers yet.';
          cell.style.color = 'var(--text-muted-soft)';
          row.appendChild(cell);
          subscribersTable.appendChild(row);
          return;
        }

        const template = document.getElementById('subscriber-row');
        const plexState = state.plex;
        donors.forEach((donor) => {
          const clone = template.content.cloneNode(true);
          const row = clone.querySelector('tr');
          row.dataset.id = donor.id;
          const subscriberCell = clone.querySelector('.col-subscriber');
          const statusPill = clone.querySelector('.status-pill');
          const statusNote = clone.querySelector('.status-note');
          const lastPaymentCell = clone.querySelector('.col-last-payment');
          const inviteCell = clone.querySelector('.col-invite');
          const actionMenu = clone.querySelector('.action-menu');
          const actionMenuToggle = clone.querySelector('[data-menu-toggle]');
          const actionMenuPanel = clone.querySelector('.action-menu-panel');

          if (actionMenu) {
            actionMenu.classList.remove('open');
          }

          if (actionMenuToggle && actionMenuPanel) {
            const baseId = row.dataset.id
              ? `donor-${row.dataset.id}`
              : donor.subscriptionId
              ? `subscription-${donor.subscriptionId}`
              : `donor-${Math.random().toString(36).slice(2)}`;
            const sanitizedId = String(baseId).replace(/[^a-zA-Z0-9_-]/g, '-');
            const toggleId = `subscriber-actions-toggle-${sanitizedId}`;
            const panelId = `subscriber-actions-panel-${sanitizedId}`;
            actionMenuToggle.id = toggleId;
            actionMenuToggle.setAttribute('aria-controls', panelId);
            actionMenuToggle.setAttribute('aria-haspopup', 'menu');
            actionMenuToggle.setAttribute('aria-expanded', 'false');
            actionMenuPanel.id = panelId;
            actionMenuPanel.setAttribute('aria-labelledby', toggleId);
            actionMenuPanel.setAttribute('aria-hidden', 'true');
            actionMenuPanel.hidden = true;
          }

          subscriberCell.innerHTML = `<strong>${donor.name || donor.email || 'Unknown'}</strong><br /><span style="color:var(--text-muted-soft);font-size:0.85rem;">${donor.email || 'â€”'}<br/>Sub ID: ${donor.subscriptionId}</span>`;

          const status = (donor.status || 'pending').toLowerCase();
          statusPill.dataset.status = status;
          statusPill.textContent = status.replace(/_/g, ' ');

          if (statusNote) {
            const refreshError =
              typeof donor.paypalRefreshError === 'string'
                ? donor.paypalRefreshError.trim()
                : '';
            if (refreshError) {
              statusNote.textContent = refreshError;
              statusNote.hidden = false;
            } else {
              statusNote.textContent = '';
              statusNote.hidden = true;
            }
          }

          if (donor.lastPaymentAt) {
            const date = new Date(donor.lastPaymentAt);
            lastPaymentCell.innerHTML = `${date.toLocaleString()}<br /><span class="badge">${formatAmount(donor)}</span>`;
          } else {
            lastPaymentCell.textContent = 'â€”';
          }

          const invites = Array.isArray(donor.invites) ? donor.invites : [];
          const inviteParts = [];
          if (donor.plexShareState === 'shared') {
            inviteParts.push(
              '<span class="badge badge-visited" title="This subscriber already has Plex access.">Plex shared</span>'
            );
          } else if (donor.plexShareState === 'pending') {
            inviteParts.push(
              '<span class="badge badge-note" title="A Plex invite is pending acceptance.">Plex invite pending</span>'
            );
          } else if (donor.needsPlexInvite) {
            inviteParts.push(
              '<span class="badge badge-revoked" title="Send a Plex invite to grant access.">Needs Plex invite</span>'
            );
          }
          if (invites.length > 0) {
            const invite = invites[0];
            if (invite.inviteUrl) {
              inviteParts.push(`<a href="${invite.inviteUrl}" target="_blank" rel="noopener">Invite link</a>`);
            }
            if (invite.recipientEmail) {
              inviteParts.push(
                `<span class="badge badge-note">For ${escapeHtml(
                  invite.recipientEmail
                )}</span>`
              );
            }
            if (invite.emailSentAt) {
              const date = new Date(invite.emailSentAt);
              inviteParts.push(`<span class="badge">Emailed ${date.toLocaleDateString()}</span>`);
            }
            if (invite.revokedAt) {
              const date = new Date(invite.revokedAt);
              inviteParts.push(`<span class="badge badge-revoked">Revoked ${date.toLocaleDateString()}</span>`);
            }
          }

          const shareUrl = buildShareUrl(donor.shareLink);
          if (shareUrl) {
            inviteParts.push(
              `<a href="${shareUrl}" target="_blank" rel="noopener">Share page</a>`
            );
            if (donor.shareLink.lastUsedAt) {
              const usedDate = new Date(donor.shareLink.lastUsedAt);
              inviteParts.push(
                `<span class="badge badge-visited">Visited ${usedDate.toLocaleDateString()}</span>`
              );
            }
          }

          const activeInvite = invites.find((invite) => !invite.revokedAt);
          const inviteButton = clone.querySelector('button[data-action="invite"]');
          const shareButton = clone.querySelector('button[data-action="share"]');
          const shareGenerateButton = clone.querySelector(
            'button[data-action="share-generate"]'
          );
          const resendButton = clone.querySelector('button[data-action="resend"]');
          const revokeButton = clone.querySelector('button[data-action="revoke"]');
          const removeButton = clone.querySelector('button[data-action="remove"]');

          const hasShareUrl = Boolean(shareUrl);

          if (inviteButton) {
            const canInvite = Boolean(donor.needsPlexInvite);
            inviteButton.disabled = !canInvite;
            let inviteTitle = '';
            if (!plexState || plexState.configured === false) {
              inviteTitle = 'Configure Plex settings to send invites.';
            } else if (!donor.email) {
              inviteTitle = 'Add an email address to send a Plex invite.';
            } else if (donor.plexShared) {
              inviteTitle = 'Subscriber already has Plex access.';
            } else if (donor.plexPending) {
              inviteTitle = 'A Plex invite has already been sent and is pending acceptance.';
            } else if (canInvite) {
              inviteTitle = 'Send a Plex invite to this subscriber.';
            } else {
              inviteTitle = 'Plex invite is not available for this subscriber right now.';
            }
            inviteButton.title = inviteTitle;
          }

          if (shareButton) {
            shareButton.disabled = !hasShareUrl;
            shareButton.title = hasShareUrl
              ? 'Copy the existing invite page link'
              : 'Generate an invite page link first';
          }

          if (shareGenerateButton) {
            shareGenerateButton.title = 'Generate a new invite page link';
          }

          if (resendButton) {
            const canResend = Boolean(activeInvite && activeInvite.inviteUrl);
            resendButton.disabled = !canResend;
            resendButton.title = canResend
              ? 'Resend the most recent invite email'
              : 'No active invite available to resend';
          }

          if (revokeButton) {
            const canRevoke = Boolean(activeInvite);
            revokeButton.disabled = !canRevoke;
            revokeButton.title = canRevoke
              ? 'Revoke the most recent active invite'
              : 'No active invite available to revoke';
          }

          if (removeButton) {
            removeButton.title = 'Remove this subscriber and all related records';
          }

          if (inviteParts.length > 0) {
            inviteCell.innerHTML = inviteParts.join('<br />');
          } else {
            inviteCell.textContent = 'â€”';
          }

          subscribersTable.appendChild(clone);
        });
      }

      function formatAmount(donor) {
        const payment = donor.payments && donor.payments[0];
        if (!payment || !payment.amount) {
          return 'No payment recorded';
        }
        return `${payment.amount} ${payment.currency || ''}`.trim();
      }

      function renderEvents() {
        eventsList.innerHTML = '';
        const eventsToShow = Array.isArray(state.events)
          ? state.events.slice(0, 8)
          : [];
        if (eventsToShow.length === 0) {
          const li = document.createElement('li');
          li.textContent = 'No events yet.';
          eventsList.appendChild(li);
          return;
        }
        eventsToShow.forEach((event) => {
          const li = document.createElement('li');
          const payload = (() => {
            try {
              return JSON.stringify(JSON.parse(event.payload), null, 2);
            } catch (e) {
              return event.payload;
            }
          })();
          li.innerHTML = `<time>${new Date(event.createdAt).toLocaleString()}</time><strong>${event.eventType}</strong><pre class="event-payload">${payload}</pre>`;
        eventsList.appendChild(li);
      });
    }

    async function refreshShareLinks() {
      if (!state.authenticated) {
        state.shareLinks = [];
        return;
      }
      try {
        const response = await api('/api/admin/share-links');
        state.shareLinks = response.shareLinks || [];
      } catch (err) {
        console.error(err);
        state.shareLinks = [];
      }
    }

    function renderAdminAccountPanel() {
      if (!adminAccountPanel) {
        return;
      }
      if (!state.authenticated) {
        adminAccountPanel.classList.add('hidden');
        if (adminCredentialsForm) {
          adminCredentialsForm.reset();
        }
        if (adminAccountDescription) {
          adminAccountDescription.textContent =
            'Update the username and password used to access this dashboard. Password changes require at least 12 characters.';
        }
        return;
      }

      adminAccountPanel.classList.remove('hidden');

      if (adminAccountDescription) {
        adminAccountDescription.textContent =
          'Update the username and password used to access this dashboard. Password changes require at least 12 characters.';
      }

      if (adminCredentialsForm) {
        const usernameInput = adminCredentialsForm.querySelector("input[name='username']");
        if (usernameInput && document.activeElement !== usernameInput) {
          usernameInput.value = state.adminUsername || '';
        }

        adminCredentialsForm.querySelectorAll('input').forEach((input) => {
          input.disabled = false;
        });
      }
    }

    async function loadAdminAccount() {
      if (!state.authenticated) {
        return;
      }
      try {
        const response = await api('/api/admin/account');
        if (response && response.username) {
          state.adminUsername = response.username;
        }
      } catch (err) {
        console.error('Failed to load admin account details', err);
      }
    }

    async function loadDashboardData() {
      if (dashboardDataPromise) {
        return dashboardDataPromise;
      }

      dashboardDataPromise = (async () => {
        try {
          await loadAdminAccount();
          try {
            const donorsResponse = await api('/api/admin/subscribers');
            const previousErrors = new Map(
              (Array.isArray(state.donors) ? state.donors : []).map((existing) => [
                String(existing.id),
                typeof existing.paypalRefreshError === 'string'
                  ? existing.paypalRefreshError
                  : '',
              ])
            );
            const donorsFromApi = Array.isArray(donorsResponse.donors)
              ? donorsResponse.donors.map((donor) => {
                  const normalizedError =
                    typeof donor.paypalRefreshError === 'string'
                      ? donor.paypalRefreshError
                      : '';
                  const normalizedStatus = (donor.status || '').toLowerCase();
                  const fallbackError = previousErrors.get(String(donor.id)) || '';
                  const effectiveError = normalizedError
                    ? normalizedError
                    : normalizedStatus === 'active'
                    ? ''
                    : fallbackError;
                  return {
                    ...donor,
                    paypalRefreshError: effectiveError,
                  };
                })
              : [];
            state.donors = donorsFromApi;
            state.plex = donorsResponse.plex || null;
          } catch (err) {
            console.error(err);
            state.donors = [];
            state.plex = null;
          }
          try {
            const eventsResponse = await api('/api/admin/events');
            state.events = eventsResponse.events || [];
          } catch (err) {
            console.error(err);
          }
          await loadSettings();
          await loadPaypalPlan();
          await refreshShareLinks();
        } finally {
          try {
            render();
          } finally {
            dashboardDataPromise = null;
          }
        }
      })();

      return dashboardDataPromise;
    }

    async function handleManualRefresh() {
      if (refreshButton) {
        refreshButton.disabled = true;
      }
      try {
        await loadDashboardData();
      } catch (err) {
        console.error(err);
      } finally {
        if (refreshButton) {
          refreshButton.disabled = false;
        }
      }
    }

      async function checkSession() {
      try {
        const data = await api('/api/admin/session');
        csrfToken = data.csrfToken;
        state.authenticated = data.authenticated;
        if (data.adminUsername) {
          state.adminUsername = data.adminUsername;
        } else if (!state.authenticated && !state.adminUsername) {
          state.adminUsername = 'admin';
        }
          if (state.authenticated) {
            await loadDashboardData();
            startDashboardAutoRefresh();
          } else {
            stopDashboardAutoRefresh();
            state.settings = null;
            state.paypalPlan = null;
            state.paypalProduct = null;
            state.paypalPlanError = '';
            state.paypalPlanManageUrl = '';
            state.paypalPlanLoading = false;
            state.prospectShare = null;
            render();
          }
        } catch (err) {
          console.error(err);
        }
      }

      function renderShareLinks() {
        if (!shareLinksPanel || !shareLinksTable) {
          return;
        }

        const links = Array.isArray(state.shareLinks) ? state.shareLinks : [];

        if (!state.authenticated) {
          shareLinksPanel.classList.add('hidden');
          shareLinksTable.innerHTML = '';
          return;
        }

        shareLinksPanel.classList.remove('hidden');
        shareLinksTable.innerHTML = '';

        if (links.length === 0) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 5;
          cell.textContent = 'No invite page links yet.';
          cell.style.color = 'var(--text-muted-soft)';
          row.appendChild(cell);
          shareLinksTable.appendChild(row);
          return;
        }

        const template = document.getElementById('share-link-row');
        if (!template) {
          return;
        }

        links.forEach((link) => {
          const clone = template.content.cloneNode(true);
          const row = clone.querySelector('tr');
          row.dataset.id = link.id;
          const linkCell = clone.querySelector('.col-link');
          const ownerCell = clone.querySelector('.col-owner');
          const createdCell = clone.querySelector('.col-created');
          const lastUsedCell = clone.querySelector('.col-last-used');

          const shareUrl = buildShareUrl(link);
          linkCell.innerHTML = '';
          if (shareUrl) {
            const openButton = document.createElement('button');
            openButton.type = 'button';
            openButton.className = 'secondary link-open-button';
            openButton.dataset.action = 'open';
            openButton.textContent = 'Open invite page';
            openButton.title = shareUrl;
            linkCell.appendChild(openButton);
          } else {
            linkCell.textContent = 'Pending link configuration';
          }

          const ownerName = (() => {
            if (link.donor) {
              return link.donor.name || link.donor.email || 'Subscriber';
            }
            if (link.prospect) {
              return link.prospect.name || link.prospect.email || 'Prospect';
            }
            return 'Unknown';
          })();

          const ownerMeta = [];
          const typeLabel = link.donor
            ? 'Subscriber'
            : link.prospect
            ? 'Prospect'
            : 'Unassigned';
          ownerMeta.push(escapeHtml(typeLabel));
          if (link.donor && link.donor.email) {
            ownerMeta.push(escapeHtml(link.donor.email));
          } else if (link.prospect && link.prospect.email) {
            ownerMeta.push(escapeHtml(link.prospect.email));
          }
          if (link.donor && link.donor.subscriptionId) {
            ownerMeta.push(
              escapeHtml(`Sub ID: ${link.donor.subscriptionId}`)
            );
          }
          if (link.donor && link.donor.status) {
            ownerMeta.push(
              escapeHtml(
                `Status: ${link.donor.status.replace(/_/g, ' ')}`
              )
            );
          }

          ownerCell.innerHTML = `<strong>${escapeHtml(
            ownerName
          )}</strong><br /><span class="subtle-text">${ownerMeta.join(
            ' â€¢ '
          )}</span>`;

          createdCell.textContent = formatDateTime(link.createdAt);
          lastUsedCell.textContent = link.lastUsedAt
            ? formatDateTime(link.lastUsedAt)
            : 'â€”';

          shareLinksTable.appendChild(clone);
        });
      }

      if (togglePasswordVisibilityButton && loginPasswordInput) {
        togglePasswordVisibilityButton.addEventListener('click', () => {
          const shouldReveal = loginPasswordInput.type === 'password';
          loginPasswordInput.type = shouldReveal ? 'text' : 'password';
          togglePasswordVisibilityButton.textContent = shouldReveal ? 'Hide' : 'Show';
          togglePasswordVisibilityButton.setAttribute('aria-pressed', shouldReveal ? 'true' : 'false');
        });
      }

      if (loginForm) {
        loginForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!loginUsernameInput || !loginPasswordInput) {
            return;
          }
          const username = loginUsernameInput.value.trim();
          const password = loginPasswordInput.value;
          if (!username) {
            setLoginStatus('Username is required', 'error');
            return;
          }
          if (!password) {
            setLoginStatus('Password is required', 'error');
            return;
          }
          setLoginStatus('Signing inâ€¦');
          if (loginSubmitButton) {
            loginSubmitButton.disabled = true;
          }
          try {
            await ensureCsrfToken();
            const response = await api('/api/admin/login', {
              method: 'POST',
              body: { username, password },
            });
            csrfToken = response.csrfToken;
            state.authenticated = true;
            state.adminUsername = response.adminUsername || username;
            loginPasswordInput.value = '';
            await loadDashboardData();
            startDashboardAutoRefresh();
            setLoginStatus('');
          } catch (err) {
            setLoginStatus(err.message || 'Sign in failed', 'error');
          } finally {
            if (loginSubmitButton) {
              loginSubmitButton.disabled = false;
            }
          }
        });
      }

      logoutButton.addEventListener('click', async () => {
        try {
          await api('/api/admin/logout', { method: 'POST' });
        } finally {
          stopDashboardAutoRefresh();
          setSessionToken(null);
          state.authenticated = false;
          state.donors = [];
          state.shareLinks = [];
          state.events = [];
          state.settings = null;
          state.paypalPlan = null;
          state.paypalProduct = null;
          state.paypalPlanError = '';
          state.paypalPlanManageUrl = '';
          state.paypalPlanLoading = false;
          state.prospectShare = null;
          state.adminUsername = 'admin';
          render();
        }
      });

      refreshButton.addEventListener('click', handleManualRefresh);

      if (prospectShareForm) {
        prospectShareForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          await generateProspectShareLink({ regenerate: false });
        });
      }

      if (adminCredentialsForm) {
        adminCredentialsForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const usernameInput = adminCredentialsForm.querySelector("input[name='username']");
          const currentPasswordInput = adminCredentialsForm.querySelector(
            "input[name='currentPassword']"
          );
          const newPasswordInput = adminCredentialsForm.querySelector("input[name='newPassword']");
          const confirmPasswordInput = adminCredentialsForm.querySelector(
            "input[name='confirmPassword']"
          );

          const username = usernameInput ? usernameInput.value.trim() : '';
          const currentPassword = currentPasswordInput ? currentPasswordInput.value : '';
          const newPassword = newPasswordInput ? newPasswordInput.value : '';
          const confirmPassword = confirmPasswordInput ? confirmPasswordInput.value : '';

          if (!currentPassword) {
            setFormStatus(adminCredentialsForm, 'Current password is required.', 'error');
            return;
          }

          if (newPassword || confirmPassword) {
            if (newPassword !== confirmPassword) {
              setFormStatus(adminCredentialsForm, 'New passwords do not match.', 'error');
              return;
            }
            if (newPassword.trim().length < 12) {
              setFormStatus(
                adminCredentialsForm,
                'New password must be at least 12 characters long.',
                'error'
              );
              return;
            }
          }

          setFormStatus(adminCredentialsForm, 'Savingâ€¦', 'pending');
          const submitButton = adminCredentialsForm.querySelector("button[type='submit']");
          if (submitButton) {
            submitButton.disabled = true;
          }

          const payload = {
            currentPassword,
          };
          if (username) {
            payload.username = username;
          }
          if (newPassword) {
            payload.newPassword = newPassword;
            payload.confirmPassword = confirmPassword;
          }

          try {
            const response = await api('/api/admin/account', {
              method: 'PUT',
              body: payload,
            });
            if (response && response.username) {
              state.adminUsername = response.username;
            }
            setFormStatus(adminCredentialsForm, 'Admin credentials updated.', 'success');
            scheduleStatusClear(adminCredentialsForm, 4000);
            if (currentPasswordInput) {
              currentPasswordInput.value = '';
            }
            if (newPasswordInput) {
              newPasswordInput.value = '';
            }
            if (confirmPasswordInput) {
              confirmPasswordInput.value = '';
            }
          } catch (err) {
            setFormStatus(
              adminCredentialsForm,
              err && err.message ? err.message : 'Failed to update admin credentials.',
              'error'
            );
          } finally {
            if (submitButton) {
              submitButton.disabled = false;
            }
            renderAdminAccountPanel();
          }
        });
      }

      if (prospectShareRegenerate) {
        prospectShareRegenerate.addEventListener('click', async () => {
          await generateProspectShareLink({ regenerate: true });
        });
      }

      if (prospectShareCopy) {
        prospectShareCopy.addEventListener('click', async () => {
          const shareLink = state.prospectShare ? state.prospectShare.shareLink : null;
          const shareUrl = buildShareUrl(shareLink);
          if (!shareUrl) {
            return;
          }
          let copied = false;
          if (navigator.clipboard && navigator.clipboard.writeText) {
            try {
              await navigator.clipboard.writeText(shareUrl);
              copied = true;
            } catch (err) {
              console.warn('Clipboard copy failed', err);
            }
          }
          if (copied) {
            setFormStatus(prospectShareForm, 'Invite page link copied to clipboard!', 'success');
            scheduleStatusClear(prospectShareForm, 4000);
          } else {
            window.prompt(
              'Copy this invite page link and share it with your supporter:',
              shareUrl
            );
          }
        });
      }

      if (prospectShareReset) {
        prospectShareReset.addEventListener('click', () => {
          if (!prospectShareForm) {
            return;
          }
          prospectShareForm.reset();
          const idInput = prospectShareForm.querySelector('[name="prospectId"]');
          if (idInput) {
            idInput.value = '';
          }
          state.prospectShare = null;
          if (prospectShareResult) {
            prospectShareResult.classList.add('hidden');
          }
          if (prospectShareCopy) {
            prospectShareCopy.disabled = true;
          }
          if (prospectShareRegenerate) {
            prospectShareRegenerate.disabled = true;
          }
          if (prospectShareSummary) {
            prospectShareSummary.textContent = '';
          }
          if (prospectShareNote) {
            prospectShareNote.textContent = '';
          }
          setFormStatus(prospectShareForm, '');
          renderProspectSharePanel();
        });
      }

      settingsForms.forEach((form) => {
        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          const group = form.dataset.group;
          if (!group) {
            return;
          }
          const payload = getFormPayload(form);
          const submitButton = form.querySelector("button[type='submit']");
          try {
            if (submitButton) {
              submitButton.disabled = true;
            }
            setFormStatus(form, 'Savingâ€¦');
            const response = await api(`/api/admin/settings/${group}`, {
              method: 'PUT',
              body: payload,
            });
            if (!state.settings) {
              state.settings = {};
            }
            state.settings[group] = response.settings || {};
            if (group === 'paypal') {
              await loadPaypalPlan();
            }
            renderSettings();
            setFormStatus(form, 'Saved!', 'success');
            scheduleStatusClear(form);
          } catch (err) {
            setFormStatus(form, err.message || 'Failed to save settings', 'error');
          } finally {
            if (submitButton) {
              submitButton.disabled = false;
            }
          }
        });

        form.addEventListener('click', async (event) => {
          const button = event.target.closest('button[data-action]');
          if (!button) {
            return;
          }
          const action = button.dataset.action;
          if (!action) {
            return;
          }
          event.preventDefault();
          const group = form.dataset.group;
          if (!group) {
            return;
          }

          if (action === 'test') {
            const payload = getFormPayload(form);
            const previousDisabledState = button.disabled;
            try {
              button.disabled = true;
              setFormStatus(form, 'Testingâ€¦');
              const response = await api(`/api/admin/settings/${group}/test`, {
                method: 'POST',
                body: payload,
              });
              const result = response.result || {};
              const message =
                result.message ||
                response.message ||
                'Settings test completed successfully.';
              setFormStatus(form, message, 'success');
              if (group === 'plex') {
                if (Array.isArray(result.libraries)) {
                  state.plexLibraries = result.libraries
                    .map((library) => ({
                      id:
                        library && library.id != null
                          ? String(library.id)
                          : '',
                      title:
                        library && library.title
                          ? String(library.title)
                          : '',
                    }))
                    .filter((library) => library.id);
                  hasCachedPlexLibraries = state.plexLibraries.length > 0;
                  plexLibraryOptionsDirty = true;
                }
                const preferredSelection =
                  result.details && result.details.librarySectionIds
                    ? result.details.librarySectionIds
                    : null;
                renderPlexLibrarySelector({
                  preserveSelection: true,
                  preferredSelection,
                });
              }
              scheduleStatusClear(form);
            } catch (err) {
              setFormStatus(
                form,
                err.message || 'Failed to verify settings',
                'error'
              );
            } finally {
              button.disabled = previousDisabledState;
            }
            return;
          }

          if (action === 'test-invite') {
            if (group !== 'plex') {
              return;
            }

            const emailInput = form.querySelector('[data-test-field="invite-email"]');
            const emailValue = emailInput ? emailInput.value.trim() : '';
            const passwordInput = form.querySelector(
              '[data-test-field="invite-password"]'
            );
            const passwordValue = passwordInput ? passwordInput.value : '';
            if (!emailValue) {
              setFormStatus(
                form,
                'Enter an email address to send a test invite.',
                'error'
              );
              if (emailInput) {
                emailInput.focus();
              }
              return;
            }

            if (!passwordValue) {
              setFormStatus(
                form,
                'Enter the Plex password for the test invite email.',
                'error'
              );
              if (passwordInput) {
                passwordInput.focus();
              }
              return;
            }

            const payload = getFormPayload(form);
            const requestBody = {
              email: emailValue,
              password: passwordValue,
              overrides: payload,
            };

            const previousDisabledState = button.disabled;
            try {
              button.disabled = true;
              setFormStatus(form, 'Sending test inviteâ€¦');
              const response = await api('/api/admin/settings/plex/test-invite', {
                method: 'POST',
                body: requestBody,
              });
              const message =
                response.message ||
                `Test invite sent to ${emailValue}. Check your inbox for the Plex invite.`;
              setFormStatus(form, message, 'success');
              scheduleStatusClear(form, 5000);
            } catch (err) {
              setFormStatus(
                form,
                err.message || 'Failed to send test invite',
                'error'
              );
            } finally {
              button.disabled = previousDisabledState;
              if (passwordInput) {
                passwordInput.value = '';
              }
            }
            return;
          }

        });
      });

      subscribersTable.addEventListener('click', async (event) => {
        const toggle = event.target.closest('[data-menu-toggle]');
        if (toggle) {
          const menu = toggle.closest('.action-menu');
          toggleSubscriberActionMenu(menu);
          return;
        }

        const button = event.target.closest('button[data-action]');
        if (!button) return;
        const row = event.target.closest('tr');
        const donorId = row && row.dataset.id;
        if (!donorId) return;
        const action = button.dataset.action;
        const menu = button.closest('.action-menu');
        if (menu) {
          closeSubscriberActionMenu(menu);
        }
        button.disabled = true;
        let requiresReload = true;
        try {
          if (action === 'invite') {
            requiresReload = false;
            const response = await api(`/api/admin/subscribers/${donorId}/invite`, {
              method: 'POST',
            });
            if (response && response.plex) {
              state.plex = response.plex;
            }
            if (response && response.donor) {
              const donors = Array.isArray(state.donors) ? [...state.donors] : [];
              const index = donors.findIndex(
                (item) => String(item.id) === String(response.donor.id)
              );
              if (index !== -1) {
                donors[index] = { ...donors[index], ...response.donor };
              } else {
                donors.push(response.donor);
              }
              state.donors = donors;
            } else {
              requiresReload = true;
            }
            const successMessage =
              (response && response.message) || 'Plex invite created successfully.';
            showDashboardToast(successMessage, 'success');
          } else if (action === 'share' || action === 'share-generate') {
            const regenerate = action === 'share-generate' ? true : event.shiftKey;
            const options = { method: 'POST' };
            if (regenerate) {
              options.body = { regenerate: true };
            }
            const response = await api(
              `/api/admin/subscribers/${donorId}/share-link`,
              options
            );
            const shareLink = response.shareLink || {};
            const configuredBase = getPublicBaseUrl();
            const origin =
              configuredBase || window.location.origin.replace(/\/$/, '');
            const shareUrl =
              shareLink.url ||
              (shareLink.token ? `${origin}/share/${shareLink.token}` : '');
            if (!shareUrl) {
              throw new Error('Unable to determine invite page URL');
            }
            let copied = false;
            if (navigator.clipboard && navigator.clipboard.writeText) {
              try {
                await navigator.clipboard.writeText(shareUrl);
                copied = true;
              } catch (err) {
                console.warn('Clipboard copy failed', err);
              }
            }
            if (copied) {
              alert(
                action === 'share-generate'
                  ? 'New invite page link generated and copied to clipboard.'
                  : regenerate
                    ? 'Invite page link regenerated and copied to clipboard.'
                    : 'Invite page link copied to clipboard.'
              );
            } else {
              const promptMessage =
                action === 'share-generate'
                  ? 'New invite page link generated. Share this link with the subscriber:'
                  : 'Share this invite page link with the subscriber:';
              window.prompt(promptMessage, shareUrl);
            }
          } else if (action === 'refresh') {
            requiresReload = false;
            const response = await api(`/api/admin/subscribers/${donorId}/refresh`, {
              method: 'POST',
            });
            const normalizedError =
              typeof response.error === 'string' ? response.error : '';
            const donors = Array.isArray(state.donors) ? [...state.donors] : [];
            const index = donors.findIndex(
              (item) => String(item.id) === String(donorId)
            );
            if (index !== -1) {
              const updatedDonor = response.donor || null;
              donors[index] = {
                ...donors[index],
                ...(updatedDonor || {}),
                paypalRefreshError: normalizedError,
              };
            }
            state.donors = donors;
          } else if (action === 'resend') {
            await api(`/api/admin/subscribers/${donorId}/email`, { method: 'POST' });
          } else if (action === 'revoke') {
            if (!confirm('Revoke the latest invite for this subscriber?')) {
              return;
            }
            await api(`/api/admin/subscribers/${donorId}/revoke`, { method: 'POST' });
          } else if (action === 'remove') {
            const confirmation = confirm(
              'Remove this subscriber and delete all related invites, payments, and share links?'
            );
            if (!confirmation) {
              return;
            }
            await api(`/api/admin/subscribers/${donorId}`, { method: 'DELETE' });
          }
          if (requiresReload) {
            await loadDashboardData();
          } else {
            render();
          }
        } catch (err) {
          console.error(err);
          showDashboardToast(err.message || 'Action failed', 'error', 6000);
        } finally {
          button.disabled = false;
        }
      });

      if (shareLinksTable) {
        shareLinksTable.addEventListener('click', async (event) => {
          const button = event.target.closest('button[data-action]');
          if (!button) {
            return;
          }
          const row = event.target.closest('tr');
          const linkId = row && row.dataset.id;
          if (!linkId) {
            return;
          }
          const action = button.dataset.action;
          const links = Array.isArray(state.shareLinks) ? state.shareLinks : [];
          const link = links.find((item) => String(item.id) === String(linkId));
          if (!link) {
            alert('Unable to locate this invite link.');
            return;
          }

          if (action === 'open') {
            const shareUrl = buildShareUrl(link);
            if (!shareUrl) {
              alert('This invite link does not have a shareable URL yet.');
              return;
            }
            const newWindow = window.open(shareUrl, '_blank', 'noopener');
            if (newWindow) {
              newWindow.opener = null;
            } else {
              window.location.href = shareUrl;
            }
            return;
          }

          if (action === 'copy') {
            const shareUrl = buildShareUrl(link);
            if (!shareUrl) {
              alert('This invite link does not have a shareable URL yet.');
              return;
            }
            let copied = false;
            if (navigator.clipboard && navigator.clipboard.writeText) {
              try {
                await navigator.clipboard.writeText(shareUrl);
                copied = true;
              } catch (err) {
                console.warn('Clipboard copy failed', err);
              }
            }
            if (copied) {
              alert('Invite link copied to clipboard.');
            } else {
              window.prompt('Copy this invite page URL:', shareUrl);
            }
            return;
          }

          if (action === 'remove') {
            const confirmation = confirm(
              'Remove this invite link? Anyone with the URL will lose access.'
            );
            if (!confirmation) {
              return;
            }
            const previousDisabledState = button.disabled;
            try {
              button.disabled = true;
              await api(`/api/admin/share-links/${linkId}`, { method: 'DELETE' });
              await refreshShareLinks();
              renderShareLinks();
            } catch (err) {
              alert(err.message);
            } finally {
              button.disabled = previousDisabledState;
            }
          }
        });
      }

      document.addEventListener('click', (event) => {
        if (!openSubscriberActionMenu) {
          return;
        }
        if (event.target.closest('.action-menu') === openSubscriberActionMenu) {
          return;
        }
        closeSubscriberActionMenu();
      });

      document.addEventListener('focusin', (event) => {
        if (!openSubscriberActionMenu) {
          return;
        }
        if (event.target.closest('.action-menu') === openSubscriberActionMenu) {
          return;
        }
        closeSubscriberActionMenu();
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && openSubscriberActionMenu) {
          closeSubscriberActionMenu(null, { focusToggle: true });
        }
      });

      registerServiceWorker();
      checkSession();
    </script>
  </body>
</html>
