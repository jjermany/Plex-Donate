<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#f8fafc" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <title>Plex Donate Admin</title>
    <script>
      (() => {
        try {
          const stored = localStorage.getItem('plexDonateTheme');
          const prefersDark =
            window.matchMedia &&
            window.matchMedia('(prefers-color-scheme: dark)').matches;
          const theme =
            stored === 'dark' || stored === 'light'
              ? stored
              : prefersDark
                ? 'dark'
                : 'light';
          document.documentElement.dataset.theme = theme;
          const meta = document.querySelector('meta[name="theme-color"]');
          if (meta) {
            meta.setAttribute('content', theme === 'dark' ? '#0f172a' : '#f8fafc');
          }
        } catch (err) {
          document.documentElement.dataset.theme = 'light';
        }
      })();
    </script>
    <style>
      :root {
        color-scheme: light;
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: var(--page-background);
        color: var(--text-primary);
        --page-background: #f8fafc;
        --background-gradient: linear-gradient(180deg, #eef2ff 0%, #f8fafc 100%);
        --text-primary: #0f172a;
        --text-muted: #475569;
        --text-muted-soft: #64748b;
        --panel-background: rgba(255, 255, 255, 0.88);
        --panel-border-color: rgba(148, 163, 184, 0.18);
        --panel-shadow: 0 25px 50px -12px rgba(30, 64, 175, 0.2);
        --input-border: #c7d2fe;
        --input-background: rgba(255, 255, 255, 0.7);
        --table-border: rgba(148, 163, 184, 0.3);
        --table-hover: rgba(99, 102, 241, 0.08);
        --settings-divider: rgba(148, 163, 184, 0.25);
        --events-time-color: #64748b;
        --event-payload-bg: #f1f5f9;
        --badge-bg: rgba(79, 70, 229, 0.12);
        --badge-color: #4f46e5;
        --badge-note-bg: rgba(99, 102, 241, 0.16);
        --badge-note-color: #4338ca;
        --badge-revoked-bg: rgba(248, 113, 113, 0.15);
        --badge-revoked-color: #b91c1c;
        --badge-visited-bg: rgba(34, 197, 94, 0.12);
        --badge-visited-color: #15803d;
        --status-active-bg: rgba(34, 197, 94, 0.15);
        --status-active-color: #15803d;
        --status-pending-bg: rgba(59, 130, 246, 0.15);
        --status-pending-color: #1d4ed8;
        --status-danger-bg: rgba(248, 113, 113, 0.18);
        --status-danger-color: #b91c1c;
        --status-message-color: #b91c1c;
        --form-status: #64748b;
        --form-status-error: #b91c1c;
        --form-status-success: #15803d;
        --button-primary-bg: #6366f1;
        --button-primary-color: #ffffff;
        --button-primary-shadow: 0 6px 12px rgba(79, 70, 229, 0.2);
        --button-secondary-bg: #e2e8f0;
        --button-secondary-color: #1e293b;
        --button-secondary-shadow: 0 6px 12px rgba(148, 163, 184, 0.35);
        --button-danger-bg: #f87171;
        --button-danger-color: #ffffff;
        --button-danger-shadow: 0 6px 12px rgba(248, 113, 113, 0.35);
      }

      :root[data-theme='dark'] {
        color-scheme: dark;
        --page-background: #0f172a;
        --background-gradient: linear-gradient(180deg, #0f172a 0%, #111827 100%);
        --text-primary: #e2e8f0;
        --text-muted: #cbd5f5;
        --text-muted-soft: #94a3b8;
        --panel-background: rgba(15, 23, 42, 0.9);
        --panel-border-color: rgba(71, 85, 105, 0.55);
        --panel-shadow: 0 25px 50px -16px rgba(15, 23, 42, 0.6);
        --input-border: rgba(129, 140, 248, 0.4);
        --input-background: rgba(15, 23, 42, 0.75);
        --table-border: rgba(71, 85, 105, 0.6);
        --table-hover: rgba(79, 70, 229, 0.2);
        --settings-divider: rgba(71, 85, 105, 0.6);
        --events-time-color: #94a3b8;
        --event-payload-bg: rgba(30, 41, 59, 0.75);
        --badge-bg: rgba(165, 180, 252, 0.18);
        --badge-color: #c7d2fe;
        --badge-note-bg: rgba(99, 102, 241, 0.28);
        --badge-note-color: #c7d2fe;
        --badge-revoked-bg: rgba(248, 113, 113, 0.28);
        --badge-revoked-color: #fecdd3;
        --badge-visited-bg: rgba(34, 197, 94, 0.28);
        --badge-visited-color: #bbf7d0;
        --status-active-bg: rgba(34, 197, 94, 0.32);
        --status-active-color: #bbf7d0;
        --status-pending-bg: rgba(59, 130, 246, 0.28);
        --status-pending-color: #bfdbfe;
        --status-danger-bg: rgba(248, 113, 113, 0.32);
        --status-danger-color: #fecdd3;
        --status-message-color: #fca5a5;
        --form-status: #94a3b8;
        --form-status-error: #fca5a5;
        --form-status-success: #bbf7d0;
        --button-primary-bg: #4f46e5;
        --button-primary-shadow: 0 6px 12px rgba(99, 102, 241, 0.4);
        --button-secondary-bg: rgba(71, 85, 105, 0.7);
        --button-secondary-color: #e2e8f0;
        --button-secondary-shadow: 0 6px 12px rgba(15, 23, 42, 0.5);
        --button-danger-bg: #ef4444;
        --button-danger-color: #ffffff;
        --button-danger-shadow: 0 6px 12px rgba(239, 68, 68, 0.45);
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--background-gradient);
        background-color: var(--page-background);
        color: var(--text-primary);
        transition: background 0.3s ease, color 0.3s ease;
      }

      .container {
        max-width: 1080px;
        margin: 0 auto;
        padding: 32px 24px 64px;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 32px;
        gap: 16px;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      h1 {
        font-size: clamp(1.8rem, 2.2vw, 2.4rem);
        margin: 0;
      }

      button {
        cursor: pointer;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        padding: 10px 18px;
        background: var(--button-primary-bg);
        color: var(--button-primary-color);
        transition: transform 0.1s ease, box-shadow 0.1s ease;
      }

      button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: var(--button-primary-shadow);
      }

      button.secondary {
        background: var(--button-secondary-bg);
        color: var(--button-secondary-color);
      }

      button.secondary:hover:not(:disabled) {
        box-shadow: var(--button-secondary-shadow);
      }

      button.danger {
        background: var(--button-danger-bg);
        color: var(--button-danger-color);
      }

      button.danger:hover:not(:disabled) {
        box-shadow: var(--button-danger-shadow);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .panel {
        background: var(--panel-background);
        border-radius: 16px;
        padding: 28px;
        box-shadow: var(--panel-shadow);
        margin-bottom: 24px;
        border: 1px solid var(--panel-border-color);
        backdrop-filter: blur(14px);
      }

      label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
      }

      input[type='password'] {
        width: 100%;
        border-radius: 8px;
        border: 1px solid var(--input-border);
        padding: 10px 12px;
        font-size: 1rem;
        box-sizing: border-box;
        background: var(--input-background);
        color: var(--text-primary);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }

      th,
      td {
        text-align: left;
        padding: 10px 12px;
        border-bottom: 1px solid var(--table-border);
        vertical-align: top;
      }

      th {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
      }

      tbody tr:hover {
        background-color: var(--table-hover);
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        border-radius: 999px;
        padding: 4px 10px;
        font-weight: 600;
        text-transform: capitalize;
      }

      .status-pill[data-status='active'] {
        background: var(--status-active-bg);
        color: var(--status-active-color);
      }

      .status-pill[data-status='pending'] {
        background: var(--status-pending-bg);
        color: var(--status-pending-color);
      }

      .status-pill[data-status='cancelled'],
      .status-pill[data-status='canceled'],
      .status-pill[data-status='suspended'] {
        background: var(--status-danger-bg);
        color: var(--status-danger-color);
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      #status-message {
        margin-top: 12px;
        color: var(--status-message-color);
        font-weight: 500;
      }

      .hidden {
        display: none;
      }

      .grid {
        display: grid;
        gap: 24px;
      }

      @media (min-width: 960px) {
        .grid {
          grid-template-columns: 2fr 1fr;
        }
      }

      .events-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 420px;
        overflow-y: auto;
      }

      .events-list li {
        padding: 10px 0;
        border-bottom: 1px dashed var(--table-border);
        font-size: 0.9rem;
      }

      .events-list time {
        display: block;
        font-size: 0.78rem;
        color: var(--events-time-color);
        margin-bottom: 4px;
      }

      .event-payload {
        white-space: pre-wrap;
        background: var(--event-payload-bg);
        padding: 8px;
        border-radius: 8px;
        margin-top: 6px;
      }

      .settings-form {
        margin-top: 24px;
        padding-top: 16px;
        border-top: 1px solid var(--settings-divider);
        display: grid;
        gap: 12px;
      }

      .settings-form:first-of-type {
        margin-top: 0;
        padding-top: 0;
        border-top: none;
      }

      .settings-form h3 {
        margin: 0;
      }

      .settings-form label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-weight: 600;
        margin-bottom: 0;
      }

      .settings-form input[type='text'],
      .settings-form input[type='password'],
      .settings-form input[type='url'],
      .settings-form input[type='number'],
      .settings-form input[type='email'] {
        border-radius: 8px;
        border: 1px solid var(--input-border);
        padding: 10px 12px;
        font-size: 0.95rem;
        box-sizing: border-box;
        background: var(--input-background);
        color: var(--text-primary);
      }

      .settings-form label span.help {
        font-weight: 500;
        color: var(--text-muted-soft);
        font-size: 0.8rem;
      }

      .field-grid {
        display: grid;
        gap: 12px;
      }

      @media (min-width: 720px) {
        .field-grid {
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
      }

      .checkbox-row {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
      }

      .checkbox-row input[type='checkbox'] {
        width: 18px;
        height: 18px;
      }

      .form-status {
        min-height: 18px;
        font-size: 0.85rem;
        color: var(--form-status);
      }

      .form-status[data-state='error'] {
        color: var(--form-status-error);
      }

      .form-status[data-state='success'] {
        color: var(--form-status-success);
      }

      .form-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      @media (min-width: 560px) {
        .form-actions {
          flex-direction: row;
        }
      }

      .badge {
        background: var(--badge-bg);
        color: var(--badge-color);
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 0.75rem;
        margin-right: 6px;
        font-weight: 600;
        display: inline-flex;
        gap: 6px;
        align-items: center;
      }

      .badge-note {
        background: var(--badge-note-bg);
        color: var(--badge-note-color);
      }

      .badge-revoked {
        background: var(--badge-revoked-bg);
        color: var(--badge-revoked-color);
      }

      .badge-visited {
        background: var(--badge-visited-bg);
        color: var(--badge-visited-color);
      }

      .muted-text {
        color: var(--text-muted);
      }

      .subtle-text {
        color: var(--text-muted-soft);
        font-size: 0.85rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Plex Donate Control Center</h1>
        <div class="header-actions">
          <button id="theme-toggle" type="button" class="secondary" aria-pressed="false">
            Use dark theme
          </button>
          <button id="logout-button" class="hidden" type="button">Log out</button>
        </div>
      </header>

      <section id="login-panel" class="panel">
        <h2>Admin Sign in</h2>
        <p>Enter the admin password defined in your <code>.env</code> file.</p>
        <form id="login-form">
          <label for="password">Password</label>
          <input id="password" name="password" type="password" autocomplete="current-password" required />
          <button type="submit" style="margin-top: 16px;">Sign in</button>
        </form>
        <p id="status-message"></p>
      </section>

      <div id="dashboard" class="hidden">
        <div class="grid">
          <section class="panel">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;">
              <div>
                <h2 style="margin:0 0 4px;">Active subscribers</h2>
                <p class="muted-text" style="margin:0;">Manage Wizarr invites and check the latest payments.</p>
              </div>
              <button id="refresh-button" type="button" class="secondary">Refresh</button>
            </div>
            <div style="overflow-x:auto;">
              <table id="subscribers-table">
                <thead>
                  <tr>
                    <th>Subscriber</th>
                    <th>Status</th>
                    <th>Last payment</th>
                    <th>Invite</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </section>

          <section class="panel">
            <h2 style="margin-top:0;">Recent activity</h2>
            <ul id="events-list" class="events-list"></ul>
          </section>
        </div>
        <section class="panel" id="settings-panel">
          <h2 style="margin-top:0;">Integration settings</h2>
          <p class="muted-text" style="margin:0 0 16px;">Keep service credentials in one place so you can avoid editing environment files.</p>

          <form class="settings-form" data-group="paypal">
            <h3>PayPal</h3>
            <div class="field-grid">
              <label>
                Client ID
                <input name="clientId" type="text" autocomplete="off" placeholder="A..." />
              </label>
              <label>
                Client Secret
                <input name="clientSecret" type="password" autocomplete="new-password" placeholder="E..." />
              </label>
              <label>
                Webhook ID
                <input name="webhookId" type="text" autocomplete="off" placeholder="0..." />
              </label>
              <label>
                API base URL
                <input name="apiBase" type="url" placeholder="https://api-m.sandbox.paypal.com" />
                <span class="help">Use the sandbox URL for testing or the live URL for production.</span>
              </label>
              <label>
                Plan ID
                <input name="planId" type="text" autocomplete="off" placeholder="P-123456789" />
                <span class="help">Used to generate the PayPal subscription link that donors visit.</span>
              </label>
              <label>
                Monthly price
                <input name="subscriptionPrice" type="number" min="0" step="0.01" placeholder="5.00" />
                <span class="help">Shown on share pages so donors know the recurring amount.</span>
              </label>
              <label>
                Currency
                <input name="currency" type="text" autocomplete="off" placeholder="USD" />
              </label>
            </div>
            <p class="form-status" data-status-for="paypal"></p>
            <div class="form-actions">
              <button type="submit" class="secondary">Save PayPal settings</button>
              <button type="button" data-action="test">Test PayPal settings</button>
            </div>
          </form>

          <form class="settings-form" data-group="wizarr">
            <h3>Wizarr</h3>
            <div class="field-grid">
              <label>
                Base URL
                <input name="baseUrl" type="url" placeholder="https://wizarr.example.com" />
              </label>
              <label>
                API key
                <input name="apiKey" type="password" autocomplete="new-password" />
              </label>
              <label>
                Default invite days
                <input name="defaultDurationDays" type="number" min="1" />
                <span class="help">Used when generating invites without a custom duration.</span>
              </label>
            </div>
            <p class="form-status" data-status-for="wizarr"></p>
            <div class="form-actions">
              <button type="submit" class="secondary">Save Wizarr settings</button>
              <button type="button" data-action="test">Test Wizarr connection</button>
            </div>
          </form>

          <form class="settings-form" data-group="smtp">
            <h3>Email (SMTP)</h3>
            <div class="field-grid">
              <label>
                Host
                <input name="host" type="text" placeholder="smtp.example.com" />
              </label>
              <label>
                Port
                <input name="port" type="number" min="1" />
              </label>
              <label class="checkbox-row">
                <input name="secure" type="checkbox" />
                Use TLS (secure)
              </label>
              <label>
                Username
                <input name="user" type="text" autocomplete="off" />
              </label>
              <label>
                Password
                <input name="pass" type="password" autocomplete="new-password" />
              </label>
              <label>
                From address
                <input name="from" type="email" placeholder="Plex Donate &lt;donations@example.com&gt;" />
              </label>
            </div>
            <p class="form-status" data-status-for="smtp"></p>
            <div class="form-actions">
              <button type="submit" class="secondary">Save email settings</button>
              <button type="button" data-action="test">Test email delivery</button>
            </div>
          </form>

          <form class="settings-form" data-group="plex">
            <h3>Plex (optional)</h3>
            <div class="field-grid">
              <label>
                Server URL
                <input name="baseUrl" type="url" placeholder="https://plex.example.com" />
              </label>
              <label>
                Plex token
                <input name="token" type="password" autocomplete="new-password" />
              </label>
            </div>
            <p class="form-status" data-status-for="plex"></p>
            <div class="form-actions">
              <button type="submit" class="secondary">Save Plex settings</button>
              <button type="button" data-action="test">Test Plex connection</button>
            </div>
          </form>
        </section>
      </div>
    </div>

    <template id="subscriber-row">
      <tr>
        <td class="col-subscriber"></td>
        <td><span class="status-pill"></span></td>
        <td class="col-last-payment"></td>
        <td class="col-invite"></td>
        <td>
          <div class="actions">
            <button data-action="invite">Generate invite</button>
            <button data-action="share" class="secondary">Copy invite page link</button>
            <button data-action="share-generate" class="secondary">Generate invite page link</button>
            <button data-action="resend" class="secondary">Resend email</button>
            <button data-action="revoke" class="danger">Revoke</button>
          </div>
        </td>
      </tr>
    </template>

    <script>
      const loginPanel = document.getElementById('login-panel');
      const dashboard = document.getElementById('dashboard');
      const logoutButton = document.getElementById('logout-button');
      const statusMessage = document.getElementById('status-message');
      const subscribersTable = document.querySelector('#subscribers-table tbody');
      const eventsList = document.getElementById('events-list');
      const refreshButton = document.getElementById('refresh-button');
      const settingsPanel = document.getElementById('settings-panel');
      const settingsForms = settingsPanel
        ? Array.from(settingsPanel.querySelectorAll('.settings-form'))
        : [];
      const themeToggleButton = document.getElementById('theme-toggle');
      const themeMeta = document.querySelector('meta[name="theme-color"]');
      const rootElement = document.documentElement;
      const THEME_STORAGE_KEY = 'plexDonateTheme';

      let csrfToken = null;
      let state = {
        authenticated: false,
        donors: [],
        events: [],
        settings: null,
      };

      const statusClearTimers = new WeakMap();

      function storeThemePreference(theme) {
        try {
          localStorage.setItem(THEME_STORAGE_KEY, theme);
        } catch (err) {
          /* noop */
        }
      }

      function applyTheme(theme, persist = true) {
        const normalized = theme === 'dark' ? 'dark' : 'light';
        rootElement.dataset.theme = normalized;
        if (persist) {
          storeThemePreference(normalized);
        }
        if (themeMeta) {
          themeMeta.setAttribute('content', normalized === 'dark' ? '#0f172a' : '#f8fafc');
        }
        if (themeToggleButton) {
          themeToggleButton.textContent =
            normalized === 'dark' ? 'Use light theme' : 'Use dark theme';
          themeToggleButton.setAttribute('aria-pressed', normalized === 'dark' ? 'true' : 'false');
        }
      }

      applyTheme(rootElement.dataset.theme || 'light', false);

      if (themeToggleButton) {
        themeToggleButton.addEventListener('click', () => {
          const nextTheme = rootElement.dataset.theme === 'dark' ? 'light' : 'dark';
          applyTheme(nextTheme);
        });
      }

      function registerServiceWorker() {
        if (!('serviceWorker' in navigator)) {
          return;
        }
        window.addEventListener('load', () => {
          navigator.serviceWorker
            .register('/service-worker.js')
            .catch((err) => {
              console.warn('Service worker registration failed', err);
            });
        });
      }

      function escapeHtml(value) {
        return String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      async function api(path, options = {}) {
        const opts = { ...options };
        opts.credentials = 'include';
        opts.headers = opts.headers ? { ...opts.headers } : {};
        if (opts.body && typeof opts.body !== 'string') {
          opts.headers['Content-Type'] = 'application/json';
          opts.body = JSON.stringify(opts.body);
        }
        if (csrfToken && opts.method && opts.method !== 'GET') {
          opts.headers['X-CSRF-Token'] = csrfToken;
        }

        const response = await fetch(path, opts);
        const contentType = response.headers.get('content-type') || '';
        const data = contentType.includes('application/json')
          ? await response.json()
          : {};

        if (data && data.csrfToken) {
          csrfToken = data.csrfToken;
        }

        if (response.status === 401) {
          state.authenticated = false;
          state.settings = null;
          render();
          throw new Error('Authentication required');
        }

        if (!response.ok) {
          const error = data.error || 'Request failed';
          throw new Error(error);
        }

        return data;
      }

      function render() {
        if (state.authenticated) {
          loginPanel.classList.add('hidden');
          dashboard.classList.remove('hidden');
          logoutButton.classList.remove('hidden');
          statusMessage.textContent = '';
          renderSubscribers();
          renderEvents();
          renderSettings();
        } else {
          loginPanel.classList.remove('hidden');
          dashboard.classList.add('hidden');
          logoutButton.classList.add('hidden');
        }
      }

      function setFormStatus(form, message, stateAttr = '') {
        if (!form) {
          return;
        }
        const statusEl = form.querySelector('.form-status');
        if (!statusEl) {
          return;
        }
        statusEl.textContent = message;
        if (stateAttr) {
          statusEl.dataset.state = stateAttr;
        } else {
          delete statusEl.dataset.state;
        }
        if (stateAttr !== 'success') {
          const existing = statusClearTimers.get(form);
          if (existing) {
            clearTimeout(existing);
            statusClearTimers.delete(form);
          }
        }
      }

      function scheduleStatusClear(form, delay = 3000) {
        if (!form) {
          return;
        }
        const existing = statusClearTimers.get(form);
        if (existing) {
          clearTimeout(existing);
        }
        const timer = setTimeout(() => {
          const statusEl = form.querySelector('.form-status');
          if (statusEl && statusEl.dataset.state === 'success') {
            statusEl.textContent = '';
            delete statusEl.dataset.state;
          }
          statusClearTimers.delete(form);
        }, delay);
        statusClearTimers.set(form, timer);
      }

      function getFormPayload(form) {
        const payload = {};
        form.querySelectorAll('[name]').forEach((input) => {
          if (input.type === 'checkbox') {
            payload[input.name] = input.checked;
          } else {
            payload[input.name] = input.value;
          }
        });
        return payload;
      }

      function renderSettings() {
        if (!settingsPanel || !state.settings) {
          return;
        }
        settingsForms.forEach((form) => {
          const group = form.dataset.group;
          const values = group ? state.settings[group] : null;
          form.querySelectorAll('[name]').forEach((input) => {
            if (input.type === 'checkbox') {
              input.checked = Boolean(values && values[input.name]);
            } else {
              const rawValue = values ? values[input.name] : '';
              input.value = rawValue == null ? '' : String(rawValue);
            }
          });
        });
      }

      async function loadSettings() {
        if (!settingsPanel) {
          return;
        }
        try {
          const response = await api('/api/admin/settings');
          state.settings = response.settings || {};
          settingsForms.forEach((form) => setFormStatus(form, ''));
        } catch (err) {
          console.error(err);
        }
      }

      function renderSubscribers() {
        subscribersTable.innerHTML = '';
        if (state.donors.length === 0) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 5;
          cell.textContent = 'No subscribers yet.';
          cell.style.color = 'var(--text-muted-soft)';
          row.appendChild(cell);
          subscribersTable.appendChild(row);
          return;
        }

        const template = document.getElementById('subscriber-row');
        state.donors.forEach((donor) => {
          const clone = template.content.cloneNode(true);
          const row = clone.querySelector('tr');
          row.dataset.id = donor.id;
          const subscriberCell = clone.querySelector('.col-subscriber');
          const statusPill = clone.querySelector('.status-pill');
          const lastPaymentCell = clone.querySelector('.col-last-payment');
          const inviteCell = clone.querySelector('.col-invite');

          subscriberCell.innerHTML = `<strong>${donor.name || donor.email || 'Unknown'}</strong><br /><span style="color:var(--text-muted-soft);font-size:0.85rem;">${donor.email || '—'}<br/>Sub ID: ${donor.subscriptionId}</span>`;

          const status = (donor.status || 'pending').toLowerCase();
          statusPill.dataset.status = status;
          statusPill.textContent = status.replace(/_/g, ' ');

          if (donor.lastPaymentAt) {
            const date = new Date(donor.lastPaymentAt);
            lastPaymentCell.innerHTML = `${date.toLocaleString()}<br /><span class="badge">${formatAmount(donor)}</span>`;
          } else {
            lastPaymentCell.textContent = '—';
          }

          const inviteParts = [];
          if (donor.invites.length > 0) {
            const invite = donor.invites[0];
            if (invite.wizarrInviteUrl) {
              inviteParts.push(`<a href="${invite.wizarrInviteUrl}" target="_blank" rel="noopener">Invite link</a>`);
            }
            if (invite.recipientEmail) {
              inviteParts.push(
                `<span class="badge badge-note">For ${escapeHtml(
                  invite.recipientEmail
                )}</span>`
              );
            }
            if (invite.emailSentAt) {
              const date = new Date(invite.emailSentAt);
              inviteParts.push(`<span class="badge">Emailed ${date.toLocaleDateString()}</span>`);
            }
            if (invite.revokedAt) {
              const date = new Date(invite.revokedAt);
              inviteParts.push(`<span class="badge badge-revoked">Revoked ${date.toLocaleDateString()}</span>`);
            }
          }

          if (donor.shareLink && donor.shareLink.token) {
            const origin = window.location.origin.replace(/\/$/, '');
            const shareUrl = `${origin}/share/${donor.shareLink.token}`;
            inviteParts.push(
              `<a href="${shareUrl}" target="_blank" rel="noopener">Share page</a>`
            );
            if (donor.shareLink.lastUsedAt) {
              const usedDate = new Date(donor.shareLink.lastUsedAt);
              inviteParts.push(
                `<span class="badge badge-visited">Visited ${usedDate.toLocaleDateString()}</span>`
              );
            }
          }

          if (inviteParts.length > 0) {
            inviteCell.innerHTML = inviteParts.join('<br />');
          } else {
            inviteCell.textContent = '—';
          }

          subscribersTable.appendChild(clone);
        });
      }

      function formatAmount(donor) {
        const payment = donor.payments && donor.payments[0];
        if (!payment || !payment.amount) {
          return 'No payment recorded';
        }
        return `${payment.amount} ${payment.currency || ''}`.trim();
      }

      function renderEvents() {
        eventsList.innerHTML = '';
        if (state.events.length === 0) {
          const li = document.createElement('li');
          li.textContent = 'No events yet.';
          eventsList.appendChild(li);
          return;
        }
        state.events.forEach((event) => {
          const li = document.createElement('li');
          const payload = (() => {
            try {
              return JSON.stringify(JSON.parse(event.payload), null, 2);
            } catch (e) {
              return event.payload;
            }
          })();
          li.innerHTML = `<time>${new Date(event.createdAt).toLocaleString()}</time><strong>${event.eventType}</strong><pre class="event-payload">${payload}</pre>`;
          eventsList.appendChild(li);
        });
      }

      async function loadDashboardData() {
        try {
          const donorsResponse = await api('/api/admin/subscribers');
          state.donors = donorsResponse.donors || [];
        } catch (err) {
          console.error(err);
        }
        try {
          const eventsResponse = await api('/api/admin/events');
          state.events = eventsResponse.events || [];
        } catch (err) {
          console.error(err);
        }
        await loadSettings();
        render();
      }

      async function checkSession() {
        try {
          const data = await api('/api/admin/session');
          csrfToken = data.csrfToken;
          state.authenticated = data.authenticated;
          if (state.authenticated) {
            await loadDashboardData();
          } else {
            state.settings = null;
            render();
          }
        } catch (err) {
          console.error(err);
        }
      }

      document.getElementById('login-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const password = document.getElementById('password').value.trim();
        if (!password) {
          statusMessage.textContent = 'Password is required';
          return;
        }
        statusMessage.textContent = 'Signing in…';
        try {
          const response = await api('/api/admin/login', {
            method: 'POST',
            body: { password },
          });
          csrfToken = response.csrfToken;
          state.authenticated = true;
          document.getElementById('password').value = '';
          await loadDashboardData();
          statusMessage.textContent = '';
        } catch (err) {
          statusMessage.textContent = err.message;
        }
      });

      logoutButton.addEventListener('click', async () => {
        try {
          await api('/api/admin/logout', { method: 'POST' });
        } finally {
          state.authenticated = false;
          state.donors = [];
          state.events = [];
          state.settings = null;
          render();
        }
      });

      refreshButton.addEventListener('click', loadDashboardData);

      settingsForms.forEach((form) => {
        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          const group = form.dataset.group;
          if (!group) {
            return;
          }
          const payload = getFormPayload(form);
          const submitButton = form.querySelector("button[type='submit']");
          try {
            if (submitButton) {
              submitButton.disabled = true;
            }
            setFormStatus(form, 'Saving…');
            const response = await api(`/api/admin/settings/${group}`, {
              method: 'PUT',
              body: payload,
            });
            if (!state.settings) {
              state.settings = {};
            }
            state.settings[group] = response.settings || {};
            renderSettings();
            setFormStatus(form, 'Saved!', 'success');
            scheduleStatusClear(form);
          } catch (err) {
            setFormStatus(form, err.message || 'Failed to save settings', 'error');
          } finally {
            if (submitButton) {
              submitButton.disabled = false;
            }
          }
        });

        form.addEventListener('click', async (event) => {
          const button = event.target.closest("button[data-action='test']");
          if (!button) {
            return;
          }
          event.preventDefault();
          const group = form.dataset.group;
          if (!group) {
            return;
          }
          const payload = getFormPayload(form);
          const previousDisabledState = button.disabled;
          try {
            button.disabled = true;
            setFormStatus(form, 'Testing…');
            const response = await api(`/api/admin/settings/${group}/test`, {
              method: 'POST',
              body: payload,
            });
            const result = response.result || {};
            const message =
              result.message ||
              response.message ||
              'Settings test completed successfully.';
            setFormStatus(form, message, 'success');
            scheduleStatusClear(form);
          } catch (err) {
            setFormStatus(
              form,
              err.message || 'Failed to verify settings',
              'error'
            );
          } finally {
            button.disabled = previousDisabledState;
          }
        });
      });

      subscribersTable.addEventListener('click', async (event) => {
        const button = event.target.closest('button[data-action]');
        if (!button) return;
        const row = event.target.closest('tr');
        const donorId = row && row.dataset.id;
        if (!donorId) return;
        const action = button.dataset.action;
        button.disabled = true;
        try {
          if (action === 'invite') {
            await api(`/api/admin/subscribers/${donorId}/invite`, { method: 'POST' });
          } else if (action === 'share' || action === 'share-generate') {
            const regenerate = action === 'share-generate' ? true : event.shiftKey;
            const options = { method: 'POST' };
            if (regenerate) {
              options.body = { regenerate: true };
            }
            const response = await api(
              `/api/admin/subscribers/${donorId}/share-link`,
              options
            );
            const shareLink = response.shareLink || {};
            const origin = window.location.origin.replace(/\/$/, '');
            const shareUrl =
              shareLink.url ||
              (shareLink.token ? `${origin}/share/${shareLink.token}` : '');
            if (!shareUrl) {
              throw new Error('Unable to determine invite page URL');
            }
            let copied = false;
            if (navigator.clipboard && navigator.clipboard.writeText) {
              try {
                await navigator.clipboard.writeText(shareUrl);
                copied = true;
              } catch (err) {
                console.warn('Clipboard copy failed', err);
              }
            }
            if (copied) {
              alert(
                action === 'share-generate'
                  ? 'New invite page link generated and copied to clipboard.'
                  : regenerate
                    ? 'Invite page link regenerated and copied to clipboard.'
                    : 'Invite page link copied to clipboard.'
              );
            } else {
              const promptMessage =
                action === 'share-generate'
                  ? 'New invite page link generated. Share this link with the subscriber:'
                  : 'Share this invite page link with the subscriber:';
              window.prompt(promptMessage, shareUrl);
            }
          } else if (action === 'resend') {
            await api(`/api/admin/subscribers/${donorId}/email`, { method: 'POST' });
          } else if (action === 'revoke') {
            if (!confirm('Revoke the latest invite for this subscriber?')) {
              return;
            }
            await api(`/api/admin/subscribers/${donorId}/revoke`, { method: 'POST' });
          }
          await loadDashboardData();
        } catch (err) {
          alert(err.message);
        } finally {
          button.disabled = false;
        }
      });

      registerServiceWorker();
      checkSession();
    </script>
  </body>
</html>
