<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#050818" />
    <meta name="msapplication-TileColor" content="#0f172a" />
    <meta name="msapplication-TileImage" content="/icons/plex-donate-android-any-144.png" />
    <meta name="application-name" content="Plex Donate" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Plex Donate" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <link rel="icon" type="image/png" sizes="144x144" href="/icons/plex-donate-android-any-144.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/plex-donate-android-any-192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/plex-donate-android-any-512.png" />
    <link rel="shortcut icon" href="/icons/plex-donate-android-any-144.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/plex-donate-ios-120.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/plex-donate-ios-152.png" />
    <link rel="apple-touch-icon" sizes="167x167" href="/icons/plex-donate-ios-167.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/plex-donate-ios-180.png" />

    <title>Plex Donate Invite</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(
            120% 120% at 50% -10%,
            rgba(99, 102, 241, 0.35) 0%,
            rgba(15, 23, 42, 0.92) 45%,
            #050818 100%
          ),
          radial-gradient(80% 80% at 80% 20%, rgba(14, 165, 233, 0.18), transparent);
        color: #e2e8f0;
        display: flex;
        justify-content: center;
        padding: 32px 16px 64px;
        position: relative;
      }
      body::after {
        content: '';
        position: fixed;
        inset: 0;
        background: radial-gradient(
          60% 60% at 20% 20%,
          rgba(76, 29, 149, 0.18),
          transparent 70%
        );
        pointer-events: none;
        z-index: 0;
      }
      a {
        color: inherit;
      }
      h1,
      h2,
      h3 {
        margin: 0;
      }
      h1 {
        font-size: clamp(2.2rem, 4vw, 3rem);
        line-height: 1.1;
        background: linear-gradient(135deg, #c7d2fe 0%, #a855f7 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      h2 {
        font-size: clamp(1.4rem, 2vw, 1.8rem);
        line-height: 1.3;
      }
      p {
        margin: 0;
        line-height: 1.6;
      }
      .hidden {
        display: none !important;
      }
      .panel {
        width: min(760px, 100%);
        background: rgba(15, 23, 42, 0.82);
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 20px;
        padding: 28px;
        text-align: center;
        box-shadow: 0 25px 60px -25px rgba(30, 64, 175, 0.6);
        position: relative;
        z-index: 1;
      }
      .panel.error {
        background: rgba(76, 29, 149, 0.18);
        border-color: rgba(248, 113, 113, 0.4);
        color: #fecdd3;
      }
      #content {
        width: 100%;
        position: relative;
        z-index: 1;
      }
      .canvas {
        width: min(960px, 100%);
        margin: 0 auto;
        display: grid;
        gap: 28px;
      }
      .surface {
        background: rgba(15, 23, 42, 0.76);
        border: 1px solid rgba(148, 163, 184, 0.22);
        border-radius: 24px;
        padding: clamp(24px, 4vw, 36px);
        box-shadow: 0 30px 60px -28px rgba(37, 99, 235, 0.55);
        backdrop-filter: blur(18px);
      }
      .hero {
        position: relative;
        overflow: hidden;
        display: grid;
        gap: 16px;
      }
      .hero::after {
        content: '';
        position: absolute;
        inset: -40% 40% auto -30%;
        height: 120%;
        transform: rotate(18deg);
        background: radial-gradient(
          60% 60% at 50% 50%,
          rgba(59, 130, 246, 0.3),
          transparent 70%
        );
        z-index: 0;
      }
      .hero > * {
        position: relative;
        z-index: 1;
      }
      .eyebrow {
        letter-spacing: 0.2em;
        text-transform: uppercase;
        font-size: 0.75rem;
        color: rgba(165, 180, 252, 0.9);
      }
      .lead {
        color: #cbd5f5;
        max-width: 52ch;
      }
      .hero-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 999px;
        border: 1px solid rgba(129, 140, 248, 0.6);
        background: rgba(79, 70, 229, 0.3);
        color: #c7d2fe;
        font-size: 0.82rem;
        font-weight: 600;
      }
      .grid {
        display: grid;
        gap: 24px;
      }
      @media (min-width: 860px) {
        .grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        #account-form {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        #account-form #account-subscription-row,
        #account-form .form-actions {
          grid-column: 1 / -1;
        }
      }
      .muted {
        color: rgba(203, 213, 225, 0.8);
      }
      .small {
        font-size: 0.85rem;
      }
      .support-list {
        list-style: none;
        padding: 0;
        margin: 16px 0 0;
        display: grid;
        gap: 12px;
      }
      .support-list li::before {
        content: 'âœ¦';
        margin-right: 10px;
        color: rgba(129, 140, 248, 0.8);
      }
      .cta {
        margin-top: 24px;
        padding: 20px;
        border-radius: 18px;
        background: rgba(59, 130, 246, 0.08);
        border: 1px solid rgba(96, 165, 250, 0.2);
      }
      .cta-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 20px;
        margin-top: 12px;
        border-radius: 12px;
        border: none;
        background: linear-gradient(135deg, #38bdf8, #6366f1);
        color: #0f172a;
        font-weight: 700;
        font-family: inherit;
        font-size: 1rem;
        text-decoration: none;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        box-shadow: 0 18px 36px -16px rgba(56, 189, 248, 0.65);
        cursor: pointer;
      }
      .cta-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 24px 48px -18px rgba(56, 189, 248, 0.75);
      }
      .cta-button:disabled {
        opacity: 0.65;
        cursor: not-allowed;
        box-shadow: none;
      }
      form {
        margin-top: 20px;
      }
      #account-form {
        align-items: start;
      }
      label {
        display: grid;
        gap: 6px;
        font-weight: 600;
        margin-bottom: 16px;
      }
      input[type='email'],
      input[type='text'],
      input[type='password'] {
        width: 100%;
        border-radius: 12px;
        border: 1px solid rgba(129, 140, 248, 0.4);
        background: rgba(15, 23, 42, 0.88);
        padding: 12px 14px;
        font-size: 1rem;
        color: #e2e8f0;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
        font-family: inherit;
        line-height: 1.45;
      }
      input[type='email']:focus,
      input[type='text']:focus,
      input[type='password']:focus {
        outline: none;
        border-color: rgba(165, 180, 252, 0.8);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
      }
      input::placeholder {
        color: rgba(148, 163, 184, 0.9);
      }
      button {
        appearance: none;
        border: none;
        border-radius: 12px;
        padding: 12px 22px;
        font-size: 1rem;
        font-weight: 700;
        background: linear-gradient(135deg, #6366f1, #4338ca);
        color: #f8fafc;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        box-shadow: 0 18px 38px -18px rgba(79, 70, 229, 0.65);
      }
      button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 24px 48px -20px rgba(79, 70, 229, 0.7);
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }
      .form-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
      }
      @media (min-width: 560px) {
        .form-actions {
          flex-direction: row;
          align-items: center;
        }
      }
      .status-text {
        margin: 0;
        font-size: 0.95rem;
        min-height: 20px;
        color: rgba(165, 180, 252, 0.9);
      }
      .status-text.small {
        font-size: 0.85rem;
      }
      .status-text.error {
        color: #fca5a5;
      }
      .status-text.success {
        color: #86efac;
      }
      .status-text.info {
        color: #bae6fd;
      }
      .helper-text {
        color: rgba(203, 213, 225, 0.85);
        font-size: 0.9rem;
        margin: 0;
      }
      .invite-ready {
        margin-top: 24px;
        padding: 20px;
        border-radius: 18px;
        background: rgba(40, 54, 99, 0.6);
        border: 1px solid rgba(129, 140, 248, 0.35);
        display: grid;
        gap: 12px;
      }
      .invite-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 999px;
        font-size: 0.78rem;
        font-weight: 600;
        background: rgba(129, 140, 248, 0.25);
        color: #c7d2fe;
      }
      .badge.success {
        background: rgba(34, 197, 94, 0.22);
        color: #bbf7d0;
      }
      .invite-link {
        word-break: break-all;
        font-weight: 600;
        color: #c7d2fe;
        text-decoration: none;
      }
      .invite-link:hover {
        text-decoration: underline;
      }
      @media (max-width: 640px) {
        .surface {
          padding: 24px;
        }
        .panel {
          padding: 24px;
        }
        .form-actions {
          align-items: stretch;
        }
        button,
        .cta-button {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div id="loading" class="panel">Setting the stage for your inviteâ€¦</div>
    <div id="error-panel" class="panel error hidden"></div>
    <div id="content" class="hidden">
      <main class="canvas">
        <header class="surface hero">
          <span class="eyebrow">Start here</span>
          <h1>Claim your Plex Donate referral invite.</h1>
          <p class="lead">
            You're moments away from joining our streaming community. Follow
            the steps below to create your account, link Plex, and activate the
            referral that brought you here.
          </p>
          <div class="hero-badges">
            <span class="chip">Plex invite ready</span>
            <span class="chip">Community powered</span>
            <span class="chip">Streaming sanctuary</span>
          </div>
        </header>

        <section class="grid">
          <article class="surface" id="support-card">
            <h2>Here's how it works</h2>
            <p class="muted">
              Follow these steps in order to activate your library access.
            </p>
            <p class="muted">
              <strong>
                Before continuing, create or recover your Plex account at
                <a href="https://www.plex.tv/sign-up/" target="_blank" rel="noopener"
                  >plex.tv</a
                > so you can link it hereâ€”checkout stays disabled until Plex is ready.
              </strong>
            </p>
            <ul class="support-list">
              <li>
                Start by creating or recovering your Plex account and saving your Plex Donate
                login with the same supporter email.
              </li>
              <li>
                Watch for our verification emailâ€”open it and sign in from that link so we can
                confirm your dashboard access.
              </li>
              <li>
                Complete the Plex authentication prompt to confirm which Plex identity you'll use
                before sharing invites.
              </li>
              <li>
                Once Plex is linked, start your PayPal donation or paste your subscription ID so
                we can verify billing.
              </li>
              <li>
                Use the referral tool to welcome new viewers once your donation is active. Existing
                supporters can regenerate their own Plex invite here only if they've lost library
                access.
              </li>
            </ul>
            <div class="cta">
              <h3>After you join</h3>
              <p class="muted">
                You'll unlock the customer dashboard to manage billing, track your invites,
                and confirm Plex status any time.
              </p>
              <a class="cta-button" href="/dashboard">Preview the dashboard</a>
            </div>
          </article>
        </section>

        <section class="surface" id="account-panel">
          <h2>Step 1 Â· Create your account</h2>
          <p id="account-description" class="muted">
            Make sure you've created or recovered your Plex account, then save your Plex Donate
            login with the same email so we can guide you through linking. We'll send a verification
            emailâ€”open it and sign in from that link so we can confirm access.
          </p>
          <form id="account-form" class="grid">
            <label>
              <span>Email for your account</span>
              <input
                id="account-email"
                type="email"
                placeholder="you@example.com"
                autocomplete="email"
                autocapitalize="none"
                spellcheck="false"
                required
              />
            </label>
            <label>
              <span>Display name</span>
              <input
                id="account-name"
                type="text"
                placeholder="How should we greet you?"
                autocomplete="name"
              />
            </label>
            <label id="account-subscription-row" class="hidden">
              <span>PayPal subscription ID (optional)</span>
              <input
                id="account-subscription"
                type="text"
                placeholder="Starts with I-..."
                autocomplete="off"
                inputmode="text"
              />
              <p class="helper-text">
                When your PayPal donation is ready, paste the subscription ID so we can link it
                automatically.
              </p>
            </label>
            <label>
              <span>Password</span>
              <input
                id="account-password"
                type="password"
                placeholder="At least 8 characters"
                autocomplete="new-password"
                required
              />
            </label>
            <label>
              <span>Confirm password</span>
              <input
                id="account-confirm"
                type="password"
                placeholder="Repeat your password"
                autocomplete="new-password"
              />
            </label>
            <div class="form-actions">
              <button id="account-submit" type="submit">Save account</button>
              <p id="account-status" class="status-text"></p>
            </div>
          </form>
        </section>

        <section class="surface" id="invite-panel">
          <h2>Step 2 Â· Link Plex & share referral invites</h2>
          <p class="muted" id="invite-description">
            After Plex is linked and your donation is confirmed, you can send one referral invite
            each month. Choose who should receive itâ€”we'll highlight when the next referral unlocks.
            If you've lost your own library access, you can regenerate your personal link here too.
          </p>
          <form id="invite-form">
            <label>
              <span>Email for this referral invite</span>
              <input
                id="recipient-email"
                type="email"
                placeholder="you@example.com"
                autocomplete="email"
                autocapitalize="none"
                spellcheck="false"
                required
              />
            </label>
            <label>
              <span>Recipient name (optional)</span>
              <input
                id="display-name"
                type="text"
                placeholder="Preferred display name"
                autocomplete="name"
              />
            </label>
            <div class="form-actions">
              <button id="generate-button" type="submit">Send referral invite</button>
              <p class="status-text" id="action-status"></p>
            </div>
          </form>
          <div id="invite-ready" class="invite-ready hidden">
            <div class="invite-meta">
              <span class="badge success">Referral invite ready</span>
              <span id="invite-email" class="muted small"></span>
            </div>
            <a
              id="invite-link"
              class="invite-link"
              href="#"
              target="_blank"
              rel="noopener"
            ></a>
            <p class="muted" id="invite-created"></p>
          </div>
        </section>
      </main>
    </div>

    <script>
      function extractShareTokenFromPath() {
        const segments = window.location.pathname
          .split('/')
          .filter((segment) => segment && segment.length > 0);
        if (segments.length >= 2 && segments[0] === 'share') {
          return segments[1];
        }
        if (segments.length >= 1) {
          return segments[segments.length - 1];
        }
        return '';
      }

      const state = {
        token: extractShareTokenFromPath(),
        data: null,
        sessionToken: '',
        isProspect: false,
        inviteLimitReached: false,
        nextInviteAvailableAt: null,
      };
      let inviteCooldownTimer = null;
      let inviteCooldownTimerType = null;

      const loadingPanel = document.getElementById('loading');
      const errorPanel = document.getElementById('error-panel');
      const content = document.getElementById('content');
      const accountDescription = document.getElementById('account-description');
      const accountForm = document.getElementById('account-form');
      const accountEmailInput = document.getElementById('account-email');
      const accountNameInput = document.getElementById('account-name');
      const accountPasswordInput = document.getElementById('account-password');
      const accountConfirmInput = document.getElementById('account-confirm');
      const accountSubscriptionRow = document.getElementById(
        'account-subscription-row'
      );
      const accountSubscriptionInput = document.getElementById(
        'account-subscription'
      );
      const accountSubmit = document.getElementById('account-submit');
      const accountStatus = document.getElementById('account-status');
      const inviteDescription = document.getElementById('invite-description');
      const inviteForm = document.getElementById('invite-form');
      const emailInput = document.getElementById('recipient-email');
      const nameInput = document.getElementById('display-name');
      const generateButton = document.getElementById('generate-button');
      const actionStatus = document.getElementById('action-status');
      const inviteReady = document.getElementById('invite-ready');
      const inviteLinkEl = document.getElementById('invite-link');
      const inviteCreatedEl = document.getElementById('invite-created');
      const inviteEmailEl = document.getElementById('invite-email');

      function registerServiceWorker() {
        if (!('serviceWorker' in navigator)) {
          return;
        }
        window.addEventListener('load', () => {
          navigator.serviceWorker
            .register('/service-worker.js')
            .catch((err) => {
              console.warn('Service worker registration failed', err);
            });
        });
      }

      function showLoading() {
        loadingPanel.classList.remove('hidden');
        errorPanel.classList.add('hidden');
        content.classList.add('hidden');
      }

      function showError(message) {
        loadingPanel.classList.add('hidden');
        errorPanel.textContent = message || 'Something went wrong.';
        errorPanel.classList.remove('hidden');
        content.classList.add('hidden');
      }

      function parseDate(value) {
        if (!value) {
          return null;
        }
        if (value instanceof Date) {
          return Number.isNaN(value.getTime()) ? null : value;
        }
        const parsed = new Date(value);
        return Number.isNaN(parsed.getTime()) ? null : parsed;
      }

      function formatDateTime(value) {
        const date = parseDate(value);
        if (!date) {
          return '';
        }
        try {
          return new Intl.DateTimeFormat(undefined, {
            dateStyle: 'medium',
            timeStyle: 'short',
          }).format(date);
        } catch (err) {
          return date.toLocaleString();
        }
      }

      function isShareInviteExpired(invite) {
        if (!invite || !invite.expiresAt) {
          return false;
        }
        const expiresAt = parseDate(invite.expiresAt);
        if (!expiresAt) {
          return false;
        }
        return Date.now() >= expiresAt.getTime();
      }

      function isShareInviteUsed(invite) {
        if (!invite || !invite.usedAt) {
          return false;
        }
        const usedAt = parseDate(invite.usedAt);
        if (!usedAt) {
          return Boolean(invite.usedAt);
        }
        return true;
      }

      function clearInviteCooldownTimer() {
        if (!inviteCooldownTimer) {
          return;
        }
        if (inviteCooldownTimerType === 'interval') {
          window.clearInterval(inviteCooldownTimer);
        } else {
          window.clearTimeout(inviteCooldownTimer);
        }
        inviteCooldownTimer = null;
        inviteCooldownTimerType = null;
      }

      function scheduleInviteCooldownRefresh(nextAvailableAt) {
        clearInviteCooldownTimer();
        const nextDate = parseDate(nextAvailableAt);
        state.nextInviteAvailableAt = nextDate
          ? nextDate.toISOString()
          : null;
        if (!nextDate || !state.token) {
          return;
        }
        const delay = nextDate.getTime() - Date.now();
        if (delay <= 0) {
          loadShareData({ silent: true });
          return;
        }
        const MAX_TIMEOUT = 2_147_483_647; // Roughly 24.8 days.
        if (delay > MAX_TIMEOUT) {
          inviteCooldownTimer = window.setInterval(() => {
            if (Date.now() >= nextDate.getTime()) {
              clearInviteCooldownTimer();
              loadShareData({ silent: true });
            }
          }, 60 * 60 * 1000);
          inviteCooldownTimerType = 'interval';
        } else {
          inviteCooldownTimer = window.setTimeout(() => {
            clearInviteCooldownTimer();
            loadShareData({ silent: true });
          }, delay);
          inviteCooldownTimerType = 'timeout';
        }
      }

      function renderInvite(
        invite,
        shareInvite,
        limitReached,
        nextInviteAvailableAt
      ) {
        const limitHit = Boolean(limitReached);
        const isProspect = Boolean(state.isProspect);
        const nextAvailableDate = parseDate(nextInviteAvailableAt);
        const cooldownActive =
          limitHit && nextAvailableDate && nextAvailableDate.getTime() > Date.now();
        const nextInviteMessage = cooldownActive
          ? `Next referral invite available on ${formatDateTime(nextAvailableDate)}.`
          : '';
        const shareInviteExpired = isShareInviteExpired(shareInvite);
        const shareInviteUsed = isShareInviteUsed(shareInvite);
        const shareInviteActive = Boolean(
          shareInvite &&
            !shareInviteExpired &&
            !shareInviteUsed
        );
        const inviteUrl = shareInviteActive
          ? shareInvite.inviteUrl || ''
          : invite && invite.inviteUrl
          ? invite.inviteUrl
          : '';

        if (inviteForm) {
          if (limitHit || isProspect) {
            inviteForm.classList.add('hidden');
          } else {
            inviteForm.classList.remove('hidden');
          }
        }

        if (isProspect) {
          inviteReady.classList.add('hidden');
          inviteLinkEl.removeAttribute('href');
          inviteLinkEl.textContent = '';
          inviteEmailEl.textContent = '';
          inviteCreatedEl.textContent = '';
          inviteDescription.textContent =
            'Finish the quick account setup above to link Plex and unlock referral invites.';
          if (generateButton) {
            generateButton.textContent = 'Send referral invite';
          }
          return;
        }

        if (!inviteUrl || shareInviteUsed || shareInviteExpired) {
          inviteReady.classList.add('hidden');
          inviteLinkEl.removeAttribute('href');
          inviteLinkEl.textContent = '';
          inviteEmailEl.textContent = '';
          inviteCreatedEl.textContent = '';
          if (cooldownActive && nextInviteMessage) {
            inviteDescription.textContent =
              `${nextInviteMessage} We'll refresh this page automatically when you're eligible to send another referral invite.`;
          } else {
            if (shareInviteUsed) {
              inviteDescription.textContent =
                'This referral invite has already been used. Generate a new invite if your recipient still needs access.';
            } else if (shareInviteExpired) {
              inviteDescription.textContent =
                'This referral invite expired after seven days. Generate a new invite to share access again.';
            } else {
              inviteDescription.textContent = limitHit
                ? 'This monthâ€™s referral invite has already been used. Contact the server admin if you lost your own access and need the link restored.'
                : 'Choose who should receive this referral invite and we will generate the share link instantly. Only regenerate your own link if you have lost Plex access.';
            }
          }
          if (generateButton) {
            if (cooldownActive) {
              generateButton.textContent = 'Referral invite cooling downâ€¦';
            } else {
              generateButton.textContent = limitHit
                ? 'Referral invite already sent'
                : 'Send referral invite';
            }
          }
          return;
        }

        inviteReady.classList.remove('hidden');
        inviteLinkEl.href = inviteUrl;
        inviteLinkEl.textContent = inviteUrl;
        inviteEmailEl.textContent = invite.recipientEmail
          ? `Delivering to ${invite.recipientEmail}`
          : '';
        const createdLabel =
          (shareInvite && shareInvite.createdAt) || invite.createdAt
            ? `Created ${formatDateTime(
                shareInvite && shareInvite.createdAt
                  ? shareInvite.createdAt
                  : invite.createdAt
              )}`
            : '';
        const expiresLabel =
          shareInvite && shareInvite.expiresAt
            ? `Expires ${formatDateTime(shareInvite.expiresAt)}`
            : '';
        inviteCreatedEl.textContent = [createdLabel, expiresLabel]
          .filter(Boolean)
          .join(' â€¢ ');
        if (cooldownActive && nextInviteMessage) {
          inviteDescription.textContent =
            `${nextInviteMessage} We'll refresh this page automatically when the referral cooldown ends.`;
        } else {
          inviteDescription.textContent = limitHit
            ? 'Referral invite ready! Reach out to the server admin if you lost access and need the link refreshed.'
            : 'Referral invite ready! Share the link below with your recipientâ€”or follow it yourself if youâ€™re restoring access.';
        }
        if (generateButton) {
          if (cooldownActive) {
            generateButton.textContent = 'Referral invite cooling downâ€¦';
          } else {
            generateButton.textContent = limitHit
              ? 'Referral invite already sent'
              : 'Send another referral invite';
          }
        }
      }

      function render(data) {
        state.data = data;
        state.sessionToken =
          data && data.shareLink && data.shareLink.sessionToken
            ? data.shareLink.sessionToken
            : '';
        loadingPanel.classList.add('hidden');
        errorPanel.classList.add('hidden');
        content.classList.remove('hidden');
        actionStatus.textContent = '';
        actionStatus.className = 'status-text';
        if (accountStatus) {
          accountStatus.textContent = '';
          accountStatus.className = 'status-text';
        }

        const donor = data.donor || null;
        const prospect = data.prospect || null;
        const isProspect = !donor && Boolean(prospect);
        const normalizedStatus = (donor && donor.status
          ? donor.status
          : 'pending'
        ).toLowerCase();
        const isActive = normalizedStatus === 'active';
        const accountReady = Boolean(donor && donor.hasPassword);
        const plexLinked = Boolean(donor && donor.plexLinked);
        state.isProspect = isProspect;
        const limitReached = Boolean(data.inviteLimitReached);
        state.inviteLimitReached = limitReached;
        const nextInviteAvailableAt = data.nextInviteAvailableAt || null;
        state.nextInviteAvailableAt = nextInviteAvailableAt;
        const nextInviteDate = parseDate(nextInviteAvailableAt);
        const cooldownActive =
          limitReached && nextInviteDate && nextInviteDate.getTime() > Date.now();
        scheduleInviteCooldownRefresh(cooldownActive ? nextInviteAvailableAt : null);

        if (accountDescription) {
          if (!accountReady) {
            accountDescription.textContent =
              'Step one: create or recover your Plex account, then save your Plex Donate login so you can link Plex before subscribing. Weâ€™ll email a verification linkâ€”open it and sign in from that message to keep going.';
            if (accountSubmit) {
              accountSubmit.textContent = 'Create account';
            }
          } else if (!plexLinked) {
            accountDescription.textContent =
              'Stay signed in and complete the Plex authentication promptâ€”this confirms which Plex identity we invite.';
            if (accountSubmit) {
              accountSubmit.textContent = 'Save changes';
            }
          } else {
            accountDescription.textContent =
              'Keep your contact details current while we confirm your subscription and unlock referral invites.';
            if (accountSubmit) {
              accountSubmit.textContent = 'Save changes';
            }
          }
        }

        const severeStatuses = new Set(['cancelled', 'suspended', 'expired']);
        const hasSevereIssue = !isProspect && severeStatuses.has(normalizedStatus);
        const inviteLocked = isProspect || !plexLinked || !isActive || limitReached;

        if (generateButton) {
          generateButton.dataset.blocked = inviteLocked ? 'true' : 'false';
          generateButton.disabled = inviteLocked;
        }
        if (emailInput) {
          emailInput.disabled = inviteLocked;
        }
        if (nameInput) {
          nameInput.disabled = inviteLocked;
        }

        if (inviteLocked) {
          if (limitReached) {
            actionStatus.textContent =
              'This monthâ€™s referral invite has already been sent. Contact the server admin if you lost access and need the link restored.';
            actionStatus.className = 'status-text info';
          } else if (isProspect) {
            actionStatus.textContent =
              'Finish setting up your account to unlock referral invites.';
            actionStatus.className = 'status-text info';
          } else if (!accountReady) {
            actionStatus.textContent =
              'Create your dashboard password above to unlock referral invites.';
            actionStatus.className = 'status-text info';
          } else if (!plexLinked) {
            actionStatus.textContent =
              'Authenticate with Plex to continueâ€”watch for the sign-in prompt above so referral invites go to the right account.';
            actionStatus.className = 'status-text info';
          } else if (hasSevereIssue) {
            actionStatus.textContent =
              'This subscription needs attention before another referral invite can be generated. Contact the server admin if you need help.';
            actionStatus.className = 'status-text error';
          } else {
            actionStatus.textContent =
              'Referral invites unlock once your subscription is active.';
            actionStatus.className = 'status-text info';
          }
        }

        if (accountSubmit) {
          accountSubmit.disabled = hasSevereIssue;
        }
        if (accountEmailInput) {
          accountEmailInput.disabled = hasSevereIssue;
        }
        if (accountNameInput) {
          accountNameInput.disabled = hasSevereIssue;
        }
        if (accountPasswordInput) {
          accountPasswordInput.disabled = hasSevereIssue;
        }
        if (accountConfirmInput) {
          accountConfirmInput.disabled = hasSevereIssue;
        }
        if (accountSubscriptionInput) {
          accountSubscriptionInput.disabled = hasSevereIssue;
        }

        if (hasSevereIssue && accountStatus) {
          accountStatus.textContent =
            'This subscription needs attention before you can update your account.';
          accountStatus.classList.add('error');
        }

        if (accountSubscriptionRow) {
          const showSubscriptionInput =
            isProspect || (donor && !donor.subscriptionId);
          accountSubscriptionRow.classList.toggle('hidden', !showSubscriptionInput);
        }

        const invite = data.invite || null;
        const shareInvite =
          data.shareInvite ||
          (data.invite && data.invite.shareLink) ||
          null;
        const emailPrefill =
          (invite && invite.recipientEmail) ||
          (donor && donor.email) ||
          (prospect && prospect.email) ||
          emailInput.value;
        if (document.activeElement !== emailInput) {
          emailInput.value = emailPrefill;
        }
        if (document.activeElement !== nameInput) {
          nameInput.value =
            (donor && donor.name) || (prospect && prospect.name) || '';
        }

        if (accountEmailInput && document.activeElement !== accountEmailInput) {
          accountEmailInput.value =
            (donor && donor.email) || (prospect && prospect.email) || '';
        }
        if (accountNameInput && document.activeElement !== accountNameInput) {
          accountNameInput.value =
            (donor && donor.name) || (prospect && prospect.name) || '';
        }
        if (
          accountSubscriptionInput &&
          document.activeElement !== accountSubscriptionInput
        ) {
          if (donor && donor.subscriptionId) {
            accountSubscriptionInput.value = donor.subscriptionId;
          } else {
            accountSubscriptionInput.value = '';
          }
        }
        if (accountPasswordInput && !hasSevereIssue) {
          accountPasswordInput.value = '';
        }
        if (accountConfirmInput && !hasSevereIssue) {
          accountConfirmInput.value = '';
        }

        renderInvite(
          invite,
          shareInvite,
          limitReached,
          nextInviteAvailableAt
        );

        if (!plexLinked && !limitReached) {
          inviteDescription.textContent =
            'Link your Plex account to unlock checkout and referral invites.';
        } else if (!isActive && !limitReached) {
          inviteDescription.textContent =
            'Referral invites unlock once your subscription is active.';
        }

        const identifier =
          (donor && (donor.name || donor.email)) ||
          (prospect && (prospect.name || prospect.email)) ||
          '';
        if (identifier) {
          document.title = `Plex Invite â€¢ ${identifier}`;
        }
      }

      async function loadShareData(options = {}) {
        const silent = options && options.silent;
        if (!silent) {
          showLoading();
        }
        try {
          const response = await fetch(`/api/share/${encodeURIComponent(state.token)}`);
          const payload = await response.json();
          if (!response.ok) {
            throw new Error(payload.error || 'Unable to load share link');
          }
          render(payload);
        } catch (err) {
          showError(err.message);
        }
      }


      if (accountForm) {
        accountForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!state.token) {
            return;
          }

          const wasProspect = Boolean(
            state.data && !state.data.donor && state.data.prospect
          );

          const email = (accountEmailInput.value || '').trim();
          const name = (accountNameInput.value || '').trim();
          const password = accountPasswordInput.value || '';
          const confirm = accountConfirmInput.value || '';
          const subscriptionId = accountSubscriptionInput
            ? (accountSubscriptionInput.value || '').trim()
            : '';

          if (!email) {
            accountStatus.textContent =
              'Please enter the email you want to use for your login.';
            accountStatus.className = 'status-text error';
            return;
          }

          if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
            accountStatus.textContent = 'That does not look like a valid email address yet.';
            accountStatus.className = 'status-text error';
            return;
          }

          if (!password || password.trim().length < 8) {
            accountStatus.textContent = 'Choose a password with at least 8 characters.';
            accountStatus.className = 'status-text error';
            return;
          }

          if (confirm && password !== confirm) {
            accountStatus.textContent = 'Passwords do not match. Please try again.';
            accountStatus.className = 'status-text error';
            return;
          }

          const headers = { 'Content-Type': 'application/json' };
          if (state.sessionToken) {
            headers['X-Share-Session'] = state.sessionToken;
            headers['Authorization'] = `Bearer ${state.sessionToken}`;
          }

          accountSubmit.disabled = true;
          accountStatus.textContent = 'Saving your accountâ€¦';
          accountStatus.className = 'status-text info';

          try {
            const response = await fetch(
              `/api/share/${encodeURIComponent(state.token)}/account`,
              {
                method: 'POST',
                headers,
            body: JSON.stringify({
              email,
              name,
              password,
              confirmPassword: confirm,
              sessionToken: state.sessionToken,
              subscriptionId,
            }),
          }
        );
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(payload.error || 'Failed to save account');
        }
        render(payload);
        if (wasProspect && payload && payload.donor) {
          accountStatus.textContent =
            'Account saved! Open the verification email we just sent and sign in from that link to continue.';
        } else {
          accountStatus.textContent =
            'Account saved! Finish by signing in through the verification email we just sent.';
        }
        accountStatus.className = 'status-text success';
          } catch (err) {
            accountStatus.textContent = err.message;
            accountStatus.className = 'status-text error';
          } finally {
            accountSubmit.disabled = false;
            accountPasswordInput.value = '';
            accountConfirmInput.value = '';
          }
        });
      }

      inviteForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (
          !state.token ||
          generateButton.dataset.blocked === 'true' ||
          state.inviteLimitReached
        ) {
          return;
        }
        const email = (emailInput.value || '').trim();
        const name = (nameInput.value || '').trim();
        if (!email) {
          actionStatus.textContent = 'Please enter the email that should receive this referral invite.';
          actionStatus.classList.add('error');
          return;
        }

        const headers = { 'Content-Type': 'application/json' };
        if (state.sessionToken) {
          headers['X-Share-Session'] = state.sessionToken;
          headers['Authorization'] = `Bearer ${state.sessionToken}`;
        }

        generateButton.disabled = true;
        actionStatus.textContent = 'Sending referral inviteâ€¦';
        actionStatus.className = 'status-text info';

        let responseData = null;
        try {
          const response = await fetch(`/api/share/${encodeURIComponent(state.token)}`, {
            method: 'POST',
            headers,
            body: JSON.stringify({
              email,
              name,
              sessionToken: state.sessionToken,
            }),
          });
          const payload = await response.json();
          responseData = payload;
          if (!response.ok) {
            if (payload && payload.payload) {
              render(payload.payload);
            }
            throw new Error(payload.error || 'Failed to create referral invite');
          }
          render(payload);
          actionStatus.textContent =
            'Referral invite created! Share the link below with your recipient or follow it yourself if youâ€™re restoring access.';
          actionStatus.className = 'status-text success';
        } catch (err) {
          actionStatus.textContent = err.message;
          actionStatus.className = 'status-text error';
        } finally {
          const limitHit = Boolean(
            (responseData && responseData.inviteLimitReached) ||
              state.inviteLimitReached
          );
          if (!limitHit && generateButton.dataset.blocked !== 'true') {
            generateButton.disabled = false;
          }
        }
      });

      registerServiceWorker();
      if (!state.token) {
        showError('Invite link token missing. Double-check the link you used.');
      } else {
        loadShareData();
      }
    </script>
  </body>
</html>
